<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CHI TIáº¾T QUY TRÃŒNH Xá»¬ LÃ</title>
  <style>
    :root {
      --bg: #ffffff;
      --nav: #f4ebdd;
      --text: #222;
      --card: #ffffff;
      --muted: #555;
      --accent: #a87d48;
      --accent-2: #d27d2d;
      --radius: 12px;
      --shadow: 0 4px 18px rgba(0, 0, 0, .08);
    }

    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .navbar {
      background: linear-gradient(180deg, var(--nav) 0%, #ffffff 100%);
      color: var(--text);
      height: 80px;
      padding: 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
    }

    .logo img {
      height: 80px;
      object-fit: contain;
    }

    .dept {
      font-size: 14px;
      font-weight: 500;
    }

    .container {
      max-width: 1600px;
      margin: 30px auto;
      padding: 0 20px;
    }

    h1 {
      margin: 20px 0;
      font-size: 22px;
    }

    select {
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: var(--card);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow: hidden;
      margin-top: 20px;
      table-layout: fixed;
    }

    /* ================== Báº£ng quy trÃ¬nh 12 cá»™t ================== */
    #processTable th,
    #processTable td {
      border: 1px solid #eee;
      padding: 8px;
      font-size: 14px;
      vertical-align: top;
      word-wrap: break-word;
      text-align: left;
    }

    #processTable th {
      background: #f9f6f0;
      color: var(--text);
      font-weight: 600;
    }

    /* Cá»™t 1: Ná»™i dung thá»±c hiá»‡n */
    #processTable th:nth-child(1),
    #processTable td:nth-child(1) {
      width: 16%;
    }

    /* Cá»™t 2: NgÆ°á»i thá»±c hiá»‡n/PhÃª duyá»‡t */
    #processTable th:nth-child(2),
    #processTable td:nth-child(2) {
      width: 10%;
    }

    /* Cá»™t 3: NgÃ y gá»­i */
    #processTable th:nth-child(3),
    #processTable td:nth-child(3) {
      width: 10%;
    }

    /* Cá»™t 4: NgÆ°á»i gá»­i */
    #processTable th:nth-child(4),
    #processTable td:nth-child(4) {
      width: 10%;
    }

    /* Cá»™t 5: NgÆ°á»i nháº­n */
    #processTable th:nth-child(5),
    #processTable td:nth-child(5) {
      width: 10%;
    }

    /* Cá»™t 6: ÄÆ¡n vá»‹ nháº­n */
    #processTable th:nth-child(6),
    #processTable td:nth-child(6) {
      width: 10%;
    }

    /* Cá»™t 7: Thá»i gian xá»­ lÃ½ */
    #processTable th:nth-child(7),
    #processTable td:nth-child(7) {
      width: 7%;
      text-align: center;
    }

    /* Cá»™t 8: Thá»i gian chá» */
    #processTable th:nth-child(8),
    #processTable td:nth-child(8) {
      width: 7%;
      text-align: center;
    }

    /* Cá»™t 9: VÄƒn báº£n dá»± tháº£o */
    #processTable th:nth-child(9),
    #processTable td:nth-child(9) {
      width: 8%;
    }

    /* Cá»™t 10: Káº¿t quáº£ */
    #processTable th:nth-child(10),
    #processTable td:nth-child(10) {
      width: 12%;
    }

    /* Cá»™t 11: NgÃ y hoÃ n thÃ nh */
    #processTable th:nth-child(11),
    #processTable td:nth-child(11) {
      width: 12%;
    }

    /* Cá»™t 12: Quyáº¿t Ä‘á»‹nh */
    #processTable th:nth-child(12),
    #processTable td:nth-child(12) {
      width: 8%;
      text-align: center;
    }

    textarea.result-input {
      width: 100%;
      min-height: 80px;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 6px;
      resize: vertical;
      font-family: "Segoe UI", sans-serif;
      font-size: 14px;
    }

    .btn {
      margin-top: 6px;
      padding: 6px 12px;
      border: 0;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      color: #fff;
    }

    .btn-next {
      background: var(--accent);
    }

    .btn-edit {
      background: var(--accent-2);
    }

    .btn:hover {
      opacity: 0.9;
    }

    tr.hidden {
      display: none;
    }

    /* HÃ ng tiÃªu Ä‘á» bÆ°á»›c */
    .step-title td {
      background: #f2eee7;
      font-weight: 700;
      text-align: center !important;
      /* Ã©p cÄƒn giá»¯a */
      font-size: 15px;
      padding: 10px;
      color: #222;
    }

    .hidden {
      display: none !important;
    }

    .actions {
      margin: 20px 0;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .actions button {
      background: #2196f3;
      color: #fff;
      border: 0;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
    }

    .actions button:hover {
      opacity: 0.9;
    }

    #summaryTable {
      margin-top: 20px;
      border-collapse: collapse;
      width: 100%;
      background: #fafafa;
    }

    #summaryTable th,
    #summaryTable td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    #summaryTable th {
      background: #eee;
    }

    input[type="datetime-local"] {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: "Segoe UI", sans-serif;
      font-size: 14px;
      background: #fff;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    input[type="datetime-local"]:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 3px var(--accent);
    }

    .time-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .time-input {
      position: absolute;
      width: 1px;
      height: 1px;
      opacity: 0;
      pointer-events: none;
      /* áº©n khá»i user click trá»±c tiáº¿p */
    }

    .time-icon {
      cursor: pointer;
      font-size: 18px;
      color: goldenrod;
      /* vÃ ng */
      margin-top: 4px;
      display: inline-block;
    }

    .time-icon:hover {
      opacity: 0.8;
    }

    #processTable td span {
      display: block;
      font-size: 13px;
      color: #555;
      margin-top: 2px;
    }

    .actions {
      margin: 20px 0;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .actions button,
    .actions label.icon-btn {
      background: #2196f3;
      color: #fff;
      border: 0;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      /* icon to rÃµ */
      line-height: 1;
      text-align: center;
    }

    .actions button:hover,
    .actions label.icon-btn:hover {
      opacity: 0.85;
    }

    /* ================== EDOC BLOCK ================== */
    .edoc-block {
      margin-top: 20px;
      border: 1px solid #eee;
      background: #fff;
      font-family: "Segoe UI", sans-serif;
      font-size: 14px;
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .edoc-block .edoc-title {
      padding: 10px 14px;
      border-bottom: 1px solid #eee;
      background: #f9f6f0;
      /* Ä‘á»“ng bá»™ vá»›i processTable header */
      font-weight: 600;
      font-size: 15px;
      color: #222;
    }

    .edoc-block table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }

    .edoc-block th,
    .edoc-block td {
      border: 1px solid #eee;
      padding: 8px 10px;
      vertical-align: middle;
      font-size: 14px;
      text-align: left;
    }

    .edoc-block th {
      background: #f9f6f0;
      /* giá»‘ng header processTable */
      font-weight: 600;
      color: #222;
    }

    .edoc-block tbody tr:nth-of-type(odd) {
      background: #fcfcfc;
    }

    .edoc-block tbody tr:hover {
      background: #f5f5f5;
    }

    .edoc-label {
      display: inline-block;
      padding: 3px 8px;
      font-size: 12px;
      border-radius: 4px;
      color: #fff;
      font-weight: 500;
      text-align: center;
    }

    /* Tráº¡ng thÃ¡i */
    .edoc-label.warning {
      background-color: #f0ad4e;
    }

    .edoc-label.danger {
      background-color: #d9534f;
    }

    .edoc-label.success {
      background-color: #5cb85c;
    }

    /* CÄƒn giá»¯a cá»™t Tráº¡ng thÃ¡i */
    .edoc-block td:nth-child(7) {
      text-align: center;
    }

    .edoc-block th:nth-child(6),
    .edoc-block td:nth-child(6) {
      display: center;
    }

    /* ========= TONE & COLORS ========= */
    :root {
      --line-strong: #D0D5DD;
      /* viá»n báº£ng */
      --line-strong-2: #98A2B3;
      /* hover/outline */
      --fill-strong-1: #F2F4F7;
      /* header th */
      --row-zebra: #FAFAFB;
      /* hÃ ng cháºµn */
      --ink-strong: #101828;
      /* chá»¯ Ä‘áº­m */
    }

    /* ========= CARD / SECTION ========= */
    .card {
      background: #fff;
      border: 1px solid var(--line-strong);
      border-radius: 12px;
      box-shadow: 0 4px 14px rgba(16, 24, 40, .06);
    }

    /* ========= TABLE ========= */
    .table {
      width: 100%;
      border-collapse: separate;
      /* Ä‘á»ƒ bo gÃ³c Ä‘áº¹p */
      border-spacing: 0;
      border: 1.25px solid var(--line-strong);
      border-radius: 10px;
      overflow: hidden;
      /* bo gÃ³c cho header */
      font-size: 14.5px;
      color: var(--ink-strong);
    }

    .table th,
    .table td {
      padding: 10px 12px;
      border-right: 1.25px solid var(--line-strong);
      border-bottom: 1.25px solid var(--line-strong);
      vertical-align: top;
    }

    .table th {
      background: var(--fill-strong-1);
      font-weight: 600;
    }

    .table tr:nth-child(even) td {
      background: var(--row-zebra);
    }

    /* bá» viá»n pháº£i Ã´ cuá»‘i & viá»n dÆ°á»›i hÃ ng cuá»‘i */
    .table tr>*:last-child {
      border-right: none;
    }

    .table tr:last-child>* {
      border-bottom: none;
    }

    /* hover hÃ ng (tÃ¹y thÃ­ch) */
    .table tbody tr:hover td {
      background: #EEF2F6;
    }

    /* ========= BADGE / STATUS ========= */
    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12.5px;
      font-weight: 600;
      border: 1px solid transparent;
    }

    .badge--info {
      background: #E0EAFF;
      color: #1E40AF;
      border-color: #BFD5FF;
    }

    .badge--warn {
      background: #FEF0C7;
      color: #92400E;
      border-color: #FDE68A;
    }

    .badge--success {
      background: #D1FADF;
      color: #05603A;
      border-color: #A6F4C5;
    }

    .badge--danger {
      background: #FEE4E2;
      color: #912018;
      border-color: #FECDCA;
    }

    /* ========= LABEL (cá»™t tiÃªu Ä‘á» bÃªn trÃ¡i) ========= */
    .kv-label {
      font-weight: 600;
      color: #0F172A;
    }

    /* ========= BUTTON SAVE (nhÃ¬n sáº¯c nÃ©t hÆ¡n) ========= */
    .btn-primary {
      background: #1D4ED8;
      color: #fff;
      border: 1px solid #1E40AF;
      padding: 8px 14px;
      border-radius: 10px;
      box-shadow: 0 2px 8px rgba(29, 78, 216, .25);
    }

    .btn-primary:hover {
      background: #1B46C2;
    }

    .select-donvi {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #d0d5dd;
      border-radius: 8px;
      font-size: 14px;
      background-color: #fff;
      color: #111827;
      outline: none;
    }

    .select-donvi:focus {
      border-color: #2563eb;
      box-shadow: 0 0 0 2px rgba(37, 99, 235, 0.25);
    }
    .select-nguoinhan, .select-donvinhan {
  width: 48%;
  min-width: 140px;
}
select:disabled {
  background-color: #f3f3f3;
  color: #555;
  opacity: 0.85;
  cursor: not-allowed;
}
  </style>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
  <div class="navbar">
    <div class="logo"><img src="photo/logo-nhnnvn-3-1129x800.webp" alt="Logo"></div>
    <div class="dept" id="deptName">PhÃ²ng: CÃN Bá»˜ Äá»ŠA PHÆ¯Æ NG</div>
    <div class="dept" id="refDisplay"></div>
  </div>

  <div class="container">
    <h1>PhÃª duyá»‡t/cÃ³ Ã½ kiáº¿n vá» Káº¿ hoáº¡ch tuyá»ƒn dá»¥ng cÃ´ng chá»©c loáº¡i D táº¡i cÃ¡c NHNN chi nhÃ¡nh Khu vá»±c</h1>

    <!-- Dropdown chá»n trang -->
    <div id="processSelectWrapper" class="hidden">
      <label for="processSelect"><b>Chá»n quy trÃ¬nh:</b></label>
      <select id="processSelect">
        <option value="test.html" selected>Káº¿ hoáº¡ch tuyá»ƒn dá»¥ng cÃ´ng chá»©c loáº¡i D táº¡i cÃ¡c NHNN chi nhÃ¡nh Khu vá»±c</option>
        <option value="test1.html">Cá»­ cÃ¡n bá»™ Ä‘i cÃ´ng tÃ¡c nÆ°á»›c ngoÃ i</option>
        <option value="test2.html">Tá»• chá»©c Ä‘Ã³n nháº­n cÃ¡c danh hiá»‡u thi Ä‘ua, hÃ¬nh thá»©c khen thÆ°á»Ÿng cáº¥p NhÃ  NÆ°á»›c, cáº¥p NgÃ nh
        </option>
        <option value="test3.html">Triá»ƒn khai quy hoáº¡ch LÃ£nh Äáº¡o cáº¥p PhÃ²ng táº¡i NHTW</option>
        <option value="test4.html">Quy TrÃ¬nh PhÃª Duyá»‡t Äá»‘i Vá»›i NÃ¢ng LÆ°Æ¡ng ThÆ°á»ng XuyÃªn, Phá»¥ Cáº¥p ThÃ¢m NiÃªn VÆ°á»£t Khung
          Thuá»™c Tháº©m Quyá»n Vá»¥ TCCB Duyá»‡t KÃ½</option>
        <option value="test5.html">Quy trÃ¬nh xÃ¢y dá»±ng bÃ¡o cÃ¡o Ä‘á»‹nh ká»³/Ä‘á»™t xuáº¥t/tham gia Ã½ kiáº¿n/tráº£ lá»i kiáº¿n nghá»‹ gá»­i cÃ¡c
          Ä‘Æ¡n vá»‹ thuá»™c NHNN do lÃ£nh Ä‘áº¡o Vá»¥ TCCB duyá»‡t kÃ½</option>
      </select>
    </div>

    <!-- Export / Import CSV -->
    <div class="actions">
      <button onclick="exportRawJson()" style="display: none;">ğŸ“¥ Export Local File</button>
      <button onclick="sendToSharePoint()">â˜ï¸ Save Dá»¯ Liá»‡u</button>
      <button onclick="importFromCloud()" style="display: none;">â˜ï¸ Import Cloud</button>
      <button onclick="exportExcelSharePointFormat()" style="display: none;">â¬‡ï¸ Export Excel</button>
      <!-- Import Token Key -->
      <label for="importToken" title="Import Token Key" class="icon-btn" style="display: none;">ğŸ”‘ Import Token Key
        File</label>
      <input type="file" id="importToken" accept=".csv,.txt" onchange="importToken(event)" hidden>

      <!-- Import Encoded TXT -->
      <label for="importEncoded" title="Import Encoded TXT" class="icon-btn" style="display: none;">ğŸ“‚ Import Data Local
        File</label>
      <input type="file" id="importEncoded" accept=".txt" onchange="importEncoded(event)" hidden>
    </div>
    <div id="chitiet-container"></div>
    <div id="ykien-container"></div>
    <div id="luanchuyen-container"></div>
    <div id="detailWrapper"></div>
    <div class="edoc-block" style="margin-top: 30px;">
      <div class="edoc-title">CHI TIáº¾T Káº¾ HOáº CH Cá»¦A CÃN Bá»˜ Äáº¦U Má»I</div>
      <div id="processTable">
        <table class="process-table-inner">
          <thead>
            <tr>
              <th>Ná»™i dung thá»±c hiá»‡n</th>
              <th>NgÆ°á»i thá»±c hiá»‡n/PhÃª duyá»‡t</th>
              <th>NgÃ y gá»­i</th>
              <th>NgÆ°á»i nháº­n</th>
              <th>ÄÆ¡n vá»‹ nháº­n</th>
              <th>Thá»i gian xá»­ lÃ½</th>
              <th>Thá»i gian chá»</th>
              <th>Káº¿t quáº£</th>
              <th>NgÃ y hoÃ n thÃ nh</th>
              <th>Quyáº¿t Ä‘á»‹nh</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="summary"></div>

  </div>

  <script>
function getDropdownHTML(selectedValue = "") {
  // ğŸ§  Náº¿u dá»¯ liá»‡u vá» lÃ  object cÃ³ key khÃ¡c nhau thÃ¬ fallback
  if (selectedValue && typeof selectedValue === "object") {
    selectedValue = selectedValue.donvinhan || selectedValue.donviNhan || "";
  }

  let html = `<select class="select-donvinhan">
                <option value="">-- Chá»n Ä‘Æ¡n vá»‹ nháº­n --</option>`;

  donViNhanData.forEach(group => {
    html += `<optgroup label="${group.group}">`;

    group.items.forEach(item => {
      const sel =
        item.trim().toLowerCase() === (selectedValue || "").trim().toLowerCase()
          ? "selected"
          : "";
      html += `<option value="${item}" ${sel}>${item}</option>`;
    });

    html += `</optgroup>`;
  });

  html += `</select>`;
  return html;
}

function getDropdownHTML1(selectedValue = "") {
  // ğŸ§  Náº¿u dá»¯ liá»‡u vá» lÃ  object cÃ³ key khÃ¡c nhau thÃ¬ fallback
  if (selectedValue && typeof selectedValue === "object") {
    selectedValue = selectedValue.nguoinhan || selectedValue.nguoiNhan || "";
  }

  let html = `<select class="select-nguoinhan">
                <option value="">-- Chá»n ngÆ°á»i nháº­n --</option>`;

  chonNhansu.forEach(group => {
    html += `<optgroup label="${group.group}">`;

    group.items.forEach(item => {
      const sel =
        item.trim().toLowerCase() === (selectedValue || "").trim().toLowerCase()
          ? "selected"
          : "";
      html += `<option value="${item}" ${sel}>${item}</option>`;
    });

    html += `</optgroup>`;
  });

  html += `</select>`;
  return html;
}
    const donViNhanData = [
      {
        group: "NgÃ¢n hÃ ng NhÃ  nÆ°á»›c Trung Æ°Æ¡ng",
        items: [
          "Vá»¥ ChÃ­nh sÃ¡ch tiá»n tá»‡",
          "Vá»¥ Thanh toÃ¡n",
          "Vá»¥ TÃ­n dá»¥ng cÃ¡c ngÃ nh kinh táº¿",
          "Vá»¥ Dá»± bÃ¡o, thá»‘ng kÃª â€“ á»”n Ä‘á»‹nh tiá»n tá»‡, tÃ i chÃ­nh",
          "Vá»¥ Há»£p tÃ¡c quá»‘c táº¿",
          "Vá»¥ PhÃ¡p cháº¿",
          "Vá»¥ TÃ i chÃ­nh â€“ Káº¿ toÃ¡n",
          "Vá»¥ Tá»• chá»©c cÃ¡n bá»™",
          "VÄƒn phÃ²ng",
          "Thanh tra NgÃ¢n hÃ ng NhÃ  nÆ°á»›c",
          "Sá»Ÿ Giao dá»‹ch",
          "Cá»¥c CÃ´ng nghá»‡ thÃ´ng tin",
          "Cá»¥c PhÃ¡t hÃ nh vÃ  Kho quá»¹",
          "Cá»¥c Quáº£n lÃ½ ngoáº¡i há»‘i",
          "Cá»¥c PhÃ²ng, chá»‘ng rá»­a tiá»n",
          "Cá»¥c Quáº£n lÃ½, giÃ¡m sÃ¡t tá»• chá»©c tÃ­n dá»¥ng",
          "Cá»¥c An toÃ n há»‡ thá»‘ng cÃ¡c tá»• chá»©c tÃ­n dá»¥ng",
          "NgÃ¢n hÃ ng NhÃ  nÆ°á»›c chi nhÃ¡nh táº¡i cÃ¡c khu vá»±c",
          "Trung tÃ¢m ThÃ´ng tin tÃ­n dá»¥ng Quá»‘c gia Viá»‡t Nam",
          "Thá»i bÃ¡o NgÃ¢n hÃ ng"
        ]
      },
      {
        group: "Bá»™, CÆ¡ quan ngang Bá»™ Trung Æ°Æ¡ng",
        items: [
          "Bá»™ Quá»‘c phÃ²ng",
          "Bá»™ CÃ´ng an",
          "Bá»™ Ngoáº¡i giao",
          "Bá»™ Ná»™i vá»¥",
          "Bá»™ TÆ° phÃ¡p",
          "Bá»™ Káº¿ hoáº¡ch vÃ  Äáº§u tÆ°",
          "Bá»™ TÃ i chÃ­nh",
          "Bá»™ CÃ´ng ThÆ°Æ¡ng",
          "Bá»™ NÃ´ng nghiá»‡p vÃ  PhÃ¡t triá»ƒn nÃ´ng thÃ´n",
          "Bá»™ Giao thÃ´ng váº­n táº£i",
          "Bá»™ XÃ¢y dá»±ng",
          "Bá»™ TÃ i nguyÃªn vÃ  MÃ´i trÆ°á»ng",
          "Bá»™ ThÃ´ng tin vÃ  Truyá»n thÃ´ng",
          "Bá»™ Lao Ä‘á»™ng - ThÆ°Æ¡ng binh vÃ  XÃ£ há»™i",
          "Bá»™ VÄƒn hÃ³a, Thá»ƒ thao vÃ  Du lá»‹ch",
          "Bá»™ Khoa há»c vÃ  CÃ´ng nghá»‡",
          "Bá»™ GiÃ¡o dá»¥c vÃ  ÄÃ o táº¡o",
          "Bá»™ Y táº¿",
          "á»¦y ban DÃ¢n tá»™c",
          "NgÃ¢n hÃ ng NhÃ  nÆ°á»›c Viá»‡t Nam",
          "Thanh tra ChÃ­nh phá»§",
          "VÄƒn phÃ²ng ChÃ­nh phá»§"
        ]
      },
      {
        group: "NgÃ¢n hÃ ng NhÃ  nÆ°á»›c khu vá»±c",
        items: Array.from({ length: 15 }, (_, i) => `NgÃ¢n hÃ ng NhÃ  nÆ°á»›c khu vá»±c ${i + 1}`)
      },
      {
        group: "PhÃ²ng ban thuá»™c Vá»¥ TCNS",
        items: [
          "PhÃ²ng cÃ¡n bá»™ trung Æ°Æ¡ng",
          "PhÃ²ng cÃ¡n bá»™ Ä‘á»‹a phÆ°Æ¡ng",
          "PhÃ²ng tá»• chá»©c - tiá»n lÆ°Æ¡ng",
          "PhÃ²ng Thi Ä‘ua, khen thÆ°á»Ÿng",
          "PhÃ²ng ÄÃ o táº¡o vÃ  phÃ¡t triá»ƒn nguá»“n nhÃ¢n lá»±c"
        ]
      }
    ];
    const chonNhansu =
      [{
          "group": "Ban LÃ£nh Ä‘áº¡o NHNN",
          "items": [
            "Nguyá»…n Thá»‹ Há»“ng - Thá»‘ng Ä‘á»‘c",
            "ÄoÃ n ThÃ¡i SÆ¡n - PhÃ³ Thá»‘ng Ä‘á»‘c",
            "Pháº¡m Thanh HÃ  - PhÃ³ Thá»‘ng Ä‘á»‘c",
            "Pháº¡m Quang DÅ©ng - PhÃ³ Thá»‘ng Ä‘á»‘c",
            "Pháº¡m Tiáº¿n DÅ©ng - PhÃ³ Thá»‘ng Ä‘á»‘c",
            "Nguyá»…n Ngá»c Cáº£nh - PhÃ³ Thá»‘ng Ä‘á»‘c"
          ]
        },{
          "group": "Ban LÃ£nh Ä‘áº¡o Vá»¥",
          "items": [
            "Tráº§n Thu Huyá»n - LÃ£nh Ä‘áº¡o Vá»¥",
            "Nguyá»…n Anh Tuáº¥n - LÃ£nh Ä‘áº¡o Vá»¥",
            "LÃª Viá»‡t HÃ¹ng - LÃ£nh Ä‘áº¡o Vá»¥"
          ]
        },
        {
          "group": "PhÃ²ng Tá»• chá»©c - Tiá»n lÆ°Æ¡ng",
          "items": [
            "LÃª Anh Háº£o - TrÆ°á»Ÿng phÃ²ng",
            "Nguyá»…n Thá»‹ BÃ­ch Tháº£o - PhÃ³ TrÆ°á»Ÿng phÃ²ng",
            "Sáº§m Thá»‹ Kim PhÆ°Æ¡ng - PhÃ³ TrÆ°á»Ÿng phÃ²ng",
            "TrÆ°Æ¡ng HoÃ ng Nam - PhÃ³ TrÆ°á»Ÿng phÃ²ng",
            "TrÆ°Æ¡ng Há»“ng Quang - ChuyÃªn viÃªn",
            "Trá»‹nh Thá»‹ PhÆ°Æ¡ng - ChuyÃªn viÃªn",
            "Nguyá»…n Thu Thá»§y - ChuyÃªn viÃªn chÃ­nh",
            "Nguyá»…n Minh Anh - ChuyÃªn viÃªn",
            "Tráº§n Thá»‹ Háº£i Yáº¿n - ChuyÃªn viÃªn",
            "Nguyá»…n Quá»³nh Anh - ChuyÃªn viÃªn",
            "Pháº¡m Thu HoÃ i - ChuyÃªn viÃªn",
            "ThÃ¢n HoÃ ng Duy - ChuyÃªn viÃªn",
            "HoÃ ng Quá»³nh LiÃªn - ChuyÃªn viÃªn",
            "LÃª Thá»‹ Kim Oanh - VÄƒn thÆ°"
          ]
        },
        {
          "group": "PhÃ²ng CÃ¡n bá»™ Trung Æ°Æ¡ng",
          "items": [
            "LÃª Anh Minh - TrÆ°á»Ÿng phÃ²ng",
            "Nguyá»…n ThÃ nh KiÃªn - PhÃ³ TrÆ°á»Ÿng phÃ²ng",
            "Nguyá»…n Thá»‹ CÃºc - PhÃ³ TrÆ°á»Ÿng phÃ²ng",
            "Khá»•ng Äá»©c ChÃ­nh - ChuyÃªn viÃªn",
            "Nguyá»…n Thá»‹ Minh - ChuyÃªn viÃªn",
            "TÄƒng ThÃ¹y Anh - ChuyÃªn viÃªn",
            "Nguyá»…n Hiá»n Trang - ChuyÃªn viÃªn",
            "Nguyá»…n Thá»‹ Há»“ng Thá»‹nh - ChuyÃªn viÃªn chÃ­nh",
            "LÃª Kiá»u Nga - ChuyÃªn viÃªn",
            "VÅ© HoÃ ng Yáº¿n - ChuyÃªn viÃªn",
            "Nguyá»…n VÄƒn Huáº¥n - ChuyÃªn viÃªn",
            "Tráº§n Thá»‹ ThÃ¹y Ly - ChuyÃªn viÃªn",
            "TrÆ°Æ¡ng Há»“ng Quang - ChuyÃªn viÃªn"
          ]
        },
        {
          "group": "PhÃ²ng ÄÃ o táº¡o vÃ  PhÃ¡t triá»ƒn nguá»“n nhÃ¢n lá»±c",
          "items": [
            "HÃ  TÃº Anh - TrÆ°á»Ÿng phÃ²ng",
            "DÆ°Æ¡ng Háº£i Chi - PhÃ³ TrÆ°á»Ÿng phÃ²ng",
            "VÅ© Thanh Thá»§y - PhÃ³ TrÆ°á»Ÿng phÃ²ng",
            "LÃª Thu Háº±ng - PhÃ³ TrÆ°á»Ÿng phÃ²ng",
            "Tráº§n Thá»‹ Thanh HÃ²a - PhÃ³ TrÆ°á»Ÿng phÃ²ng",
            "Nguyá»…n Tiáº¿n PhÃ¡p - ChuyÃªn viÃªn",
            "Äá»— Háº¡nh Trang - ChuyÃªn viÃªn",
            "Pháº¡m Thu HÆ°Æ¡ng - ChuyÃªn viÃªn",
            "Giang Thá»‹ Kim Thanh - ChuyÃªn viÃªn chÃ­nh",
            "Nguyá»…n Thá»‹ Thu Thoa - ChuyÃªn viÃªn",
            "LÆ°Æ¡ng Thanh HÃ  - ChuyÃªn viÃªn",
            "NgÃ´ Thá»‹ Minh Thu - ChuyÃªn viÃªn chÃ­nh",
            "Pháº¡m Thanh HÃ  - ChuyÃªn viÃªn chÃ­nh",
            "Pháº¡m HÃ  PhÆ°Æ¡ng - ChuyÃªn viÃªn chÃ­nh",
            "BÃ¹i XuÃ¢n Kháº£i - ChuyÃªn viÃªn",
            "TrÆ°Æ¡ng Há»“ng Quang - ChuyÃªn viÃªn"
          ]
        },
        {
          "group": "PhÃ²ng Thi Ä‘ua - Khen thÆ°á»Ÿng",
          "items": [
            "Nguyá»…n Thá»‹ BÃ­ch Huá»‡ - TrÆ°á»Ÿng phÃ²ng",
            "Triá»‡u Thá»‹ Báº£o Hoa - PhÃ³ TrÆ°á»Ÿng phÃ²ng",
            "Äinh XuÃ¢n PhÃº - PhÃ³ TrÆ°á»Ÿng phÃ²ng",
            "Nguyá»…n Thanh SÆ¡n - PhÃ³ TrÆ°á»Ÿng phÃ²ng",
            "LÃª Minh HÃ  - ChuyÃªn viÃªn",
            "Nguyá»…n Thá»‹ NhÆ° Hoa - ChuyÃªn viÃªn chÃ­nh",
            "Nguyá»…n Thá»‹ Ãnh Tuyáº¿t - ChuyÃªn viÃªn",
            "Táº¡ Thanh Huyá»n - ChuyÃªn viÃªn chÃ­nh",
            "VÅ© Thá»‹ Háº¡nh - ChuyÃªn viÃªn",
            "Nguyá»…n Thá»‹ Lan PhÆ°Æ¡ng - ChuyÃªn viÃªn",
            "Pháº¡m Minh HÃ  - ChuyÃªn viÃªn",
            "Äáº·ng Thá»‹ DuyÃªn - ChuyÃªn viÃªn",
            "Äá»— Thá»‹ HÆ°Æ¡ng Lan - ChuyÃªn viÃªn chÃ­nh",
            "LÃª XuÃ¢n Máº¡nh - ChuyÃªn viÃªn",
            "LÃª Thá»‹ Ngá»c HÃ  - ChuyÃªn viÃªn chÃ­nh",
            "TrÆ°Æ¡ng Há»“ng Quang - ChuyÃªn viÃªn"
          ]
        },
        {
          "group": "PhÃ²ng CÃ¡n bá»™ Ä‘á»‹a phÆ°Æ¡ng",
          "items": [
            "Äá»— Trá»ng ToÃ n - TrÆ°á»Ÿng phÃ²ng",
            "Nguyá»…n Máº¡nh Kháº£i - PhÃ³ TrÆ°á»Ÿng phÃ²ng",
            "VÅ© Tuáº¥n Linh - ChuyÃªn viÃªn",
            "BÃ¹i Minh Háº£i - ChuyÃªn viÃªn chÃ­nh",
            "Nguyá»…n HoÃ i Nam - ChuyÃªn viÃªn chÃ­nh",
            "Pháº¡m VÄƒn HÆ°ng - ChuyÃªn viÃªn chÃ­nh",
            "BÃ¹i Lá»‡ Háº±ng - ChuyÃªn viÃªn",
            "Pháº¡m Thanh HuyÃªn - ChuyÃªn viÃªn",
            "Tráº§n Thá»‹ HÃ  ChÃ¢u - ChuyÃªn viÃªn",
            "TrÆ°Æ¡ng Há»“ng Quang - ChuyÃªn viÃªn"
          ]
        }
      ]
    let edocData = [];
    try {
      const stored = sessionStorage.getItem("edocData");
      if (stored) {
        edocData = JSON.parse(stored);
        console.log("âœ… Nháº­n tá»« homepage:", edocData);
      } else {
        console.warn("âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u edocData trong sessionStorage");
      }
    } catch (e) {
      console.error("âŒ Lá»—i parse edocData:", e);
    };
    // ğŸ”§ Endpoint Power Automate Flow (láº¥y tá»« SharePoint)
    const FLOW_URL =
      "https://default460cecfbf0c64dd7a5ec66ef4d75ae.63.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/e92a5c03c0524754a5957ec23d945b77/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ytc79DxIlkb3uRhF93uLhGp8DuWxVMETGyFkZDtfQ-Y";

    // âœ… Láº¥y danh sÃ¡ch quy trÃ¬nh tá»« Flow SharePoint vÃ  fill vÃ o dropdown
    // âœ… Láº¥y danh sÃ¡ch quy trÃ¬nh tá»« Flow SharePoint vÃ  fill vÃ o dropdown
    // âœ… Láº¥y danh sÃ¡ch quy trÃ¬nh tá»« Flow SharePoint vÃ  fill vÃ o dropdown
    async function loadProcessList() {
      const container = document.getElementById("chitiet-container");
      if (container) container.innerHTML = "<p>â³ Äang táº£i danh sÃ¡ch quy trÃ¬nh...</p>";

      try {
        console.log("ğŸ”„ [loadProcessList] Gá»i Flow Ä‘á»ƒ láº¥y danh sÃ¡ch quy trÃ¬nh...");
        const res = await fetch(FLOW_URL, { method: "POST" });
        if (!res.ok) throw new Error(`Lá»—i táº£i danh má»¥c (${res.status})`);

        const text = await res.text();
        let data;
        try {
          data = JSON.parse(text);
        } catch {
          data = JSON.parse(JSON.parse(text)); // fallback náº¿u JSON lá»“ng
        }

        const list = Array.isArray(data) ? data : [data];

        // ğŸ”¹ Chuáº©n hÃ³a format dá»¯ liá»‡u tá»« SharePoint
        const normalized = list.map(item => ({
          maSo: item["MÃƒ Sá»"] || item["MASO"] || "",
          ten: (item["TÃŠN QUY TRÃŒNH"] || item["TENQUYTRINH"] || item["QUYTRINH_NAME"] || "").trim(),
          QUYTRINH_NAME: (item["QUYTRINH_NAME"] || item["TÃŠN QUY TRÃŒNH"] || item["TENQUYTRINH"] || "").trim(),
          steps: (() => {
            let raw = item["STEP QUY TRÃŒNH"] || item["CAYQUYTRINH"] || "[]";
            try {
              const parsed = JSON.parse(raw);
              return Array.isArray(parsed) ? parsed : JSON.parse(parsed);
            } catch (e) {
              console.warn("âš ï¸ STEP parse lá»—i:", e);
              return [];
            }
          })()
        }));

        // ğŸ”¹ Cache danh sÃ¡ch Ä‘á»ƒ tÃ¡i sá»­ dá»¥ng
        sessionStorage.setItem("processListChiTiet", JSON.stringify(normalized));
        console.log("âœ… ÄÃ£ nháº­n", normalized.length, "quy trÃ¬nh tá»« SharePoint");

        // --- Render dropdown ---
        const select = document.getElementById("processSelectChiTiet");
        const title = document.getElementById("pageTitle");
        if (!select) {
          console.error("âŒ KhÃ´ng tÃ¬m tháº¥y dropdown #processSelectChiTiet");
          if (container) container.innerHTML = "<p>âš ï¸ KhÃ´ng cÃ³ dropdown quy trÃ¬nh Ä‘á»ƒ hiá»ƒn thá»‹.</p>";
          return;
        }

        select.innerHTML = `<option value="">-- Chá»n quy trÃ¬nh --</option>`;
        normalized.forEach(q => {
          const opt = document.createElement("option");
          opt.value = q.maSo;
          opt.textContent = q.QUYTRINH_NAME || q.ten || q.maSo;
          select.appendChild(opt);
        });

        // --- Khi ngÆ°á»i dÃ¹ng chá»n ---
        select.onchange = e => {
          const maSo = e.target.value;
          const found = normalized.find(x => x.maSo === maSo);
          if (!found) return;

          console.log("ğŸŸ¢ [ÄÃ£ chá»n thá»§ cÃ´ng]", found.QUYTRINH_NAME);

          const title = document.getElementById("pageTitle") || document.querySelector("h1");
          if (title) {
            title.textContent = found.QUYTRINH_NAME || found.ten || found.maSo;
            title.style.display = "block";
          }

          // âœ… GÃ¡n data & render full inner UI
          window.processData = found.steps;
          if (typeof renderSteps === "function") {
            renderSteps(window.processData); // âš¡ Gá»i hÃ m gá»‘c cÃ³ icon, textarea, nÃºt
          } else {
            console.warn("âš ï¸ ChÆ°a cÃ³ renderSteps() â€” fallback vá» renderProcessFromJson()");
            renderProcessFromJson();
          }
        };

        if (container) container.innerHTML = ""; // clear loading

        // âœ… Äá»£i dropdown render Ä‘áº§y Ä‘á»§ rá»“i má»›i auto-select
        await new Promise(resolve => {
          let tries = 0;
          const timer = setInterval(() => {
            if (select.options.length > 1 || tries++ > 30) {
              clearInterval(timer);
              resolve();
            }
          }, 100);
        });

        // âœ… Náº¿u cÃ³ record Ä‘ang edit â†’ tá»± Ä‘á»™ng chá»n quy trÃ¬nh Ä‘Ãºng tÃªn hoáº·c mÃ£
        const selectedRow = sessionStorage.getItem("selectedRow");
        if (selectedRow) {
          try {
            const row = JSON.parse(selectedRow);
            if (row.QUYTRINH_NAME || row.MASO) {
              console.log("ğŸ“Œ [Auto-select] TÃ¬m quy trÃ¬nh:", row.QUYTRINH_NAME || row.MASO);

              const found = normalized.find(x =>
                x.maSo.trim().toLowerCase() === (row.MASO || "").trim().toLowerCase() ||
                x.QUYTRINH_NAME.trim().toLowerCase() === (row.QUYTRINH_NAME || "").trim().toLowerCase()
              );

              if (found) {
                // âœ… GÃ¡n selected Ä‘Ãºng
                select.value = found.maSo;
                const opt = [...select.options].find(o => o.value === found.maSo);
                if (opt) opt.setAttribute("selected", "selected");

                // âœ… Cáº­p nháº­t tiÃªu Ä‘á»
                if (title) {
                  title.textContent = found.QUYTRINH_NAME || found.ten || found.maSo;
                  title.style.display = "block";
                }

                console.log("âœ… [Auto-select] Chá»n thÃ nh cÃ´ng:", found.QUYTRINH_NAME);

                // âœ… GÃ¡n dá»¯ liá»‡u & render
                window.processData = found.steps;
                await new Promise(r => setTimeout(r, 100)); // Ä‘á»£i DOM update
                renderProcessFromJson();
              } else {
                console.warn("âš ï¸ [Auto-select] KhÃ´ng tÃ¬m tháº¥y quy trÃ¬nh khá»›p:", row.QUYTRINH_NAME);
              }
            }
          } catch (err) {
            console.warn("âš ï¸ Lá»—i parse selectedRow khi auto-select:", err);
          }
        }

      } catch (err) {
        console.error("âŒ loadProcessList lá»—i:", err);
        if (container)
          container.innerHTML = `<p>âŒ Lá»—i táº£i danh sÃ¡ch: ${err.message}</p>`;
      }
    }

    // âœ… Render step xuá»‘ng báº£ng chi tiáº¿t (processTable)
    // âœ… Icon tráº¡ng thÃ¡i
    function renderStatus(status) {
      if (!status) return "";
      const s = status.toLowerCase();
      if (s.includes("Ä‘Ã£")) return "âœ…";
      if (s.includes("Ä‘ang")) return "â³";
      return "âŒ";
    }

    // ğŸš€ Khá»Ÿi táº¡o khi trang load
    window.addEventListener("DOMContentLoaded", () => {
      console.log("ğŸŒ DOM ready â†’ loadProcessList()");
      loadProcessList();
    });
    // =============== RENDER CHI TIáº¾T ===================
    function renderChiTiet(chitiet) {
  if (!chitiet) return "";

  // ğŸ§© Xá»­ lÃ½ link file SharePoint â€” luÃ´n láº¥y link tháº­t tá»« chitiet data
  let fileLinkHTML = "";
  if (chitiet.fileDinhKem) {
    // TrÆ°á»ng há»£p 1ï¸âƒ£: Máº¢NG nhiá»u file
    if (Array.isArray(chitiet.fileDinhKem)) {
      fileLinkHTML = chitiet.fileDinhKem.map(f => {
        // Æ¯u tiÃªn láº¥y URL gá»‘c tá»« SharePoint (ServerRelativeUrl hoáº·c url)
        const url = f.ServerRelativeUrl
          ? `https://vcb365.sharepoint.com${f.ServerRelativeUrl}`
          : f.url || f.link || f.FileRef || f.FilePath || "";
        const name = f.tenTep || f.FileName || decodeURIComponent(url.split("/").pop());
        const note = f.ghiChu || "";
        const display = note ? `${name} (${note})` : name;
        return url
          ? `<a href="${url}" target="_blank" rel="noopener noreferrer">${display}</a>`
          : display;
      }).join("<br>");
    }

    // TrÆ°á»ng há»£p 2ï¸âƒ£: OBJECT 1 file
    else if (typeof chitiet.fileDinhKem === "object") {
      const f = chitiet.fileDinhKem;
      const url = f.ServerRelativeUrl
        ? `https://vcb365.sharepoint.com${f.ServerRelativeUrl}`
        : f.url || f.link || f.FileRef || f.FilePath || "";
      const name = f.tenTep || f.FileName || decodeURIComponent(url.split("/").pop());
      const note = f.ghiChu || "";
      const display = note ? `${name} (${note})` : name;
      fileLinkHTML = url
        ? `<a href="${url}" target="_blank" rel="noopener noreferrer">${display}</a>`
        : display;
    }

    // TrÆ°á»ng há»£p 3ï¸âƒ£: CHUá»–I â€” cÃ³ thá»ƒ lÃ  link SharePoint hoáº·c tÃªn + ghi chÃº
    else if (typeof chitiet.fileDinhKem === "string") {
      const raw = chitiet.fileDinhKem.trim();

      // ğŸ§  Náº¿u cÃ³ link tháº­t
      if (raw.startsWith("http")) {
        const url = raw.split(" ")[0]; // tÃ¡ch pháº§n URL trÆ°á»›c dáº¥u cÃ¡ch
        const noteMatch = raw.match(/\(([^)]+)\)$/);
        const fileName = decodeURIComponent(url.split("/").pop());
        const note = noteMatch ? noteMatch[1] : "";
        const display = note ? `${fileName} (${note})` : fileName;
        fileLinkHTML = `<a href="${url}" target="_blank" rel="noopener noreferrer">${display}</a>`;
      }
      // ğŸ§  Náº¿u chá»‰ lÃ  "642.pdf (Kiá»ƒm tra chá»¯ kÃ½)"
      else {
        const match = raw.match(/^(.+?)\s*\((.+)\)$/);
        const fileName = match ? match[1].trim() : raw;
        const note = match ? match[2].trim() : "";
        const display = note ? `${fileName} (${note})` : fileName;
        fileLinkHTML = display; // khÃ´ng gáº¯n URL vÃ¬ khÃ´ng cÃ³ Ä‘Æ°á»ng dáº«n tháº­t
      }
    }
  }

  // ğŸ”¹ DÆ°á»›i Ä‘Ã¢y lÃ  pháº§n render báº£ng
  return `
    <div class="edoc-block">
      <div class="edoc-title">QUY TRÃŒNH Xá»¬ LÃ</div>
      <div style="padding:10px;">
        <label for="processSelectChiTiet"><b>Chá»n quy trÃ¬nh:</b></label>
        <select id="processSelectChiTiet" style="margin-left:8px; padding:6px 8px; min-width:400px;"></select>
      </div>
      <div class="edoc-title">CHI TIáº¾T VÄ‚N Báº¢N Äáº¾N</div>
      <div class="edoc-body">
        <table>
          <tr>
            <td><b>Sá»‘ vÄƒn báº£n</b></td><td>${chitiet.soVanBan || ""}</td>
            <td><b>STT</b></td><td>${chitiet.stt || ""}</td>
          </tr>
          <tr>
            <td><b>CÆ¡ quan/Ä‘Æ¡n vá»‹ gá»­i Ä‘áº¿n</b></td><td>${chitiet.coQuanGui || ""}</td>
            <td><b>Loáº¡i vÄƒn báº£n</b></td><td>${chitiet.loaiVanBan || ""}</td>
          </tr>
          <tr>
            <td><b>NgÃ y gá»­i Ä‘áº¿n</b></td><td>${chitiet.ngayGuiDen || ""}</td>
            <td><b>NgÃ y vÄƒn báº£n</b></td><td>${chitiet.ngayVanBan || ""}</td>
          </tr>
          <tr>
            <td><b>Äá»™ kháº©n</b></td><td>${chitiet.doKhan || ""}</td>
            <td><b>Äá»™ máº­t</b></td><td>${chitiet.doMat || ""}</td>
          </tr>
          <tr>
            <td><b>TrÃ­ch yáº¿u</b></td><td colspan="3">${chitiet.trichYeu || ""}</td>
          </tr>
          <tr>
            <td><b>Ghi chÃº</b></td><td colspan="3">${chitiet.ghiChu || ""}</td>
          </tr>
          <tr>
            <td><b>Tráº¡ng thÃ¡i ngÆ°á»i dÃ¹ng</b></td>
            <td><span class="edoc-label danger">${chitiet.trangThaiND || ""}</span></td>
            <td><b>Tráº¡ng thÃ¡i vÄƒn báº£n</b></td>
            <td><span class="edoc-label warning">${chitiet.trangThaiVB || ""}</span></td>
          </tr>
          <tr>
            <td><b>File vÄƒn báº£n</b></td>
            <td colspan="3">${fileLinkHTML || "<i>KhÃ´ng cÃ³ tá»‡p Ä‘Ã­nh kÃ¨m</i>"}</td>
          </tr>
        </table>
      </div>
    </div>`;
}



    // =============== RENDER Ã KIáº¾N ===================
    function renderYKienTable(data) {
      if (!data || !data.length) return "";
      let html = `
    <div class="edoc-block">
      <div class="edoc-title">Ã KIáº¾N Xá»¬ LÃ VÄ‚N Báº¢N</div>
      <div class="edoc-body">
        <table>
          <thead>
            <tr>
              <th>NgÆ°á»i bÃºt phÃª</th>
              <th>Thá»i gian</th>
              <th>Ná»™i dung</th>
              <th>PhÃ²ng ban Ä‘áº§u má»‘i</th>
              <th>PhÃ²ng ban phá»‘i há»£p</th>
            </tr>
          </thead>
          <tbody>`;
      data.forEach(r => {
        html += `<tr>
        <td>${r["NgÆ°á»i bÃºt phÃª"] || ""}</td>
        <td>${r["Thá»i gian"] || ""}</td>
        <td>${r["Ná»™i dung"] || ""}</td>
        <td>${r["PhÃ²ng ban Ä‘áº§u má»‘i"] || ""}</td>
        <td>${r["PhÃ²ng ban phá»‘i há»£p"] || ""}</td>
      </tr>`;
      });
      html += `</tbody></table></div></div>`;
      return html;
    }

    // =============== RENDER LUÃ‚N CHUYá»‚N ===================
    function renderLuanChuyenTable(data) {
      if (!data || !data.length) return "";
      let html = `
    <div class="edoc-block">
      <div class="edoc-title">THÃ”NG TIN LUÃ‚N CHUYá»‚N VÄ‚N Báº¢N</div>
      <div class="edoc-body">
        <table>
          <thead>
            <tr>
              <th>NgÆ°á»i gá»­i</th>
              <th>ÄÆ¡n vá»‹ nháº­n</th>
              <th>NgÆ°á»i nháº­n</th>
              <th>Thá»i gian gá»­i</th>
              <th>Thá»i gian nháº­n</th>
              <th style="text-align:center">Tráº¡ng thÃ¡i</th>
              <th>LÃ½ do</th>
            </tr>
          </thead>
          <tbody>`;
      data.forEach(r => {
        // mapping tráº¡ng thÃ¡i -> class
        let statusClass = "warning";
        const status = (r.trang_thai || "").toLowerCase();

        if (status.includes("Ä‘Ã£ nháº­n")) {
          statusClass = "success";   // xanh
        } else if (status.includes("Ä‘Ã£ gá»­i")) {
          statusClass = "warning";   // cam
        } else {
          statusClass = "danger";    // Ä‘á» cho lá»—i/tráº¡ng thÃ¡i khÃ¡c
        }

        html += `<tr>
        <td>${r.nguoi_gui || ""}</td>
        <td>${r.don_vi_nhan || ""}</td>
        <td>${r.nguoi_nhan || ""}</td>
        <td>${r.thoi_gian_gui || ""}</td>
        <td>${r.thoi_gian_nhan || ""}</td>
        <td style="text-align:center">
          ${r.trang_thai ? `<span class="edoc-label ${statusClass}">${r.trang_thai}</span>` : ""}
        </td>
        <td>${r.ly_do || ""}</td>
      </tr>`;
      });
      html += `</tbody></table></div></div>`;
      return html;
    }
    // === Danh sÃ¡ch nhÃ¢n sá»± phÃ²ng Tá»• chá»©c - Tiá»n lÆ°Æ¡ng ===
    const nhanSuPhong = [
      {
        "Hoten": "LÃª Anh Háº£o",
        "Chucvu": "TrÆ°á»Ÿng phÃ²ng"
      },
      {
        "Hoten": "Nguyá»…n Thá»‹ BÃ­ch Tháº£o",
        "Chucvu": "PhÃ³ TrÆ°á»Ÿng phÃ²ng"
      },
      {
        "Hoten": "Sáº§m Thá»‹ Kim PhÆ°Æ¡ng",
        "Chucvu": "PhÃ³ TrÆ°á»Ÿng phÃ²ng"
      },
      {
        "Hoten": "TrÆ°Æ¡ng HoÃ ng Nam",
        "Chucvu": "PhÃ³ TrÆ°á»Ÿng phÃ²ng"
      },
      {
        "Hoten": "TrÆ°Æ¡ng Há»“ng Quang",
        "Chucvu": "CÃ´ng chá»©c phá»¥ trÃ¡ch"
      },
      {
        "Hoten": "Trá»‹nh Thá»‹ PhÆ°Æ¡ng",
        "Chucvu": "CÃ´ng chá»©c phá»¥ trÃ¡ch"
      },
      {
        "Hoten": "Nguyá»…n Thu Thá»§y",
        "Chucvu": "CÃ´ng chá»©c phá»¥ trÃ¡ch"
      },
      {
        "Hoten": "Nguyá»…n Minh Anh",
        "Chucvu": "CÃ´ng chá»©c phá»¥ trÃ¡ch"
      },
      {
        "Hoten": "Tráº§n Thá»‹ Háº£i Yáº¿n",
        "Chucvu": "CÃ´ng chá»©c phá»¥ trÃ¡ch"
      },
      {
        "Hoten": "Nguyá»…n Quá»³nh Anh",
        "Chucvu": "VÄƒn thÆ°"
      },
      {
        "Hoten": "Pháº¡m Thu HoÃ i",
        "Chucvu": "CÃ´ng chá»©c phá»¥ trÃ¡ch"
      },
      {
        "Hoten": "ThÃ¢n HoÃ ng Duy",
        "Chucvu": "CÃ´ng chá»©c phá»¥ trÃ¡ch"
      },
      {
        "Hoten": "HoÃ ng Quá»³nh LiÃªn",
        "Chucvu": "CÃ´ng chá»©c phá»¥ trÃ¡ch"
      },
      {
        "Hoten": "LÃª Thá»‹ Kim Oanh",
        "Chucvu": "VÄƒn thÆ°"
      },
      {
        "Hoten": "Tráº§n Thu Huyá»n",
        "Chucvu": "LÃ£nh Ä‘áº¡o Vá»¥"
      },
      {
        "Hoten": "LÃª Viá»‡t HÃ¹ng",
        "Chucvu": "LÃ£nh Ä‘áº¡o Vá»¥"
      },
      {
        "Hoten": "Nguyá»…n Anh Tuáº¥n",
        "Chucvu": "LÃ£nh Ä‘áº¡o Vá»¥"
      }
    ];
    function guessRole(label, nhanSuList = []) {
      const t = normalize(label || "");
      if (t.includes("vÄƒn thÆ°")) return "VÄƒn thÆ°";
      if (t.includes("lÃ£nh Ä‘áº¡o vá»¥")) return "LÃ£nh Ä‘áº¡o Vá»¥";
      if (t.includes("lÃ£nh Ä‘áº¡o phÃ²ng")) return "LÃ£nh Ä‘áº¡o PhÃ²ng";
      if (t.includes("cÃ´ng chá»©c phá»¥ trÃ¡ch")) return "CÃ´ng chá»©c phá»¥ trÃ¡ch";  // ğŸ‘ˆ thÃªm dÃ²ng nÃ y

      // náº¿u label lÃ  tÃªn tháº­t
      const hit = (window.nhanSuList || nhanSuList || []).find(
        n => t.includes(normalize(n.Hoten || ""))
      );
      return hit ? (hit.Chucvu || "KhÃ¡c") : "KhÃ¡c";
    }
    function normalize(str) {
      return str
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")   // bá» dáº¥u
        .replace(/[Ä‘Ä]/g, "d")             // chuáº©n hÃ³a Ä‘/Ä thÃ nh d
        .replace(/[^A-Za-z0-9\s]/g, "")    // giá»¯ láº¡i chá»¯ (hoa + thÆ°á»ng), sá»‘, khoáº£ng tráº¯ng
        .trim()
        .toLowerCase();
    };
    function toVNDateTime24s(str) {
      if (!str) return "";
      // Báº¯t dd/MM/yyyy HH:mm[,ss] [AM|PM] (HH cÃ³ thá»ƒ 1-2 chá»¯ sá»‘)
      const m = str.match(/(\d{2}\/\d{2}\/\d{4})\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?/i);
      if (!m) return str; // khÃ´ng khá»›p thÃ¬ giá»¯ nguyÃªn

      const date = m[1];
      let hour = parseInt(m[2], 10);
      const minute = m[3];
      let second = m[4] ?? "00";           // náº¿u thiáº¿u giÃ¢y â†’ "00"
      const ampm = m[5] ? m[5].toUpperCase() : null;

      if (ampm) {
        if (ampm === "PM" && hour < 12) hour += 12;
        if (ampm === "AM" && hour === 12) hour = 0;
      }
      return `${date} ${hour.toString().padStart(2, "0")}:${minute}:${second.padStart(2, "0")}`;
    }
    function cloneRowsFromArray(array, templateId, defaultRole, defaultTime) {
      if (!array || array.length === 0) return;

      const tbody = document.querySelector("#processTable tbody");
      const templateRow = document.getElementById(templateId);

      array.forEach((c, idx) => {
        const rowId = `${templateId}r${idx}`;
        const row = document.createElement("tr");
        row.id = rowId;

        row.innerHTML = `
        <td>${c.noidung || "Xá»­ lÃ½ Tá» trÃ¬nh"}</td>
        <td>${c.chuc_vu || defaultRole}</td>
        <td id="ngaygui-${rowId}">${c.thoi_gian || ""}</td>
        <td id="nguoigui-${rowId}">${c.nguoi_gui || ""}</td>
        <td id="nguoinhan-${rowId}">${c.nguoi_nhan || ""}</td>
        <td id="donvinhan-${rowId}">${c.don_vi_nhan || ""}</td>
        <td>${defaultTime || ""}</td>
        <td></td>
        <td></td>
        <td><textarea class="result-input" id="res-${rowId}" readonly placeholder="Nháº­p káº¿t quáº£"></textarea></td>
        <td><span id="time-text-${rowId}">${c.thoi_gian || ""}</span></td>
        <td id="decision-${rowId}"></td>
      `;

        tbody.insertBefore(row, templateRow.nextSibling);
        row.classList.remove("hidden");   // âœ… thÃªm dÃ²ng nÃ y
        lockEdocRow(rowId);
      });

      // áº¨n dÃ²ng template gá»‘c
      templateRow.classList.add("hidden");

      // ğŸ‘‰ má»Ÿ tiáº¿p bÆ°á»›c sau dá»±a trÃªn timestamp má»›i nháº¥t
      const lastTime = array
        .map(c => parseVNDate(c.thoi_gian))
        .filter(Boolean)
        .reduce((a, b) => a > b ? a : b, null);

      if (lastTime) {
        const lastRowId = `${templateId}r${array.length - 1}`;
        const match = templateId.match(/s(\d+)r(\d+)/);
        if (match) {
          const s = parseInt(match[1]);
          const r = parseInt(match[2]);
          showNext(lastRowId, s, r);
        }
      }
    }
    // Chuáº©n hoÃ¡ tÃªn ngÆ°á»i nháº­n (bá» " - Phá»‘i há»£p" / " - Äáº§u má»‘i")
    function cleanReceiverName(name) {
      if (!name) return "";
      return name.replace(/\s*-\s*(phá»‘i há»£p|Ä‘áº§u má»‘i)$/i, "").trim();
    }

    function fillStepsFromEdoc(edocData, nhanSuList = []) {
      const steps = {
        vanThu: null,
        lanhDaoVu: [],
        lanhDaoPhong: null,
        congChuc: []
      };

      edocData.forEach((item, i) => {
        const cleanNguoiNhan = cleanReceiverName(item.nguoi_nhan || "");
        const nguoiNhan = normalize(cleanNguoiNhan);

        // tÃ¬m cÃ¡ nhÃ¢n trong danh sÃ¡ch
        const matched = nhanSuList.find(n => nguoiNhan.includes(normalize(n.Hoten || "")));

        const record = {
          noidung: item.noidung || "Tiáº¿p nháº­n Tá» trÃ¬nh",
          thoi_gian: toVNDateTime24s(item.thoi_gian_gui),
          nguoi_gui: item.nguoi_gui || "",
          nguoi_nhan: cleanNguoiNhan,
          don_vi_nhan: item.don_vi_nhan || "",
          chuc_vu: matched ? matched.Chucvu : ""
        };

        if (matched) {
          const role = normalize(matched.Chucvu || "");
          console.log(`role normalize: ${matched.Chucvu} => ${role}`);

          if (role.includes("van thu")) {
            if (!steps.vanThu) {
              steps.vanThu = record;
              console.log("âœ… PUSH VÄƒn thÆ°:", record);
            }
            return;
          }

          if (role.includes("lanh dao vu") || role.includes("vu truong") || role.includes("pho vu truong")) {
            const donvi = normalize(item.don_vi_nhan || "");
            if (donvi.includes("ban lanh dao vu")) {
              steps.lanhDaoVu.push(record);
              console.log("âœ… PUSH LÃ£nh Ä‘áº¡o Vá»¥:", record)
              console.log(donvi);
              return;
            }
            console.log("âš ï¸ Bá» qua LÃ£nh Ä‘áº¡o Vá»¥ vÃ¬ Ä‘Æ¡n vá»‹ nháº­n khÃ´ng khá»›p:", record);
            console.log(donvi);
            return;
          }

          if (role.includes("lanh dao phong") || role.includes("truong phong") || role.includes("pho truong phong")) {
            if (!steps.lanhDaoPhong) {
              steps.lanhDaoPhong = record;
              console.log("âœ… PUSH LÃ£nh Ä‘áº¡o PhÃ²ng:", record);
            }
            return;
          }

          if (role.includes("cong chuc phu trach") || role.includes("chuyen vien") || role.includes("chuyen vien chinh")) {
            steps.congChuc.push(record);
            console.log("âœ… PUSH CÃ´ng chá»©c phá»¥ trÃ¡ch:", record);
            return;
          }
        }


      });

      // Sáº¯p xáº¿p theo thá»i gian
      steps.lanhDaoVu.sort((a, b) => parseVNDate(a.thoi_gian) - parseVNDate(b.thoi_gian));
      steps.congChuc.sort((a, b) => parseVNDate(a.thoi_gian) - parseVNDate(b.thoi_gian));

      console.log(">>> Tá»•ng VÄƒn thÆ°:", steps.vanThu);
      console.log(">>> Tá»•ng LÃ£nh Ä‘áº¡o Vá»¥:", steps.lanhDaoVu);
      console.log(">>> Tá»•ng LÃ£nh Ä‘áº¡o PhÃ²ng:", steps.lanhDaoPhong);
      console.log(">>> Tá»•ng CÃ´ng chá»©c phá»¥ trÃ¡ch:", steps.congChuc);

      return steps;
    }
    function exportExcelSharePointFormat() {
      // Thu tháº­p toÃ n bá»™ step/sub
      const rows = [];
      processData.forEach((step, s) => {
        step.sub.forEach((row, r) => {
          const rowId = `s${s}r${r}`;
          rows.push({
            step: step.title,
            noidung: row.noidung,
            nguoi: row.nguoi || "",
            xuly: row.xuly || "",
            cho: row.cho || "",
            res: document.getElementById(`res-${rowId}`).value || "",
            time: document.getElementById(`time-text-${rowId}`).textContent || "",
            decision: document.getElementById(`decision-${rowId}`).textContent || ""
          });
        });
      });

      // Sinh REF
      const now = new Date();
      const pad = n => n.toString().padStart(2, "0");
      const ref = `TCCB5.003_${pad(now.getDate())}${pad(now.getMonth() + 1)}${now.getFullYear()}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;

      // GÃ³i toÃ n bá»™ rows vÃ o 1 JSON string
      const jsonString = JSON.stringify(rows);

      // Táº¡o duy nháº¥t 1 dÃ²ng
      const excelData = [{
        REF: ref,
        DATA: jsonString,
        DEPT: document.getElementById("deptName")?.textContent.replace("PhÃ²ng: ", "").trim() || "",
        QUYTRINH: document.querySelector("h1")?.textContent.trim() || ""
      }];

      // Xuáº¥t Excel
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(excelData);
      XLSX.utils.book_append_sheet(wb, ws, "QuyTrinh");
      XLSX.writeFile(wb, "quytrinh.xlsx");
    }
    document.getElementById("processSelect")
      .addEventListener("change", e => window.location.href = e.target.value);



    // âœ… RENDER PROCESS Tá»ª JSON PHáº²NG (thay cho renderProcess cÅ©)
    function renderProcessFromJson() {
  const processData = window.processData || [];
  const tableContainer = document.getElementById("processTable");

  if (!tableContainer) {
    console.error("âŒ KhÃ´ng tÃ¬m tháº¥y pháº§n tá»­ #processTable trong DOM.");
    return;
  }

  if (!Array.isArray(processData) || processData.length === 0) {
    tableContainer.innerHTML = `<p>âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u quy trÃ¬nh Ä‘á»ƒ hiá»ƒn thá»‹.</p>`;
    return;
  }

  console.log("ğŸ“‹ [Render] Báº¯t Ä‘áº§u render", processData.length, "bÆ°á»›c quy trÃ¬nh");

  // ğŸ§© Dá»±ng HTML báº£ng
  let html = `
    <table class="process-table-inner">
      <thead>
        <tr>
          <th>Ná»™i dung thá»±c hiá»‡n</th>
          <th>NgÆ°á»i thá»±c hiá»‡n/PhÃª duyá»‡t</th>
          <th>NgÃ y gá»­i</th>
          <th>NgÆ°á»i nháº­n</th>
          <th>ÄÆ¡n vá»‹ nháº­n</th>
          <th>Thá»i gian xá»­ lÃ½</th>
          <th>Thá»i gian chá»</th>
          <th>Káº¿t quáº£</th>
          <th>NgÃ y hoÃ n thÃ nh</th>
          <th>Quyáº¿t Ä‘á»‹nh</th>
        </tr>
      </thead>
      <tbody>
  `;

  processData.forEach((step, s) => {
    html += `<tr class="step-title"><td colspan="12"><b>${step.title || `BÆ°á»›c ${s + 1}`}</b></td></tr>`;
    if (!step.sub || !Array.isArray(step.sub)) return;

    step.sub.forEach((row, r) => {
      const id = `s${s}r${r}`;

      // ğŸ§  táº¡o dropdown (cÃ³ ID riÃªng Ä‘á»ƒ send)
const dropdownNguoi = getDropdownHTML1(row.nguoinhan || "").replace(
  "<select",
  `<select id="nguoinhan-${id}" class="select-nguoinhan"`
);
const dropdownDonVi = getDropdownHTML(row.donvinhan || "").replace(
  "<select",
  `<select id="donvinhan-${id}" class="select-donvinhan"`
);

      html += `
        <tr class="${(s === 0 && r === 0) ? "" : "hidden"}" id="${id}">
          <td>${row.noidung || ""}</td>
          <td>${row.nguoi || ""}</td>
          <td id="ngaygui-${id}"></td>

          <!-- ğŸ§© ÄÃºng thá»© tá»±: NgÆ°á»i nháº­n trÆ°á»›c, ÄÆ¡n vá»‹ nháº­n sau -->
          <td>${dropdownNguoi}</td>
          <td>${dropdownDonVi}</td>

          <td>${row.xuly || ""}</td>
          <td>${row.cho || ""}</td>

          <td>
            <textarea
              class="result-input"
              id="res-${id}"
              placeholder="Nháº­p káº¿t quáº£"
            ></textarea>
      `;

      // âš™ï¸ Decision logic
      if (row.buttons && Array.isArray(row.buttons) && row.buttons.length >= 2) {
        const [positiveLabel, negativeLabel] = row.buttons;
        html += `
            <div id="decision-choices-${id}">
              <button class="btn btn-next" onclick="chooseDecision('${id}',${s},${r},true)">${positiveLabel}</button>
              <button class="btn btn-next" onclick="chooseDecision('${id}',${s},${r},false)">${negativeLabel}</button>
            </div>
            <div id="decision-time-${id}" class="hidden">
              <button class="btn btn-next" onclick="decisionStepNow('${id}',${s},${r})">â±</button>
              <button class="btn btn-next" onclick="decisionStepManual('${id}',${s},${r})">ğŸ“…</button>
            </div>
          `;
      } else {
        html += `
            <button class="btn btn-next" onclick="completeStepNow('${id}',${s},${r})">â±</button>
            <button class="btn btn-next" onclick="completeStepManual('${id}',${s},${r})">ğŸ“…</button>
          `;
      }

      html += `
          </td>
          <td>
            <div class="time-wrapper">
              <input type="datetime-local" id="time-${id}" class="time-input" onchange="applyManualTime('${id}')">
              <span id="time-text-${id}"></span>
              <span id="time-icon-${id}" class="time-icon hidden" onclick="openTimeInput('${id}')">ğŸ•’</span>
            </div>
          </td>
          <td id="decision-${id}"></td>
        </tr>
      `;
    });
  });

  html += `</tbody></table>`;
  tableContainer.innerHTML = html;

  console.log("âœ… [Render] HoÃ n táº¥t render quy trÃ¬nh");
}


    function chooseDecision(id, s, r, isPositive) {
      console.groupCollapsed(`[chooseDecision] id=${id}, s=${s}, r=${r}, isPositive=${isPositive}`);

      // ğŸ§© Láº¥y thÃ´ng tin step hiá»‡n táº¡i
      const row = processData[s]?.sub?.[r] || {};
      const stepType = row.type || "normal";

      // ğŸ§© Æ¯u tiÃªn láº¥y text tá»« buttons trong data (náº¿u cÃ³)
      const buttons = row.buttons && Array.isArray(row.buttons) && row.buttons.length >= 2
        ? row.buttons
        : stepType === "decision3"
          ? ["Thá»‘ng nháº¥t", "ChÆ°a thá»‘ng nháº¥t"]
          : ["PhÃ¹ há»£p", "ChÆ°a phÃ¹ há»£p"];

      // ğŸ§  XÃ¡c Ä‘á»‹nh text Ä‘Æ°á»£c chá»n
      const choiceText = isPositive ? buttons[0] : buttons[1];

      // ğŸ”¹ LÆ°u tráº¡ng thÃ¡i táº¡m thá»i
      const decisionEl = document.getElementById(`decision-${id}`);
      if (decisionEl) {
        decisionEl.dataset.choice = choiceText;
        decisionEl.textContent = choiceText;
      }

      // ğŸ”¹ áº¨n nhÃ³m nÃºt chá»n
      document.getElementById(`decision-choices-${id}`)?.classList.add("hidden");

      // ğŸ”¹ Hiá»‡n cá»¥m chá»n thá»i gian (â±ğŸ“…)
      document.getElementById(`decision-time-${id}`)?.classList.remove("hidden");

      console.log(`ğŸŸ¢ [Decision] ${choiceText} â†’ chá» chá»n thá»i gian`);
      console.groupEnd();
    }


    // === Láº¥y REF tá»« URL ===
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }



    // === Import tá»« Cloud theo REF (Flow pháº£i há»— trá»£ query REF) ===
    async function importFromCloudByRef(ref) {
      console.groupCollapsed(`ğŸŒ [importFromCloudByRef] Báº¯t Ä‘áº§u import REF="${ref}"`);

      if (!ref) {

        console.groupEnd();
        return;
      }

      try {
        // âš™ï¸ Gá»i Flow kÃ¨m REF
        const FLOW_URL_BASE =
          "https://default460cecfbf0c64dd7a5ec66ef4d75ae.63.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/835980df6c0a4b5892289dcbc334ef50/triggers/manual/paths/invoke";
        const FLOW_SIG =
          "?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=YJ4F3Gm_-Z5fPBUfteIeNr5YK-Kg_6C3OyKIvqXfj1M";
        const url = `${FLOW_URL_BASE}${FLOW_SIG}&ref=${encodeURIComponent(ref)}`;

        console.log("ğŸŒ Gá»i Flow:", url);
        const res = await fetch(url, { method: "GET" });
        if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);

        const raw = (await res.text()).trim();
        console.log("ğŸ“¦ Raw:", raw.slice(0, 300));

        // âœ… Parse JSON (ká»ƒ cáº£ double encode)
        let data;
        try {
          data = JSON.parse(raw);
        } catch {
          data = JSON.parse(JSON.parse(raw));
        }

        if (!Array.isArray(data) || !data.length)
          throw new Error("Flow khÃ´ng tráº£ dá»¯ liá»‡u há»£p lá»‡.");
        const item = data[0];

        const quytrinhName = item.QUYTRINH_NAME || item["TÃŠN QUY TRÃŒNH"] || "";
        const dataRaw = item.DATA || "[]";

        console.log("ğŸ”¹ QUYTRINH_NAME:", quytrinhName);
        console.log("ğŸ”¹ DATA (raw):", dataRaw.slice(0, 200));

        // âœ… 1. Äá»£i dropdown render Ä‘áº§y Ä‘á»§
        const select = document.getElementById("processSelectChiTiet");
        if (!select) throw new Error("KhÃ´ng tÃ¬m tháº¥y dropdown #processSelectChiTiet");

        console.log("â³ Äang chá» dropdown quy trÃ¬nh render...");
        await new Promise(resolve => {
          const maxWait = 8000;
          const start = Date.now();
          const timer = setInterval(() => {
            if (select.options.length > 1) {
              clearInterval(timer);
              console.log("âœ… Dropdown quy trÃ¬nh Ä‘Ã£ sáºµn sÃ ng.");
              resolve();
            } else if (Date.now() - start > maxWait) {
              clearInterval(timer);
              console.warn("âš ï¸ Dropdown chÆ°a sáºµn sau 8s, tiáº¿p tá»¥c import...");
              resolve();
            }
          }, 300);
        });

        // âœ… 2. Chá»n option khá»›p tÃªn
        const match = Array.from(select.options).find(
          o => o.textContent.trim().toLowerCase() === quytrinhName.trim().toLowerCase()
        );

        if (match) {
          console.log("âœ… [Auto-select] Khá»›p quy trÃ¬nh:", match.textContent);
          select.value = match.value;
          select.dispatchEvent(new Event("change"));
        } else {
          console.warn("âš ï¸ KhÃ´ng tÃ¬m tháº¥y option khá»›p tÃªn:", quytrinhName);
        }

        // âœ… 3. Cáº­p nháº­t tiÃªu Ä‘á»
        const h1 = document.querySelector("h1");
        if (h1) h1.textContent = quytrinhName || ref;

        // âœ… 4. Äá»£i báº£ng render xong (inner table)
        console.log("â³ Äang chá» báº£ng #processTable render...");
        await new Promise(resolve => {
          const maxWait = 6000;
          const start = Date.now();
          const timer = setInterval(() => {
            const tbl = document.getElementById("processTable");
            if (tbl && tbl.querySelectorAll("tr").length > 1) {
              clearInterval(timer);
              console.log("âœ… Báº£ng #processTable Ä‘Ã£ render xong!");
              resolve();
            } else if (Date.now() - start > maxWait) {
              clearInterval(timer);
              console.warn("â° Háº¿t thá»i gian chá» render báº£ng.");
              resolve();
            }
          }, 300);
        });

        // âœ… 5. Parse dá»¯ liá»‡u DATA tá»« SharePoint
        let parsedData = [];
        try {
          parsedData = typeof dataRaw === "string" ? JSON.parse(dataRaw) : dataRaw;
        } catch (err) {
          console.warn("âš ï¸ DATA khÃ´ng parse Ä‘Æ°á»£c JSON:", err);
        }

        // âœ… 6. Gá»i render vÃ  fill dá»¯ liá»‡u
        if (Array.isArray(parsedData) && parsedData.length) {
          console.log("ğŸ“Š parseDecodedToTable(parsedData)", parsedData);

          // ğŸŸ© Äáº£m báº£o báº£ng inner Ä‘Æ°á»£c render trÆ°á»›c
          if (typeof renderProcessFromJson === "function") {
            renderProcessFromJson();
          }

          // ğŸŸ© Sau Ä‘Ã³ fill dá»¯ liá»‡u tá»«ng dÃ²ng tá»« SharePoint
          if (typeof hydrateFromSharePointData === "function") {
            hydrateFromSharePointData(parsedData);
          } else if (typeof parseDecodedToTable === "function") {
            parseDecodedToTable(parsedData);
          } else {
            console.table(parsedData);

          }

          // ğŸŸ¢ NEW: Äá»“ng bá»™ láº¡i tráº¡ng thÃ¡i vÃ o processData Ä‘á»ƒ cÃ³ thá»ƒ PATCH ngÆ°á»£c
          if (window.processData) {
            parsedData.forEach(item => {
              const stepIndex = window.processData.findIndex(
                s => (s.title || s.step || "").trim().toLowerCase() === (item.step || "").trim().toLowerCase()
              );
              if (stepIndex < 0) return;
              const subIndex = window.processData[stepIndex].sub.findIndex(
                sub => (sub.noidung || "").trim() === (item.noidung || "").trim()
              );
              if (subIndex < 0) return;

              window.processData[stepIndex].sub[subIndex] = {
                ...window.processData[stepIndex].sub[subIndex],
                ...item
              };
            });

            console.log("ğŸ” processData Ä‘Ã£ Ä‘Æ°á»£c sync vá»›i SharePoint");
          }
        } else {
          console.warn("âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u DATA há»£p lá»‡ trong SharePoint.");
        }


      } catch (err) {
        console.error("ğŸ’¥ Lá»—i importFromCloudByRef:", err);

      } finally {
        console.groupEnd();
      }
    }







    function formatDate(d) {
      return d.toLocaleDateString("vi-VN", { day: "2-digit", month: "2-digit", year: "numeric" }) + " " +
        d.toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }

    function lockStep(id, s, r) {
      document.getElementById(`res-${id}`).readOnly = true;
      document.querySelectorAll(`#${id} .btn-next`).forEach(btn => btn.classList.add("hidden"));

      // âœ… Chá»‰ hiá»‡n nÃºt chá»‰nh sá»­a náº¿u Ä‘Ã£ cÃ³ dá»¯ liá»‡u
      const res = document.getElementById(`res-${id}`).value.trim();
      const time = document.getElementById(`time-text-${id}`).textContent.trim();
      const decision = document.getElementById(`decision-${id}`).textContent.trim();


    }

    // âš™ï¸ VÃ¬ báº¡n render tá»« BÆ°á»›c 2, ta cá»™ng offset Ä‘á»ƒ map Ä‘Ãºng index


    function showNext(id, s, r) {
      console.groupCollapsed(`[showNext] id=${id}, s=${s}, r=${r}`);

      const step = processData[s];
      if (!step) {
        console.warn("âš ï¸ KhÃ´ng tÃ¬m tháº¥y step:", s);
        console.groupEnd();
        return;
      }

      // ğŸ‘‰ Kiá»ƒm tra náº¿u cÃ²n dÃ²ng káº¿ trong cÃ¹ng step
      const nextRow = document.getElementById(`s${s}r${r + 1}`);
      if (nextRow) {
        console.log("â¡ï¸ Má»Ÿ tiáº¿p dÃ²ng cÃ¹ng bÆ°á»›c:", `s${s}r${r + 1}`);
        nextRow.classList.remove("hidden");
        updateSummary();
        console.groupEnd();
        return;
      }

      // ğŸ§© Náº¿u khÃ´ng cÃ³ dÃ²ng káº¿ â†’ má»Ÿ bÆ°á»›c káº¿
      const nextStepIndex = s + 1;
      const nextStep = processData[nextStepIndex];
      console.log("ğŸŸ¢ Thá»­ má»Ÿ bÆ°á»›c káº¿ tiáº¿p:", nextStepIndex);

      if (nextStep) {
        const rid = `s${nextStepIndex}r0`;
        const rowEl = document.getElementById(rid);
        if (rowEl) {
          rowEl.classList.remove("hidden");

          document.getElementById(`decision-${rid}`).textContent = "";
          document.getElementById(`time-text-${rid}`).textContent = "";

          const stepType = nextStep.sub?.[0]?.type || "normal";
          console.log("ğŸ“Œ nextStep.type:", stepType);

          if (stepType === "decision2" || stepType === "decision3") {
            document.getElementById(`decision-choices-${rid}`)?.classList.remove("hidden");
            document.getElementById(`decision-time-${rid}`)?.classList.add("hidden");
          } else {
            rowEl.querySelectorAll(".btn-next").forEach(btn => {
              btn.classList.remove("hidden");
              btn.style.display = "inline-flex";
            });
          }
        }
      } else {
        console.warn("âš ï¸ KhÃ´ng cÃ³ bÆ°á»›c tiáº¿p theo (háº¿t quy trÃ¬nh)");
      }

      updateSummary();
      console.groupEnd();
    }

    // Giá»¯ Ä‘á»“ng bá»™ vá»›i showNext


    function editStep(id, s, r, nguoi) {
      console.groupCollapsed("[editStep] START");
      console.log("â–¶ï¸ id:", id, "| s:", s, "| r:", r, "| nguoi:", nguoi);

      if (!confirm("âš ï¸ Sá»­a bÆ°á»›c nÃ y? CÃ¡c bÆ°á»›c sau sáº½ bá»‹ xÃ³a.")) return;

      const pass = prompt(`Nháº­p passcode (tÃªn ngÆ°á»i: ${nguoi})`);
      if (pass !== nguoi) {
        alert("âŒ Sai passcode");
        console.groupEnd();
        return;
      }

      // 1ï¸âƒ£ Reset toÃ n bá»™ bÆ°á»›c sau
      for (let i = s; i < processData.length; i++) {
        const step = processData[i];
        if (!step?.sub) continue;

        for (let j = (i === s ? r : 0); j < step.sub.length; j++) {
          const rid = `s${i}r${j}`;
          const row = document.getElementById(rid);
          if (!row) continue;

          // reset ná»™i dung
          const resEl = document.getElementById(`res-${rid}`);
          if (resEl) {
            resEl.removeAttribute("readonly");
            resEl.value = "";
          }
          document.getElementById(`time-text-${rid}`).textContent = "";
          document.getElementById(`decision-${rid}`).textContent = "";
          document.getElementById(`time-${rid}`).value = "";

          // áº©n cá»¥m cha
          document.getElementById(`decision-choices-${rid}`)?.classList.add("hidden");
          document.getElementById(`decision-time-${rid}`)?.classList.add("hidden");

          document.getElementById(`time-icon-${rid}`)?.classList.add("hidden");

          // áº©n toÃ n dÃ²ng trá»« dÃ²ng hiá»‡n táº¡i
          if (!(i === s && j === r)) row.classList.add("hidden");
        }
      }

      // 2ï¸âƒ£ Má»Ÿ láº¡i dÃ²ng hiá»‡n táº¡i
      const curRow = document.getElementById(id);
      if (!curRow) return;

      curRow.classList.remove("hidden");
      document.getElementById(`res-${id}`)?.removeAttribute("readonly");

      document.getElementById(`decision-${id}`).textContent = "";
      document.getElementById(`time-text-${id}`).textContent = "";

      // 3ï¸âƒ£ XÃ¡c Ä‘á»‹nh loáº¡i bÆ°á»›c hiá»‡n táº¡i
      const stepType = processData[s]?.sub?.[r]?.type || "normal";
      console.log("ğŸ“Œ stepType:", stepType);

      const choicesEl = document.getElementById(`decision-choices-${id}`);
      const timeEl = document.getElementById(`decision-time-${id}`);

      // 4ï¸âƒ£ Hiá»‡n cá»¥m tÆ°Æ¡ng á»©ng cho bÆ°á»›c nÃ y
      if (stepType === "decision2" || stepType === "decision3") {
        console.log("ğŸŸ¡ LÃ  bÆ°á»›c decision â†’ báº­t láº¡i cá»¥m chá»n quyáº¿t Ä‘á»‹nh");
        choicesEl?.classList.remove("hidden");
        timeEl?.classList.add("hidden");

        // Gáº¯n láº¡i onclick
        const btns = choicesEl?.querySelectorAll("button") || [];
        btns.forEach(btn => {
          const isOk =
            btn.textContent.includes("PhÃ¹ há»£p") ||
            btn.textContent.includes("Thá»‘ng nháº¥t");
          btn.onclick = () => chooseDecision(id, s, r, isOk);
          btn.style.pointerEvents = "auto";
        });
      } else {
        console.log("ğŸŸ¢ LÃ  bÆ°á»›c thÆ°á»ng â†’ báº­t láº¡i cá»¥m â±ğŸ“…");
        if (timeEl) {
          timeEl.classList.remove("hidden");
          const btns = timeEl.querySelectorAll(".btn-next");
          btns.forEach(btn => {
            btn.classList.remove("hidden");
            btn.style.display = "inline-flex";
            btn.style.pointerEvents = "auto";

            // phá»¥c há»“i onclick gá»‘c
            const oldOnClick = btn.getAttribute("onclick");
            if (oldOnClick) {
              btn.onclick = new Function(oldOnClick.replace(/^javascript:/, ""));
            }
          });
        }
      }

      // 5ï¸âƒ£ XÃ¡c Ä‘á»‹nh bÆ°á»›c káº¿ tiáº¿p há»£p lá»‡ Ä‘á»ƒ má»Ÿ (náº¿u cÃ³)
      const nextStep = processData[s]?.sub?.[r + 1]
        ? `s${s}r${r + 1}`
        : processData[s + 1]
          ? `s${s + 1}r0`
          : null;

      if (nextStep) {
        const nextRow = document.getElementById(nextStep);
        if (nextRow) {
          nextRow.classList.remove("hidden");
          console.log("â¡ï¸ Báº­t bÆ°á»›c káº¿ tiáº¿p:", nextStep);
        }
      } else {
        console.log("âšª KhÃ´ng cÃ³ bÆ°á»›c káº¿ tiáº¿p");
      }

      console.log("âœ… HoÃ n táº¥t khÃ´i phá»¥c cá»¥m nÃºt cho dÃ²ng", id);
      console.groupEnd();
      updateSummary();
    }



    // ===== Parse dd/MM/yyyy HH:mm:ss =====
    function parseVNDate(str) {
      if (!str) return null;

      // Match dd/MM/yyyy HH:mm[:ss] (cáº£ 24h vÃ  12h cÃ³ AM/PM)
      const m = str.match(
        /(\d{2})\/(\d{2})\/(\d{4})\s+(\d{1,2}):(\d{2})(?::(\d{2}))?(?:\s*(AM|PM))?/i
      );
      if (!m) return null;

      const d = parseInt(m[1], 10);
      const mo = parseInt(m[2], 10) - 1;
      const y = parseInt(m[3], 10);
      let hh = parseInt(m[4], 10);
      const mm = parseInt(m[5], 10);
      const ss = m[6] ? parseInt(m[6], 10) : 0;
      const ampm = m[7] ? m[7].toUpperCase() : null;

      if (ampm) {
        if (ampm === "PM" && hh < 12) hh += 12;
        if (ampm === "AM" && hh === 12) hh = 0;
      }

      return new Date(y, mo, d, hh, mm, ss);
    }

    function fmt(sec) {
      const d = Math.floor(sec / 86400); sec %= 86400;
      const h = Math.floor(sec / 3600); sec %= 3600;
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${d} ngÃ y ${h} giá» ${m} phÃºt ${s} giÃ¢y`;
    }

    // ===== Summary: tÃ­nh theo ngÆ°á»i, láº¥y má»‘c má»›i nháº¥t =====


    // (tuá»³ chá»n) gá»™p tÃªn chá»©c vá»¥ vá» dáº¡ng chuáº©n Ä‘á»ƒ trÃ¡nh lá»‡ch chÃ­nh táº£
    function canonicalRole(role) {
      const t = normalize(role || "");
      if (t.includes("van thu")) return "VÄƒn thÆ°";
      if (t.includes("lÃ£nh Ä‘áº¡o vá»¥") || t.includes("lanh dao vu")) return "LÃ£nh Ä‘áº¡o Vá»¥";
      if (t.includes("lÃ£nh Ä‘áº¡o phÃ²ng") || t.includes("lanh dao phong") || t.includes("truong phong") || t.includes("pho truong phong"))
        return "LÃ£nh Ä‘áº¡o PhÃ²ng";
      if (t.includes("cÃ´ng chá»©c") || t.includes("cong chuc")) return "CÃ´ng chá»©c phá»¥ trÃ¡ch";
      return role?.trim() || "";
    }

    // format gá»n: bá» bá»›t sá»‘ 0 Ä‘áº§u
    function fmtCompact(sec) {
      sec = Math.max(0, Math.floor(sec));
      const d = Math.floor(sec / 86400); sec %= 86400;
      const h = Math.floor(sec / 3600); sec %= 3600;
      const m = Math.floor(sec / 60); const s = sec % 60;
      const parts = [];
      if (d) parts.push(`${d} ngÃ y`);
      if (h || parts.length) parts.push(`${h} giá»`);
      if (m || parts.length) parts.push(`${m} phÃºt`);
      if (s || parts.length === 0) parts.push(`${s} giÃ¢y`);
      return parts.join(" ");
    }

function updateSummary() {
  console.groupCollapsed("ğŸ“Š [updateSummary] TÃ­nh tá»•ng thá»i gian theo chá»©c vá»¥");
  try {
    // 1ï¸âƒ£ Láº¥y danh sÃ¡ch sá»± kiá»‡n thá»±c táº¿
    const events = [];
    document.querySelectorAll("#processTable tbody tr:not(.step-title)").forEach(tr => {
      if (tr.classList.contains("hidden")) return;
      const cells = tr.querySelectorAll("td");
      if (!cells.length) return;

      const roleRaw = cells[1]?.textContent.trim();
      const role = canonicalRole(roleRaw);
      const timeStr = tr.querySelector("span[id^='time-text-']")?.textContent.trim();
      if (!role || !timeStr) return;

      const dt = parseVNDate(timeStr);
      if (!dt) return;
      events.push({ role, time: dt });
    });

    if (!events.length) {
      document.getElementById("summary").innerHTML =
        "<p>âš ï¸ ChÆ°a cÃ³ dá»¯ liá»‡u Ä‘á»ƒ hiá»ƒn thá»‹ tá»•ng thá»i gian.</p>";
      return;
    }

    // 2ï¸âƒ£ Sáº¯p theo thá»i gian tÄƒng dáº§n
    events.sort((a, b) => a.time - b.time);

    // 3ï¸âƒ£ TÃ­nh tá»•ng thá»i gian thá»±c táº¿ (giá»¯a cÃ¡c má»‘c)
    const totals = new Map();
    const counts = new Map();
    const order = [];

    for (let i = 0; i < events.length - 1; i++) {
      const cur = events[i];
      const next = events[i + 1];
      const diff = (next.time - cur.time) / 1000;
      if (diff <= 0) continue;

      if (!totals.has(cur.role)) order.push(cur.role);
      totals.set(cur.role, (totals.get(cur.role) || 0) + diff);
      counts.set(cur.role, (counts.get(cur.role) || 0) + 1);
    }

    // 4ï¸âƒ£ Gom nhÃ³m tiÃªu chuáº©n theo chá»©c vá»¥ (xá»­ lÃ½ + chá»)
    const stdTotals = new Map();
    const stdCounts = new Map();
    (window.processData || []).forEach(step => {
      (step.sub || []).forEach(sub => {
        const role = canonicalRole(sub.nguoi);
        if (!role) return;
        const sec = parseDurationToSec(sub.xuly) + parseDurationToSec(sub.cho);
        stdTotals.set(role, (stdTotals.get(role) || 0) + sec);
        stdCounts.set(role, (stdCounts.get(role) || 0) + 1);
      });
    });

    // âš™ï¸ Há»£p nháº¥t danh sÃ¡ch role tá»« cáº£ thá»±c táº¿ vÃ  tiÃªu chuáº©n
    const allRoles = Array.from(
      new Set([...order, ...stdTotals.keys()])
    );

    // 5ï¸âƒ£ Render báº£ng
    let html = `
      <h2>â± Tá»•ng thá»i gian theo chá»©c vá»¥ (cá»™ng dá»“n toÃ n trÃ¬nh)</h2>
      <table id="summaryTable">
        <tr>
          <th>Chá»©c vá»¥</th>
          <th>Thá»i gian thá»±c táº¿</th>
          <th>Thá»i gian tiÃªu chuáº©n (xá»­ lÃ½ + chá»)</th>
          <th>Sá»‘ Ä‘oáº¡n Ä‘áº£m nhiá»‡m</th>
        </tr>`;

    for (const role of allRoles) {
      const real = fmtCompact(totals.get(role) || 0);
      const std = fmtCompact(stdTotals.get(role) || 0);
      const cnt = counts.get(role) || stdCounts.get(role) || 0;
      html += `
        <tr>
          <td>${role}</td>
          <td>${real}</td>
          <td>${std}</td>
          <td>${cnt}</td>
        </tr>`;
    }

    // 6ï¸âƒ£ Tá»•ng toÃ n bá»™
    const totalOverall = (events[events.length - 1].time - events[0].time) / 1000;
    const stdOverall = Array.from(stdTotals.values()).reduce((a, b) => a + b, 0);

    html += `
      <tr style="background:#eee;font-weight:bold">
        <td>Tá»•ng quy trÃ¬nh</td>
        <td>${fmtCompact(totalOverall)}</td>
        <td>${fmtCompact(stdOverall)}</td>
        <td></td>
      </tr>
      </table>`;

    document.getElementById("summary").innerHTML = html;
    console.log("âœ… [updateSummary] HoÃ n táº¥t render báº£ng tá»•ng há»£p");

  } catch (err) {
    console.error("ğŸ’¥ Lá»—i updateSummary:", err);
    document.getElementById("summary").innerHTML =
      "<p>âŒ Lá»—i khi tÃ­nh tá»•ng thá»i gian</p>";
  } finally {
    console.groupEnd();
  }
}

function parseDurationToSec(str) {
  if (!str) return 0;
  str = str.toLowerCase();
  const d = parseFloat((str.match(/([\d.,]+)\s*ngÃ y/) || [])[1]) || 0;
  const h = parseFloat((str.match(/([\d.,]+)\s*giá»/) || [])[1]) || 0;
  const m = parseFloat((str.match(/([\d.,]+)\s*phÃºt/) || [])[1]) || 0;
  const s = parseFloat((str.match(/([\d.,]+)\s*giÃ¢y/) || [])[1]) || 0;
  return d * 86400 + h * 3600 + m * 60 + s;
}

function fmtCompact(sec) {
  if (!sec || sec < 1) return "0 giÃ¢y";
  const d = Math.floor(sec / 86400);
  const h = Math.floor((sec % 86400) / 3600);
  const m = Math.floor((sec % 3600) / 60);
  const s = Math.floor(sec % 60);
  return `${d ? d + " ngÃ y " : ""}${h ? h + " giá» " : ""}${m ? m + " phÃºt " : ""}${s ? s + " giÃ¢y" : ""}`;
}
    // ===== Export CSV (chá»‰ export row Ä‘ang hiá»ƒn thá»‹) =====



    // Láº¥y thá»i gian cuá»‘i cÃ¹ng Ä‘Ã£ cÃ³ trÆ°á»›c bÆ°á»›c hiá»‡n táº¡i
    function getLastTimeBefore(s, r) {
      for (let i = s; i >= 0; i--) {
        const rows = processData[i].sub;
        for (let j = (i === s ? r - 1 : rows.length - 1); j >= 0; j--) {
          const txt = document.getElementById(`time-text-s${i}r${j}`);
          if (txt && txt.textContent) {
            return parseVNDate(txt.textContent);
          }
        }
      }
      return null;
    }
    function applyManualTime(id) {
      const inp = document.getElementById(`time-${id}`);
      const txt = document.getElementById(`time-text-${id}`);

      if (inp.value) {
        const dt = new Date(inp.value);

        const match = id.match(/s(\d+)r(\d+)/);
        const s = parseInt(match[1]), r = parseInt(match[2]);
        const last = getLastTimeBefore(s, r);
        if (last && dt <= last) {
          alert("âŒ Thá»i gian pháº£i lá»›n hÆ¡n cÃ¡c bÆ°á»›c trÆ°á»›c!");
          inp.value = "";
          return;
        }

        txt.textContent = formatDate(dt);
        document.getElementById(`time-icon-${id}`).classList.add("hidden");

        // áº¨n cÃ¡c nÃºt thao tÃ¡c, chá»‰ cÃ²n nÃºt chá»‰nh sá»­a
        document.querySelectorAll(`#${id} .btn-next`).forEach(btn => btn.classList.add("hidden"));
        document.getElementById(`res-${id}`).readOnly = true;


        const choice = document.getElementById(`decision-${id}`).dataset.choice;
        if (choice) {
          const isPositive = (choice === "PhÃ¹ há»£p" || choice === "Thá»‘ng nháº¥t");
          finishDecision(id, s, r, isPositive);
        } else {
          showNext(id, s, r);
          updateSummary();
        }
      } else {
        txt.textContent = "";
      }
    }

    function openTimeInput(id) {
      const inp = document.getElementById(`time-${id}`);
      if (inp.showPicker) {
        inp.showPicker();   // Chrome
      } else {
        inp.click();        // fallback
      }
    }
    // ğŸ§© Tá»± Ä‘á»™ng chá»n quy trÃ¬nh khi record Ä‘ang edit cÃ³ QUYTRINH_NAME trÃ¹ng SharePoint
    function autoSelectProcessChiTiet(row) {
      let attempts = 0;

      const timer = setInterval(() => {
        const drop = document.getElementById("processSelectChiTiet");
        const listStr = sessionStorage.getItem("processListChiTiet");
        attempts++;

        if (!drop || !listStr) {
          console.log("â³ [autoSelectProcessChiTiet] Äang chá» dropdown hoáº·c processListChiTiet...");
          if (attempts > 10) {
            clearInterval(timer);
            console.warn("â›” Háº¿t thá»i gian chá» load processListChiTiet.");
          }
          return;
        }

        clearInterval(timer);

        const list = JSON.parse(listStr);
        const normalize = s => s.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();

        // ğŸ”¹ TÃªn quy trÃ¬nh tá»« record Ä‘ang edit
        const queryName = (row.QUYTRINH_NAME || row.quytrinh || "").trim();
        if (!queryName) {
          console.warn("âš ï¸ KhÃ´ng cÃ³ QUYTRINH_NAME trong record â†’ bá» qua auto-select");
          return;
        }

        const normQuery = normalize(queryName);

        // ğŸ”¹ So khá»›p vá»›i QUYTRINH_NAME hoáº·c TEN QUY TRÃŒNH tá»« SharePoint
        const found = list.find(x =>
          normalize(x.QUYTRINH_NAME || x.ten || "") === normQuery ||
          normalize(x.maSo || "") === normQuery
        );

        if (found) {
          // âœ… Set dropdown
          drop.value = found.maSo || "";

          // âœ… Láº¥y text hiá»ƒn thá»‹ tá»« dropdown (chÃ­nh lÃ  h1)
          const selectedText = drop.selectedOptions[0]?.textContent?.trim() || found.QUYTRINH_NAME || "";
          const h1 = document.querySelector("h1");
          if (h1) h1.textContent = selectedText;

          // âœ… Render dá»¯ liá»‡u quy trÃ¬nh
          window.processData = found.steps || [];
          renderProcessFromJson();

          console.log(`ğŸŸ¢ Auto chá»n quy trÃ¬nh: [${found.maSo}] ${selectedText}`);
        } else {
          console.warn("âš ï¸ KhÃ´ng tÃ¬m tháº¥y quy trÃ¬nh khá»›p tÃªn:", queryName);
        }
      }, 500);
    }
    function saveProcess(ref) {
      const data = {
        ref: ref,
        steps: [],
        summary: document.getElementById("summary").innerHTML
      };

      processData.forEach((step, s) => {
        step.sub.forEach((row, r) => {
          const id = `s${s}r${r}`;
          const res = document.getElementById(`res-${id}`).value;
          const time = document.getElementById(`time-text-${id}`).textContent;
          const decision = document.getElementById(`decision-${id}`).textContent;
          data.steps.push({
            step: step.title,
            noidung: row.noidung,
            nguoi: row.nguoi,
            xuly: row.xuly || "",
            cho: row.cho || "",
            res, time, decision
          });
        });
      });

      // ğŸ”„ lÆ°u vÃ o sessionStorage thay vÃ¬ localStorage
      let store = JSON.parse(sessionStorage.getItem("processStore") || "[]");
      store.push(data);
      sessionStorage.setItem("processStore", JSON.stringify(store));

      alert("âœ… ÄÃ£ lÆ°u quy trÃ¬nh (phiÃªn hiá»‡n táº¡i) vá»›i REF: " + ref);
    }

    document.addEventListener("DOMContentLoaded", () => {
      console.groupCollapsed("ğŸš€ DOMContentLoaded");

      // 1ï¸âƒ£ Láº¥y token key
      const savedToken = sessionStorage.getItem("tokenKey");
      if (savedToken) {
        window.tokenKey = savedToken;
        console.log("ğŸ”‘ TokenKey Ä‘Ã£ khÃ´i phá»¥c:", window.tokenKey.slice(0, 10) + "...");
      } else {
        console.warn("âš ï¸ ChÆ°a cÃ³ TOKEN_KEY trong sessionStorage");
      }

      // 2ï¸âƒ£ Láº¥y mode + selectedRow + ref
      const mode = sessionStorage.getItem("mode");
      const dataStr = sessionStorage.getItem("selectedRow");
      const refQuery = getQueryParam("ref");
      console.log("ğŸ’¬ mode =", mode, "| selectedRow =", !!dataStr, "| refQuery =", refQuery);

      // 3ï¸âƒ£ Cháº¿ Ä‘á»™ NEW
      if (mode === "new") {
        console.log("ğŸ†• Cháº¿ Ä‘á»™ NEW â†’ hiá»ƒn thá»‹ form chá»n quy trÃ¬nh ban Ä‘áº§u");
        document.getElementById("processSelectWrapper").classList.remove("hidden");
        const first = document.getElementById("s0r0");
        if (first) first.classList.remove("hidden");
        console.groupEnd();
        return;
      }

      // 4ï¸âƒ£ Cháº¿ Ä‘á»™ EDIT (Ä‘Æ°á»£c gá»i tá»« homepage)
      // 4ï¸âƒ£ Cháº¿ Ä‘á»™ EDIT (Ä‘Æ°á»£c gá»i tá»« homepage)
      if (mode === "edit") {
        console.log("âœï¸ Cháº¿ Ä‘á»™ EDIT tá»« sessionStorage");
        document.getElementById("processSelectWrapper").classList.add("hidden");

        if (dataStr) {
          const row = JSON.parse(dataStr);
          console.log("ğŸ“¦ Äang load selectedRow tá»« session:", row);

          // ===============================
          // ğŸ”¹ Láº¥y dá»¯ liá»‡u phá»¥ trong session
          // ===============================
          const chitiet = JSON.parse(sessionStorage.getItem("chitietData") || "{}");
          const ykien = JSON.parse(sessionStorage.getItem("ykienData") || "[]");
          const rawLuan = JSON.parse(sessionStorage.getItem("luanchuyenData") || "[]");
          const edoc = JSON.parse(sessionStorage.getItem("edocData") || "[]");

          // ===============================
          // ğŸ”¹ Chuáº©n hÃ³a luanchuyenData
          // ===============================
          const luan = rawLuan.map(raw => ({
            nguoi_gui: raw["ÄÆ¡n vá»‹ nháº­n"] || "",
            don_vi_nhan: raw["NgÆ°á»i nháº­n"] || "",
            nguoi_nhan: raw["Thá»i gian gá»­i"] || "",
            thoi_gian_gui: raw["Thá»i gian nháº­n"] || "",
            thoi_gian_nhan: raw["MÃ´i trÆ°á»ng"] || "",
            trang_thai: raw["LÃ½ do"] || "",
            ly_do: "",
            ref: raw.ref ?? ""
          }));

          console.log("ğŸ’¬ luanchuyenData (chuáº©n hÃ³a):", luan);
          setTimeout(() => {
            console.log("ğŸ” Gá»i extractPhongDauMoi sau khi Ä‘Ã£ cÃ³ luanchuyenData tháº­t:", luan.length, "dÃ²ng");
            const phong = extractPhongDauMoi(luan);
            console.log("ğŸ¢ Káº¿t quáº£ extractPhongDauMoi =", phong);
          }, 200);
          console.log("ğŸ“Š chitiet =", chitiet);
          console.log("ğŸ’¬ ykienData =", ykien.length, "| luanchuyenData =", luan.length, "| edocData =", edoc.length);

          // ===============================
          // ğŸ” TÃ¬m phÃ²ng trong luanchuyenData dá»±a theo "PhÃ²ng" + "Äáº§u má»‘i"
          let dept = "KhÃ´ng xÃ¡c Ä‘á»‹nh";

          if (Array.isArray(luan) && luan.length > 0) {
            const cleanText = s =>
              (s || "")
                .normalize("NFD")
                .replace(/[\u0300-\u036f]/g, "") // bá» dáº¥u tiáº¿ng Viá»‡t
                .replace(/\s+/g, " ") // gá»™p space, tab, xuá»‘ng dÃ²ng
                .replace(/\n/g, " ")
                .trim()
                .toLowerCase();

            console.groupCollapsed("ğŸ” Kiá»ƒm tra tá»«ng dÃ²ng tÃ¬m 'PhÃ²ng ... - Äáº§u má»‘i'");
            let matched = null;

            luan.forEach((item, i) => {
              const val = cleanText(item.nguoi_nhan);
              if (val.includes("phong") && val.includes("dau moi")) {
                matched = item;
                console.log(`âœ… [${i}] Match:`, item.nguoi_nhan);
              } else if (val.includes("phong")) {
                console.log(`âš ï¸ [${i}] CÃ³ 'phong' nhÆ°ng thiáº¿u 'dau moi':`, item.nguoi_nhan);
              } else if (val.includes("dau moi")) {
                console.log(`âš ï¸ [${i}] CÃ³ 'dau moi' nhÆ°ng thiáº¿u 'phong':`, item.nguoi_nhan);
              }
            });
            console.groupEnd();

            if (matched) {
              let raw = (matched.nguoi_nhan || "").replace(/\s+/g, " ").trim();

              // Cáº¯t ra pháº§n "PhÃ²ng ..." náº¿u cÃ³
              const found = raw.match(/(PhÃ²ng|Phong)[^-\n]+/i);
              if (found) {
                dept = found[0].replace(/Phong/i, "PhÃ²ng").trim();
              } else {
                dept = matched.don_vi_nhan?.trim() || "KhÃ´ng xÃ¡c Ä‘á»‹nh";
              }

              console.log("ğŸ¢ PhÃ²ng xÃ¡c Ä‘á»‹nh:", dept, "â†’ tá»« dÃ²ng:", matched);
            } else {
              console.warn("âš ï¸ KhÃ´ng tÃ¬m tháº¥y dÃ²ng chá»©a 'phÃ²ng' vÃ  'Ä‘áº§u má»‘i'");
            }
          } else {
            console.warn("âš ï¸ luanchuyenData khÃ´ng há»£p lá»‡:", luan);
          }

          // ğŸ”¹ Chuáº©n hÃ³a tÃªn phÃ²ng qua normalizeDept()
          dept = normalizeDept(dept);

          // ğŸ”¹ Cáº­p nháº­t giao diá»‡n
          document.getElementById("deptName").textContent = "PhÃ²ng: " + dept + " - Äáº§u má»‘i";
          console.log("âœ… Káº¿t quáº£ cuá»‘i cÃ¹ng:", dept);

          // ===============================
          // ğŸ”¹ Render báº£ng chi tiáº¿t & dá»¯ liá»‡u phá»¥
          // ===============================
          document.getElementById("detailWrapper").innerHTML =
            renderChiTiet(chitiet) +
            renderYKienTable(ykien) +
            renderLuanChuyenTable(luan);

          // ===============================
          // ğŸ”¹ Chá»n láº¡i quy trÃ¬nh chi tiáº¿t (dropdown)
          // ===============================
          setTimeout(() => {
            const quytrinhName = row.quytrinh?.trim() || "";
            if (!quytrinhName) {
              console.warn("âš ï¸ KhÃ´ng cÃ³ tÃªn quy trÃ¬nh trong row.quytrinh");
              return;
            }

            const drop = document.getElementById("processSelectChiTiet");
            const listStr = sessionStorage.getItem("processListChiTiet");

            if (!drop || !listStr) {
              console.warn("âš ï¸ ChÆ°a cÃ³ dropdown hoáº·c danh sÃ¡ch quy trÃ¬nh trong sessionStorage");
              return;
            }

            const list = JSON.parse(listStr);
            const found = list.find(
              x => x.ten.toLowerCase().trim() === quytrinhName.toLowerCase().trim()
            );

            if (found) {
              drop.value = found.maSo;
              console.log("ğŸŸ¢ Chá»n sáºµn quy trÃ¬nh:", found.ten);
              document.querySelector("h1").textContent = found.ten;

              window.processData = found.steps;
              renderProcessFromJson();
            } else {
              console.warn("âš ï¸ KhÃ´ng tÃ¬m tháº¥y quy trÃ¬nh khá»›p tÃªn:", quytrinhName);
            }
          }, 800);

          // ===============================
          // ğŸ”¹ Render quy trÃ¬nh chÃ­nh
          // ===============================
          renderProcessFromJson();

          // Náº¿u chÆ°a cÃ³ edocData â†’ import láº¡i
          if (!sessionStorage.getItem("edocData") || edoc.length === 0) {
            console.warn("âš ï¸ KhÃ´ng cÃ³ edocData trong sessionStorage â†’ tá»± import tá»« Cloud theo REF:", row.ref);
            importFromCloudByRef(row.ref);
          } else {
            console.log("âœ… CÃ³ edocData trong sessionStorage, khÃ´ng cáº§n import láº¡i");
          }

          console.groupEnd();
          return;
        }

        // ===============================
        // ğŸ”¹ Fallback khi khÃ´ng cÃ³ selectedRow
        // ===============================
        if (refQuery) {
          console.log("ğŸ” KhÃ´ng cÃ³ selectedRow â†’ láº¥y theo refQuery:", refQuery);
          document.getElementById("processSelectWrapper").classList.add("hidden");
          document.getElementById("refDisplay").textContent = "REF: " + refQuery;
          importFromCloudByRef(refQuery);
        } else {
          console.warn("âš ï¸ KhÃ´ng cÃ³ selectedRow vÃ  khÃ´ng cÃ³ refQuery â†’ khÃ´ng thá»ƒ load dá»¯ liá»‡u");
        }

        console.groupEnd();
        return;
      }


      // 5ï¸âƒ£ Máº·c Ä‘á»‹nh (auto load theo ref trÃªn URL)
      console.log("â„¹ï¸ KhÃ´ng cÃ³ mode â†’ auto load theo ref trÃªn URL náº¿u cÃ³");
      document.getElementById("processSelectWrapper").classList.add("hidden");

      if (refQuery) {
        console.log("ğŸ” Auto import theo REF trÃªn URL:", refQuery);
        document.getElementById("refDisplay").textContent = "REF: " + refQuery;
        importFromCloudByRef(refQuery);
      } else {
        console.warn("âš ï¸ KhÃ´ng cÃ³ REF trong URL â†’ trang Ä‘ang á»Ÿ tráº¡ng thÃ¡i rá»—ng");
      }

      console.groupEnd();
    });



    // ================== TOKEN ==================
    // Biáº¿n toÃ n cá»¥c lÆ°u key
    window.tokenKey = "";

    // Import Token tá»« CSV hoáº·c TXT
    function importToken(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (evt) {
        const text = evt.target.result.trim();

        const lines = text.split(/\r?\n/);
        const header = lines[0].split(",");

        const idx = header.findIndex(h => h.toUpperCase().includes("TOKEN_KEY"));
        if (idx >= 0 && lines.length > 1) {
          // láº¥y token tá»« dÃ²ng 2
          const cols = lines[1].split(",");
          window.tokenKey = cols[idx].replace(/^"|"$/g, "").trim();
        } else {
          // file chá»‰ chá»©a token dáº¡ng txt
          window.tokenKey = text.replace(/^"|"$/g, "").trim();
        }

        document.getElementById("currentToken").textContent = "ğŸ”‘ Token hiá»‡n táº¡i: " + window.tokenKey;
        alert("âœ… ÄÃ£ náº¡p TOKEN_KEY: " + window.tokenKey);
      };
      reader.readAsText(file, "utf-8");
    }

    // Encode dá»¯ liá»‡u (xuáº¥t)
    function encodeData(obj) {
      if (!window.tokenKey || window.tokenKey.trim() === "") {
        alert("âš ï¸ ChÆ°a cÃ³ TOKEN_KEY, vui lÃ²ng import trÆ°á»›c");
        return null;
      }

      try {
        // ğŸ”¹ B1: Chuá»—i JSON gá»‘c
        const jsonStr = JSON.stringify(obj);

        // ğŸ”¹ B2: GhÃ©p thÃªm TOKEN_KEY Ä‘á»ƒ xÃ¡c thá»±c
        const combined = jsonStr + "::" + window.tokenKey.trim();

        // ğŸ”¹ B3: MÃ£ hoÃ¡ Base64 (chá»‰ 1 láº§n)
        return btoa(unescape(encodeURIComponent(combined)));
      } catch (err) {
        console.error("âŒ Lá»—i encodeData:", err);
        alert("âŒ Lá»—i khi mÃ£ hoÃ¡ dá»¯ liá»‡u!");
        return null;
      }
    }


    // Decode dá»¯ liá»‡u (nháº­p)
    function decodeData(base64) {
      try {
        // LÃ m sáº¡ch chuá»—i Base64
        const clean = base64.replace(/[\r\n\s]/g, "").trim();

        // Giáº£i mÃ£ Base64 vá» máº£ng byte
        const binary = atob(clean);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          bytes[i] = binary.charCodeAt(i);
        }

        // DÃ¹ng TextDecoder Ä‘á»ƒ Ä‘á»c UTF-8 chÃ­nh xÃ¡c
        const decoder = new TextDecoder("utf-8");
        const decodedStr = decoder.decode(bytes);

        // Náº¿u chuá»—i trÃ´ng giá»‘ng JSON â†’ parse luÃ´n
        if (decodedStr.trim().startsWith("[") || decodedStr.trim().startsWith("{")) {
          return JSON.parse(decodedStr);
        }

        console.warn("âš ï¸ KhÃ´ng pháº£i JSON, tráº£ vá» chuá»—i thuáº§n");
        return decodedStr;
      } catch (err) {
        console.error("âŒ Lá»—i giáº£i mÃ£ Base64:", err);
        alert("âš ï¸ Lá»—i giáº£i mÃ£ Base64 (chuá»—i khÃ´ng há»£p lá»‡ hoáº·c sai mÃ£ hÃ³a).");
        return null;
      }
    }

    function decodeDataDouble(base64) {
      const first = decodeData(base64);
      if (typeof first === "string" && /^[A-Za-z0-9+/=]+$/.test(first)) {
        return decodeData(first);
      }
      return first;
    }



    // ================== EXPORT ==================
    function exportRawJson() {
      // Thu tháº­p toÃ n bá»™ step/sub (ká»ƒ cáº£ hidden)
      const rows = [];
      processData.forEach((step, s) => {
        step.sub.forEach((row, r) => {
          const rowId = `s${s}r${r}`;
          rows.push({
            step: step.title,
            noidung: row.noidung,
            nguoi: row.nguoi || "",
            xuly: row.xuly || "",
            cho: row.cho || "",
            res: document.getElementById(`res-${rowId}`).value || "",
            time: document.getElementById(`time-text-${rowId}`).textContent || "",
            decision: document.getElementById(`decision-${rowId}`).textContent || ""
          });
        });
      });

      // Táº¡o ref dáº¡ng BB_ddMMyyyy_hhmmss
      const now = new Date();
      const pad = n => n.toString().padStart(2, "0");
      const ref = `TCCB5.003_${pad(now.getDate())}${pad(now.getMonth() + 1)}${now.getFullYear()}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;

      // GÃ³i JSON {ref, rows}
      const output = { ref: ref, rows: rows };

      // Xuáº¥t file JSON
      const blob = new Blob([JSON.stringify(output, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = ref + ".json";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }


    // ================== IMPORT ENCODED ==================
    function importEncoded(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (evt) {
        const encoded = evt.target.result.trim();
        const data = decodeData(encoded);
        if (!data) return;
        parseDecodedToTable(data);
      };
      reader.readAsText(file, "utf-8");
    }
    function hydrateFromSharePointData(data) {
      console.groupCollapsed("ğŸ“‹ [hydrateFromSharePointData] Ãp tráº¡ng thÃ¡i tá»« SharePoint DATA");

      let arr = typeof data === "string" ? JSON.parse(data) : data;
      if (!Array.isArray(arr)) {
        console.warn("âš ï¸ DATA khÃ´ng pháº£i máº£ng há»£p lá»‡");
        return;
      }

      arr.forEach((item) => {
        const step = item.step || "";
        const sIndex = window.processData.findIndex(
          s => (s.title || s.step || "").trim().toLowerCase() === step.trim().toLowerCase()
        );
        if (sIndex < 0) return;

        const rIndex = window.processData[sIndex]?.sub?.findIndex(
          sub => (sub.noidung || "").trim() === (item.noidung || "").trim()
        );
        if (rIndex < 0) return;

        const id = `s${sIndex}r${rIndex}`;
        const tr = document.getElementById(id);
        if (!tr) return;

        // âœ… áº¨n / hiá»‡n hÃ ng
        tr.classList.toggle("hidden", !!item.hidden);

        // âœ… Äiá»n dá»¯ liá»‡u
        const res = document.getElementById(`res-${id}`);
        const timeText = document.getElementById(`time-text-${id}`);
        const decisionCell = document.getElementById(`decision-${id}`);

        if (res) {
          res.value = item.res || "";
          res.readOnly = !!item.readonly || !!item.done;
        }
        if (timeText) timeText.textContent = item.time || "";
        if (decisionCell) decisionCell.textContent = item.decision || "";

        // âœ… Xá»­ lÃ½ nhÃ³m nÃºt
        const btns = tr.querySelectorAll("button");
        const decGroup = document.getElementById(`decision-choices-${id}`);
        const decTime = document.getElementById(`decision-time-${id}`);

        if (item.done || item.readonly) {
          // áº¨n táº¥t cáº£ nhÃ³m nÃºt
          btns.forEach(b => b.classList.add("hidden"));
          decGroup?.classList.add("hidden");
          decTime?.classList.add("hidden");
        } else {
          // BÆ°á»›c decision: chá»‰ hiá»‡n nhÃ³m lá»±a chá»n
          if (item.type === "decision2" || item.type === "decision3") {
            decGroup?.classList.remove("hidden");
            decTime?.classList.add("hidden");
          } else {
            // BÆ°á»›c thÆ°á»ng
            btns.forEach(b => b.classList.remove("hidden"));
          }
        }

        // âœ… Hiá»ƒn thá»‹ biá»ƒu tÆ°á»£ng Ä‘á»“ng há»“ náº¿u cÃ³ time
        // âœ… Hiá»ƒn thá»‹ biá»ƒu tÆ°á»£ng Ä‘á»“ng há»“ náº¿u cÃ³ time vÃ  bÆ°á»›c chÆ°a hoÃ n táº¥t
        const timeIcon = document.getElementById(`time-icon-${id}`);
        if (timeIcon) {
          if (item.time && !item.done && !item.readonly) {
            timeIcon.classList.remove("hidden");
          } else {
            timeIcon.classList.add("hidden");
          }
        }

        // âœ… Má»Ÿ bÆ°á»›c káº¿ tiáº¿p náº¿u done
        if (item.done && typeof showNext === "function") {
          showNext(id, sIndex, rIndex);
        }
      });

      console.log("âœ… Hydrate hoÃ n táº¥t theo tráº¡ng thÃ¡i SharePoint");
      console.groupEnd();
    }



    // ================== APPLY DECODED DATA ==================
    // âœ… Hydrate láº¡i báº£ng inner tá»« DATA (RES/TIME/DECISION) theo Ä‘Ãºng step/sub
function parseDecodedToTable(rows) {
  console.groupCollapsed("ğŸ“‹ [parseDecodedToTable] Hydrate báº£ng inner");
  try {
    // 1ï¸âƒ£ Chuáº©n hÃ³a input
    let dataArr = rows;
    if (typeof rows === "string") {
      try {
        dataArr = JSON.parse(rows);
      } catch (e) {
        console.error("âŒ DATA khÃ´ng pháº£i JSON há»£p lá»‡:", e);
        alert("âš ï¸ Dá»¯ liá»‡u khÃ´ng há»£p lá»‡ Ä‘á»ƒ render");
        return;
      }
    }
    if (!Array.isArray(dataArr)) {
      console.warn("âš ï¸ DATA khÃ´ng pháº£i máº£ng, bá» qua");
      return;
    }

    // 2ï¸âƒ£ Báº£ng inner pháº£i tá»“n táº¡i (renderProcessFromJson Ä‘Ã£ cháº¡y)
    const table = document.querySelector("#processTable tbody");
    if (!table) {
      console.warn("âš ï¸ ChÆ°a cÃ³ báº£ng inner (#processTable) â†’ gá»i renderProcessFromJson trÆ°á»›c");
      if (typeof renderProcessFromJson === "function") renderProcessFromJson();
    }

    // 3ï¸âƒ£ Láº­p bucket id cho tá»«ng step
    const buckets = {};
    const pd = window.processData || [];
    const norm = s => (s || "").toString().trim().toLowerCase();

    pd.forEach((step, s) => {
      const key = norm(step.title || `BÆ°á»›c ${s + 1}`);
      buckets[key] = (step.sub || []).map((_, r) => ({ id: `s${s}r${r}`, s, r }));
    });

    // 4ï¸âƒ£ Hydrate tá»«ng dÃ²ng dá»¯ liá»‡u
    dataArr.forEach((rowSaved, i) => {
      const stepKey = norm(rowSaved.step);
      const bucket = buckets[stepKey] || [];
      const item = bucket.shift();
      if (!item) {
        console.warn("âš ï¸ KhÃ´ng match Ä‘Æ°á»£c id cho dÃ²ng:", rowSaved);
        return;
      }

      const { id, s, r } = item;

      // ğŸ‘‰ Má»Ÿ hÃ ng hiá»‡n táº¡i
      const tr = document.getElementById(id);
      tr?.classList.remove("hidden");

      // ğŸ‘‰ Äiá»n Káº¾T QUáº¢
      const resEl = document.getElementById(`res-${id}`);
      if (resEl && rowSaved.res) {
        resEl.value = rowSaved.res;
        resEl.readOnly = true;
      }

      // ğŸ‘‰ Äiá»n NGÃ€Y HOÃ€N THÃ€NH
      const timeTxt = document.getElementById(`time-text-${id}`);
      if (rowSaved.time) {
        if (timeTxt) timeTxt.textContent = rowSaved.time;
        document.getElementById(`time-icon-${id}`)?.classList.add("hidden");
      }

      // ğŸ‘‰ Äiá»n QUYáº¾T Äá»ŠNH (áº©n nhÃ³m button)
      const decEl = document.getElementById(`decision-${id}`);
      if (rowSaved.decision) {
        if (decEl) decEl.textContent = rowSaved.decision;
        document.getElementById(`decision-choices-${id}`)?.classList.add("hidden");
        document.getElementById(`decision-time-${id}`)?.classList.add("hidden");
      }

      // ğŸ‘‰ KhÃ³a dropdown NgÆ°á»i nháº­n & ÄÆ¡n vá»‹ nháº­n (chá»‰ xem, khÃ´ng chá»n láº¡i)
      const disableDropdowns = () => {
        const nguoiNhanSelect = document.getElementById(`nguoinhan-${id}`);
        const donViNhanSelect = document.getElementById(`donvinhan-${id}`);

        if (nguoiNhanSelect) {
          nguoiNhanSelect.disabled = true;
          nguoiNhanSelect.style.backgroundColor = "#f5f5f5";
          nguoiNhanSelect.style.color = "#555";
          nguoiNhanSelect.style.cursor = "not-allowed";
        }

        if (donViNhanSelect) {
          donViNhanSelect.disabled = true;
          donViNhanSelect.style.backgroundColor = "#f5f5f5";
          donViNhanSelect.style.color = "#555";
          donViNhanSelect.style.cursor = "not-allowed";
        }
      };

      // Ä‘áº£m báº£o DOM sáºµn sÃ ng trÆ°á»›c khi disable
      setTimeout(disableDropdowns, 300);

      // ğŸ‘‰ KhÃ³a thao tÃ¡c cá»§a hÃ ng hiá»‡n táº¡i & má»Ÿ hÃ ng káº¿ tiáº¿p
      if (typeof lockStep === "function") lockStep(id, s, r);
      if (typeof showNext === "function") showNext(id, s, r);
    });

    // 5ï¸âƒ£ Cáº­p nháº­t báº£ng tá»•ng há»£p
    if (typeof updateSummary === "function") updateSummary();

    console.log(`âœ… Hydrate xong ${dataArr.length} dÃ²ng`);
  } catch (err) {
    console.error("ğŸ’¥ parseDecodedToTable lá»—i:", err);
  } finally {
    console.groupEnd();
  }
}


    //Send to SharePoint via Power Automate
    // ================== EXPORT CLOUD ==================
    function normalizeDept(rawDept = "") {
      if (!rawDept) return "";

      let dept = rawDept
        .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // bá» dáº¥u tiáº¿ng Viá»‡t
        .toLowerCase()
        .replace(/[()\-â€“_]/g, " ") // bá» kÃ½ tá»± Ä‘áº·c biá»‡t
        .replace(/\s+/g, " ")
        .trim();

      if (dept.includes("to chuc tien luong") || dept.includes("tien luong tccb"))
        return "PhÃ²ng Tá»• chá»©c tiá»n lÆ°Æ¡ng";
      if (dept.includes("thi dua") || dept.includes("khen thuong"))
        return "PhÃ²ng Thi Ä‘ua - Khen thÆ°á»Ÿng";
      if (dept.includes("can bo dia phuong") || dept.includes("dia phuong"))
        return "PhÃ²ng CÃ¡n bá»™ Ä‘á»‹a phÆ°Æ¡ng";
      if (dept.includes("dao tao") || dept.includes("nguon nhan luc") || dept.includes("phat trien"))
        return "PhÃ²ng ÄÃ o táº¡o vÃ  PhÃ¡t triá»ƒn nguá»“n nhÃ¢n lá»±c";
      if (dept.includes("to chuc can bo") || dept.includes("tccb"))
        return "Vá»¥ Tá»• chá»©c cÃ¡n bá»™";

      console.warn("âš ï¸ Dept chÆ°a mapping:", rawDept);
      return rawDept.trim();
    }


    // âœ… HÃ m gá»­i dá»¯ liá»‡u sang SharePoint (cÃ³ normalizeDept)
async function sendToSharePoint() {
  console.groupCollapsed("ğŸ“¤ [sendToSharePoint] Gá»­i dá»¯ liá»‡u sang SharePoint...");

  try {
    const rows = [];

    processData.forEach((step, s) => {
      step.sub.forEach((row, r) => {
        const rowId = `s${s}r${r}`;
        const rowEl = document.getElementById(rowId);
        const resInput = document.getElementById(`res-${rowId}`);
        const timeText = document.getElementById(`time-text-${rowId}`);
        const decisionText = document.getElementById(`decision-${rowId}`);

        // âœ… ThÃªm cáº£ dropdown ngÆ°á»i nháº­n & Ä‘Æ¡n vá»‹ nháº­n
        const nguoiSelect = document.getElementById(`nguoinhan-${rowId}`);
        const donviSelect = document.getElementById(`donvinhan-${rowId}`);

        const isHidden = rowEl?.classList.contains("hidden") || false;
        const isDone = !!(timeText?.textContent || decisionText?.textContent);
        const isReadOnly = resInput?.readOnly || false;

        rows.push({
          step: step.title,
          noidung: row.noidung || "",
          nguoi: row.nguoi || "",
          nguoinhan: nguoiSelect?.value || row.nguoinhan || "", // âœ… ngÆ°á»i nháº­n dropdown
          donvinhan: donviSelect?.value || row.donvinhan || "", // âœ… Ä‘Æ¡n vá»‹ nháº­n dropdown
          xuly: row.xuly || "",
          cho: row.cho || "",
          res: resInput?.value || "",
          time: timeText?.textContent || "",
          decision: decisionText?.textContent || "",
          hidden: isHidden,
          readonly: isReadOnly,
          done: isDone
        });
      });
    });

    // ğŸ”¹ REF giá»¯ láº¡i náº¿u Ä‘ang EDIT
    let ref = null;
    const selectedRow = sessionStorage.getItem("selectedRow");
    if (selectedRow) {
      try {
        const parsed = JSON.parse(selectedRow);
        if (parsed.ref) ref = parsed.ref;
      } catch (err) {
        console.warn("âš ï¸ selectedRow parse lá»—i:", err);
      }
    }

    // ğŸ”¹ Náº¿u chÆ°a cÃ³ REF â†’ táº¡o má»›i
    if (!ref) {
      const now = new Date();
      const pad = n => n.toString().padStart(2, "0");
      ref = `TCCB5.003_${pad(now.getDate())}${pad(now.getMonth() + 1)}${now.getFullYear()}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
    }

    // ğŸ”¹ Láº¥y vÃ  quy chuáº©n phÃ²ng ban
    let deptRaw = document.getElementById("deptName")?.textContent.trim() || "";
    deptRaw = deptRaw.replace(/^PhÃ²ng:\s*/i, "");
    if (!deptRaw.includes("PhÃ²ng") && !deptRaw.includes("Vá»¥")) {
      const match = deptRaw.match(/^(.*?)(?=(\s-\s(Äáº§u má»‘i|Phá»‘i há»£p|Chá»§ trÃ¬))|$)/i);
      deptRaw = match ? match[0].trim() : deptRaw.trim();
    } else {
      deptRaw = deptRaw.trim();
    }
    deptRaw = deptRaw.replace(/\s{2,}/g, " ");
    if (!deptRaw) deptRaw = "KhÃ´ng xÃ¡c Ä‘á»‹nh";

    const dept = normalizeDept(deptRaw);
    console.log("ğŸ¢ PhÃ²ng ban xÃ¡c Ä‘á»‹nh:", dept);

    // ğŸ”¹ ThÃ´ng tin quy trÃ¬nh
    const drop = document.getElementById("processSelectChiTiet");
    const quytrinhCode = drop?.value || "";
    const quytrinhName = drop?.selectedOptions?.[0]?.textContent?.trim() || "";

    if (!quytrinhCode) {
      alert("âš ï¸ Vui lÃ²ng chá»n quy trÃ¬nh trÆ°á»›c khi gá»­i lÃªn SharePoint!");
      console.groupEnd();
      return;
    }

    // âœ… Payload cuá»‘i cÃ¹ng
    const payload = {
      REF: ref,
      DEPT: dept,
      QUYTRINH_CODE: quytrinhCode,
      QUYTRINH_NAME: quytrinhName,
      DATA: rows,
      savedAt: new Date().toISOString()
    };

    console.log("ğŸ“¦ Payload gá»­i SharePoint:", payload);

    const flowUrl =
      "https://default460cecfbf0c64dd7a5ec66ef4d75ae.63.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/16754f7e54a04f2e9b8fb60caaaf33b4/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=aXhGTYEd9zepjAkPLtbU1nJvzosQwgmJlylq7riqiwA";

    const res = await fetch(flowUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      console.log("âœ… Gá»­i thÃ nh cÃ´ng:", await res.text());
      alert("âœ… ÄÃ£ gá»­i dá»¯ liá»‡u trá»±c tiáº¿p sang SharePoint!");
      sessionStorage.removeItem("mode");
      window.close();
    } else {
      const text = await res.text();
      console.error("âŒ Lá»—i HTTP:", res.status, text);
      alert(`âŒ Lá»—i khi gá»­i: ${res.status} - ${text}`);
    }
  } catch (err) {
    console.error("ğŸ’¥ Lá»—i khi gá»­i sang Flow:", err);
    alert("âŒ KhÃ´ng thá»ƒ gá»­i dá»¯ liá»‡u: " + err.message);
  } finally {
    console.groupEnd();
  }
}





    // âœ… Import tá»« Cloud (láº¥y danh sÃ¡ch quy trÃ¬nh SharePoint vÃ  fill dropdown) â€” cÃ³ log chi tiáº¿t
    async function importFromCloud() {
      if (!window.tokenKey || window.tokenKey.trim() === "") {
        alert("âš ï¸ Báº¡n pháº£i import TOKEN_KEY trÆ°á»›c!");
        return;
      }

      console.group("ğŸŒ importFromCloud");

      try {
        console.log("ğŸ”¹ [STEP 1] Gá»i Flow Power Automate...");
        const FLOW_URL =
          "https://default460cecfbf0c64dd7a5ec66ef4d75ae.63.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/835980df6c0a4b5892289dcbc334ef50/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=YJ4F3Gm_-Z5fPBUfteIeNr5YK-Kg_6C3OyKIvqXfj1M";

        // âš ï¸ Náº¿u Flow cá»§a báº¡n dÃ¹ng Manual Trigger, thá»­ GET; náº¿u HTTP Request thÃ¬ Ä‘á»•i thÃ nh POST
        const res = await fetch(FLOW_URL, {
          method: "GET",
          headers: {
            "Content-Type": "application/json"
          }
        });

        console.log("ğŸ”¹ [STEP 2] HTTP status:", res.status, res.statusText);
        console.log("ğŸ”¹ [STEP 3] Response headers:", Object.fromEntries(res.headers.entries()));

        // ğŸ“¦ Thá»­ Ä‘á»c raw text Ä‘á»ƒ xem Flow tráº£ vá» gÃ¬
        const raw = await res.text();
        console.log("ğŸ“¦ [STEP 4] Raw response:", raw.slice(0, 500), raw.length > 500 ? "..." : "");

        if (!res.ok) {
          console.error("âŒ [ERROR] Flow tráº£ mÃ£ lá»—i:", res.status);
          throw new Error(`HTTP ${res.status} - ${res.statusText}`);
        }

        // ğŸ§© Thá»­ parse JSON (ká»ƒ cáº£ khi double encoded)
        let data;
        try {
          data = JSON.parse(raw);
        } catch (e1) {
          try {
            data = JSON.parse(JSON.parse(raw));
          } catch (e2) {
            console.error("âŒ [ERROR] KhÃ´ng parse Ä‘Æ°á»£c JSON:", e1, e2);
            throw new Error("Flow khÃ´ng tráº£ vá» JSON há»£p lá»‡.");
          }
        }

        console.log("âœ… [STEP 5] ÄÃ£ parse JSON, tá»•ng sá»‘ quy trÃ¬nh:", Array.isArray(data) ? data.length : 0);
        console.log("ğŸ”¸ [SAMPLE ITEM]", data[0]);

        if (!Array.isArray(data) || data.length === 0) {
          alert("âš ï¸ KhÃ´ng cÃ³ dá»¯ liá»‡u quy trÃ¬nh tráº£ vá» tá»« Cloud.");
          console.groupEnd();
          return;
        }

        // ğŸ”¹ Chuáº©n hÃ³a dá»¯ liá»‡u
        const list = data.map(item => ({
          maSo: item["MÃƒ Sá»"] || item["MASO"] || "",
          ten: (item["TÃŠN QUY TRÃŒNH"] || item["TENQUYTRINH"] || item["QUYTRINH_NAME"] || "").trim(),
          QUYTRINH_NAME: (item["QUYTRINH_NAME"] || item["TÃŠN QUY TRÃŒNH"] || item["TENQUYTRINH"] || "").trim(),
          steps: (() => {
            let rawSteps = item["STEP QUY TRÃŒNH"] || item["CAYQUYTRINH"] || "[]";
            try {
              const parsed = JSON.parse(rawSteps);
              return Array.isArray(parsed) ? parsed : JSON.parse(parsed);
            } catch (e) {
              console.warn("âš ï¸ [STEP parse lá»—i]", e);
              return [];
            }
          })()
        }));

        console.log("âœ… [STEP 6] Chuáº©n hÃ³a xong:", list.length, "items");
        sessionStorage.setItem("processListChiTiet", JSON.stringify(list));

        // ğŸ”¹ Fill dropdown
        const select = document.getElementById("processSelectChiTiet");
        if (!select) {
          alert("âš ï¸ KhÃ´ng tÃ¬m tháº¥y dropdown #processSelectChiTiet trÃªn trang!");
          console.groupEnd();
          return;
        }

        select.innerHTML = `<option value="">-- Chá»n quy trÃ¬nh --</option>`;
        list.forEach(q => {
          const opt = document.createElement("option");
          opt.value = q.maSo;
          opt.textContent = q.QUYTRINH_NAME || q.ten || q.maSo;
          select.appendChild(opt);
        });
        console.log("âœ… [STEP 7] ÄÃ£ fill dropdown thÃ nh cÃ´ng.");

        // ğŸ”¹ Khi ngÆ°á»i dÃ¹ng chá»n thá»§ cÃ´ng
        select.onchange = e => {
          const maSo = e.target.value;
          if (!maSo) return;
          const found = list.find(x => x.maSo === maSo);
          if (!found) return;

          const h1 = document.querySelector("h1");
          if (h1) h1.textContent = found.QUYTRINH_NAME || found.ten || found.maSo;

          window.processData = found.steps;
          renderProcessFromJson();
        };

        // ğŸ”¹ Náº¿u cÃ³ record Ä‘ang edit â†’ auto chá»n
        const selectedRow = sessionStorage.getItem("selectedRow");
        if (selectedRow) {
          try {
            const row = JSON.parse(selectedRow);
            console.log("ğŸ”¹ [STEP 8] Äang auto chá»n quy trÃ¬nh cho record:", row.QUYTRINH_NAME);
            autoSelectProcessChiTiet(row);
          } catch (err) {
            console.warn("âš ï¸ Lá»—i parse selectedRow:", err);
          }
        }

        alert("âœ… ÄÃ£ import dá»¯ liá»‡u quy trÃ¬nh tá»« Cloud!");
      } catch (err) {
        console.error("âŒ [ERROR importFromCloud]:", err);
        alert("âŒ Lá»—i khi import tá»« Cloud: " + err.message);
      } finally {
        console.groupEnd();
      }
    }


    renderProcessFromJson();
    // HÃ m khÃ³a row eDoc (áº©n nÃºt, readonly)
    function lockEdocRow(id) {
      document.getElementById(`time-icon-${id}`)?.classList.add("hidden");

      document.querySelectorAll(`#${id} .btn-next`).forEach(btn => btn.classList.add("hidden"));
      document.getElementById(`res-${id}`)?.setAttribute("readonly", true);
    }



    document.addEventListener("DOMContentLoaded", () => {
      const result = fillStepsFromEdoc(edocData, nhanSuPhong);

      // VÄƒn thÆ° (1 record duy nháº¥t)
      if (result.vanThu) {
        const id = "s0r0";
        document.getElementById(id).classList.remove("hidden");
        document.getElementById(`time-text-${id}`).textContent = result.vanThu.thoi_gian;
        document.getElementById(`ngaygui-${id}`).textContent = result.vanThu.thoi_gian;
        document.getElementById(`nguoigui-${id}`).textContent = result.vanThu.nguoi_gui;
        document.getElementById(`nguoinhan-${id}`).textContent = result.vanThu.nguoi_nhan;
        document.getElementById(`donvinhan-${id}`).textContent = result.vanThu.don_vi_nhan;

        lockEdocRow(id);
        showNext(id, 0, 0);
      }

      // LÃ£nh Ä‘áº¡o Vá»¥ (nhiá»u ngÆ°á»i â†’ clone nhiá»u row)
      if (result.lanhDaoVu.length > 0) {
        const tbody = document.querySelector("#processTable tbody");
        const templateRow = document.getElementById("s0r1");

        result.lanhDaoVu.forEach((c, idx) => {
          const rowId = `s0r1r${idx}`;
          const row = document.createElement("tr");
          row.id = rowId;

          row.innerHTML = `
      <td>${c.noidung || "Xá»­ lÃ½ Tá» trÃ¬nh"}</td>
      <td>${c.chuc_vu || "LÃ£nh Ä‘áº¡o Vá»¥"}</td>
      <td id="ngaygui-${rowId}">${c.thoi_gian || ""}</td>
      <td id="nguoigui-${rowId}">${c.nguoi_gui || ""}</td>
      <td id="nguoinhan-${rowId}">${c.nguoi_nhan || ""}</td>
      <td id="donvinhan-${rowId}">${c.don_vi_nhan || ""}</td>
      <td>01 ngÃ y</td>
      <td></td>
      <td></td>
      <td><textarea class="result-input" id="res-${rowId}" readonly placeholder="Nháº­p káº¿t quáº£"></textarea></td>
      <td><span id="time-text-${rowId}">${c.thoi_gian || ""}</span></td>
      <td id="decision-${rowId}"></td>
    `;

          tbody.insertBefore(row, templateRow.nextSibling);
          row.classList.remove("hidden");   // ğŸ‘ˆ Ä‘áº£m báº£o hiá»‡n ra
          lockEdocRow(rowId);
        });

        // áº¨n dÃ²ng gá»‘c s0r1 (chá»‰ lÃ m template)
        templateRow.classList.add("hidden");

        // ğŸ‘‰ má»Ÿ tiáº¿p bÆ°á»›c sau dá»±a trÃªn timestamp má»›i nháº¥t
        const lastTime = result.lanhDaoVu
          .map(c => parseVNDate(c.thoi_gian))
          .filter(Boolean)
          .reduce((a, b) => a > b ? a : b);

        if (lastTime) {
          showNext("s0r1r" + (result.lanhDaoVu.length - 1), 0, 1);
        }
      }

      // LÃ£nh Ä‘áº¡o PhÃ²ng (1 record duy nháº¥t)
      if (result.lanhDaoPhong) {
        const id = "s0r2";
        document.getElementById(id).classList.remove("hidden");
        document.getElementById(`time-text-${id}`).textContent = result.lanhDaoPhong.thoi_gian;
        document.getElementById(`ngaygui-${id}`).textContent = result.lanhDaoPhong.thoi_gian;
        document.getElementById(`nguoigui-${id}`).textContent = result.lanhDaoPhong.nguoi_gui;
        document.getElementById(`nguoinhan-${id}`).textContent = result.lanhDaoPhong.nguoi_nhan;
        document.getElementById(`donvinhan-${id}`).textContent = result.lanhDaoPhong.don_vi_nhan;

        lockEdocRow(id);
        showNext(id, 0, 2);
      }

      // CÃ´ng chá»©c phá»¥ trÃ¡ch (nhiá»u ngÆ°á»i â†’ clone nhiá»u row)
      cloneRowsFromArray(result.congChuc, "s0r3", "CÃ´ng chá»©c phá»¥ trÃ¡ch", "0,5 ngÃ y", 0, 3);
    });
    function completeStepNow(id, s, r) {
      const now = new Date();
      const last = getLastTimeBefore(s, r);
      if (last && now <= last) {
        alert("âŒ Thá»i gian pháº£i lá»›n hÆ¡n cÃ¡c bÆ°á»›c trÆ°á»›c!");
        return;
      }

      document.getElementById(`time-${id}`).value = now.toISOString().slice(0, 16);
      document.getElementById(`time-text-${id}`).textContent = formatDate(now);

      // KhÃ´ng add hidden cho tá»«ng nÃºt, chá»‰ áº©n cá»¥m cha náº¿u cÃ³
      document.getElementById(`time-icon-${id}`)?.classList.add("hidden");

      lockStep(id, s, r);
      showNext(id, s, r);
    }


    function completeStepManual(id, s, r) {
      const inp = document.getElementById(`time-${id}`);
      if (inp.showPicker) {
        inp.showPicker();  // báº­t lá»‹ch chá»n
      } else {
        inp.click();       // fallback cho browser khÃ¡c
      }
    }

    function decisionStepNow(id, s, r) {
      console.groupCollapsed(`[decisionStepNow] id=${id}, s=${s}, r=${r}`);

      const isPositive =
        document.getElementById(`decision-${id}`).dataset.choice === "PhÃ¹ há»£p" ||
        document.getElementById(`decision-${id}`).dataset.choice === "Thá»‘ng nháº¥t";

      const now = new Date();
      const last = getLastTimeBefore(s, r);
      if (last && now <= last) {
        alert("âŒ Thá»i gian pháº£i lá»›n hÆ¡n cÃ¡c bÆ°á»›c trÆ°á»›c!");
        console.groupEnd();
        return;
      }

      // cáº­p nháº­t thá»i gian
      document.getElementById(`time-${id}`).value = now.toISOString().slice(0, 16);
      document.getElementById(`time-text-${id}`).textContent = formatDate(now);

      // chá»‰ áº©n cá»¥m cha (khÃ´ng add hidden vÃ o tá»«ng nÃºt)
      document.getElementById(`decision-time-${id}`)?.classList.add("hidden");

      finishDecision(id, s, r, isPositive);
      console.groupEnd();
    }


    function finishDecision(id, s, r, isPositive) {
      console.groupCollapsed(`[finishDecision] id=${id}, s=${s}, r=${r}, isPositive=${isPositive}`);

      const row = processData[s]?.sub?.[r] || {};
      const stepType = row.type || "";

      // ğŸ§© Æ¯u tiÃªn láº¥y text tá»« buttons trong data náº¿u cÃ³
      const buttons = row.buttons && Array.isArray(row.buttons) && row.buttons.length >= 2
        ? row.buttons
        : stepType === "decision3"
          ? ["Thá»‘ng nháº¥t", "ChÆ°a thá»‘ng nháº¥t"]
          : ["PhÃ¹ há»£p", "ChÆ°a phÃ¹ há»£p"];

      // ğŸ§  Láº¥y lá»±a chá»n thá»±c táº¿ (Æ°u tiÃªn dataset.choice)
      const decisionEl = document.getElementById(`decision-${id}`);
      const choiceText = decisionEl?.dataset.choice || (isPositive ? buttons[0] : buttons[1]);

      // ğŸ”¹ Cáº­p nháº­t hiá»ƒn thá»‹ quyáº¿t Ä‘á»‹nh
      if (decisionEl) {
        decisionEl.textContent = choiceText;
        decisionEl.classList.add("locked");
      }

      // ğŸ”¹ áº¨n cá»¥m chá»n thá»i gian (â±ğŸ“…)
      document.getElementById(`decision-time-${id}`)?.classList.add("hidden");

      // ğŸ”¹ KhÃ³a ná»™i dung pháº£n há»“i
      document.getElementById(`res-${id}`)?.setAttribute("readonly", true);

      // ğŸ”¹ LÆ°u láº¡i quyáº¿t Ä‘á»‹nh vÃ  thá»i gian vÃ o data
      row.decision = choiceText;
      row.time = new Date().toLocaleString("vi-VN");

      // ğŸ”¹ Má»Ÿ bÆ°á»›c káº¿ tiáº¿p
      if (isPositive) {
        // má»Ÿ bÆ°á»›c Ä‘áº§u tiÃªn cá»§a step káº¿ tiáº¿p
        document.getElementById(`s${s + 1}r0`)?.classList.remove("hidden");
      } else {
        // má»Ÿ dÃ²ng káº¿ trong cÃ¹ng step
        document.getElementById(`s${s}r${r + 1}`)?.classList.remove("hidden");
      }

      updateSummary();
      console.log(`âœ… [Finish Decision] ${choiceText}`);
      console.groupEnd();
    }




    function decisionStepManual(id, s, r, isPositive) {
      const inp = document.getElementById(`time-${id}`);
      inp.dataset.decision = isPositive;
      if (inp.showPicker) {
        inp.showPicker();
      } else {
        inp.click();
      }
    }
    // ğŸ§© Khi trang load, tá»± Ä‘á»™ng láº¥y ?ref=... trÃªn URL vÃ  gá»i importFromCloudByRef
    document.addEventListener("DOMContentLoaded", () => {
      const urlParams = new URLSearchParams(window.location.search);
      const ref = urlParams.get("ref") || "";

      console.log("ğŸš€ DOM ready â†’ REF =", ref);
      if (ref) {
        importFromCloudByRef(ref);
      } else {
        console.warn("âš ï¸ KhÃ´ng cÃ³ ref trong URL, bá» qua importFromCloudByRef()");
      }
    });

    window.addEventListener("DOMContentLoaded", () => {
      // ğŸ§© Láº¥y dá»¯ liá»‡u tá»« sessionStorage
      const row = JSON.parse(sessionStorage.getItem("selectedRow") || "{}");
      const chitiet = JSON.parse(sessionStorage.getItem("chitietData") || "{}");
      const ykien = JSON.parse(sessionStorage.getItem("ykienData") || "[]");
      const luanchuyen = JSON.parse(sessionStorage.getItem("luanchuyenData") || "[]");

      console.log("ğŸ“¦ Nháº­n dá»¯ liá»‡u tá»« homepage:", { row, chitiet, ykien, luanchuyen });

      // ğŸ¢ GÃ¡n REF hiá»ƒn thá»‹
      const refEl = document.getElementById("refDisplay");
      if (refEl) {
        refEl.textContent = `REF: ${row.ref || chitiet.stt || "â€”"}`;
      }

      // ğŸ¢ GÃ¡n phÃ²ng ban hiá»ƒn thá»‹ (Æ°u tiÃªn row.dept, fallback tá»« luanchuyen)
      const deptEl = document.getElementById("deptName");
      if (deptEl) {
        const deptText = row.dept || extractPhongDauMoi(luanchuyen) || "â€”";
        deptEl.textContent = `PhÃ²ng: ${deptText}`;
      }

      // LÆ°u global náº¿u cáº§n dÃ¹ng tiáº¿p
      window.currentRow = row;
      window.currentChitiet = chitiet;
      window.currentYkien = ykien;
      window.currentLuanchuyen = luanchuyen;
    });

    /** ğŸ§  HÃ m tÃ¬m 'PhÃ²ng Ä‘áº§u má»‘i' trong dá»¯ liá»‡u luÃ¢n chuyá»ƒn */
    // helper: normalize like báº¡n muá»‘n (giá»¯ cÃ¡c mapping cÅ©)
    function normalizeToSharePointDept(raw = "") {
      if (!raw) return "";

      const txt = raw
        .toLowerCase()
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "") // bá» dáº¥u
        .replace(/[()\-â€“_]/g, " ")
        .replace(/\s+/g, " ")
        .trim();

      if (txt.includes("to chuc tien luong") || txt.includes("tien luong tccb"))
        return "PhÃ²ng Tá»• chá»©c tiá»n lÆ°Æ¡ng";
      if (txt.includes("thi dua") || txt.includes("khen thuong"))
        return "PhÃ²ng Thi Ä‘ua - Khen thÆ°á»Ÿng";
      if (txt.includes("can bo dia phuong") || txt.includes("dia phuong"))
        return "PhÃ²ng CÃ¡n bá»™ Ä‘á»‹a phÆ°Æ¡ng";
      if (txt.includes("dao tao") || txt.includes("nguon nhan luc") || txt.includes("phat trien"))
        return "PhÃ²ng ÄÃ o táº¡o vÃ  PhÃ¡t triá»ƒn nguá»“n nhÃ¢n lá»±c";
      if (txt.includes("to chuc can bo") || txt.includes("tccb"))
        return "Vá»¥ Tá»• chá»©c cÃ¡n bá»™";

      return raw.trim();
    }

    // tÃ¬m "PhÃ²ng ... - Äáº§u má»‘i" trong luanchuyen array
    function extractPhongDauMoi(luanchuyenData) {
      console.group("[extractPhongDauMoi] Debug chi tiáº¿t");

      let dept = "KhÃ´ng xÃ¡c Ä‘á»‹nh";

      if (Array.isArray(luanchuyenData)) {
        console.log(`ğŸ” Báº¯t Ä‘áº§u quÃ©t ${luanchuyenData.length} dÃ²ng luanchuyenData`);

        for (let i = 0; i < luanchuyenData.length; i++) {
          const item = luanchuyenData[i];
          const raw =
            item.nguoi_nhan ||
            item["NgÆ°á»i nháº­n"] ||
            item["Thá»i gian gá»­i"] ||
            item["ÄÆ¡n vá»‹ nháº­n"] ||
            "";

          const val = raw
            .normalize("NFD")
            .replace(/[\u0300-\u036f]/g, "")
            .replace(/Ä‘/g, "d")
            .replace(/Ä/g, "D")
            .replace(/\s+/g, " ")
            .trim()
            .toLowerCase();

          console.log(`ğŸ” [${i}] raw="${raw}" â†’ val="${val}"`);

          // ğŸ¯ Náº¿u cÃ³ "phong" vÃ  "dau moi"
          if (val.includes("phong") && val.includes("dau moi")) {
            console.log(`âœ… Khá»›p táº¡i [${i}] ${raw}`);

            // ğŸ§© Regex má»Ÿ rá»™ng Ä‘á»ƒ láº¥y toÃ n cá»¥m "PhÃ²ng ... (TCCB)"
            const found =
              raw.match(/(PhÃ²ng|Phong)[^â€“â€”-]+(?:\(TCCB\))?/i)?.[0] ||
              raw.match(/(PhÃ²ng|Phong)[^â€“â€”-]+/i)?.[0];

            if (found) {
              dept = found
                .replace(/Phong/i, "PhÃ²ng")
                .replace(/\s{2,}/g, " ")
                .trim();
              break;
            }
          }

          // ğŸ” fallback: náº¿u cÃ³ "TCCB" hoáº·c "Tien luong"
          if (val.includes("tccb") || val.includes("tien luong")) {
            const found =
              raw.match(/(PhÃ²ng|Phong)[^â€“â€”-]+/i)?.[0] ||
              raw.match(/(PhÃ²ng|Phong)[^(]+/i)?.[0];
            if (found) {
              dept = found.replace(/Phong/i, "PhÃ²ng").trim();
              console.log(`âš™ï¸ Fallback match táº¡i [${i}] â†’ ${dept}`);
              break;
            }
          }
        }
      }

      console.log("ğŸ Káº¿t quáº£ cuá»‘i cÃ¹ng:", dept);
      console.groupEnd();
      return dept;
    }
    // Ä‘á»c sessionStorage vÃ  cáº­p nháº­t DOM
    window.addEventListener("DOMContentLoaded", () => {
      console.group("âš™ï¸ DOMContentLoaded (detail page)");
      const selectedRaw = sessionStorage.getItem("selectedRow");
      const row = selectedRaw ? JSON.parse(selectedRaw) : {};
      console.log("ğŸ§¾ selectedRow:", row);

      // Æ°u tiÃªn láº¥y luanchuyenData tá»« selectedRow, fallback tá»« key riÃªng
      const luanchuyen = row.luanchuyenData || JSON.parse(sessionStorage.getItem("luanchuyenData") || "[]");
      console.log("ğŸ“¦ luanchuyenData (effective):", luanchuyen);

      // hiá»ƒn thá»‹ REF
      const refEl = document.getElementById("refDisplay");
      const refVal = row.ref || (row.chitietData && row.chitietData.stt) || "â€”";
      if (refEl) refEl.textContent = `REF: ${refVal}`;

      // hiá»ƒn thá»‹ PHÃ’NG
      const deptEl = document.getElementById("deptName");
      if (deptEl) {
        const phong = extractPhongDauMoi(luanchuyen);
        deptEl.textContent = `PhÃ²ng: ${phong || "â€”"}`;
      } else {
        console.warn("âš ï¸ KhÃ´ng tÃ¬m tháº¥y pháº§n tá»­ #deptName trÃªn trang");
      }

      console.groupEnd();
    });


  </script>
</body>

</html>