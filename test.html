<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>CHI TI·∫æT QUY TR√åNH X·ª¨ L√ù</title>
  <style>
    :root {
      --bg: #ffffff;
      --nav: #f4ebdd;
      --text: #222;
      --card: #ffffff;
      --muted: #555;
      --accent: #a87d48;
      --accent-2: #d27d2d;
      --radius: 12px;
      --shadow: 0 4px 18px rgba(0, 0, 0, .08);
    }

    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .navbar {
      background: linear-gradient(180deg, var(--nav) 0%, #ffffff 100%);
      color: var(--text);
      height: 80px;
      padding: 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
    }

    .logo img {
      height: 80px;
      object-fit: contain;
    }

    .dept {
      font-size: 14px;
      font-weight: 500;
    }

    .container {
      max-width: 1600px;
      margin: 30px auto;
      padding: 0 20px;
    }

    h1 {
      margin: 20px 0;
      font-size: 22px;
    }

    select {
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: var(--card);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow: hidden;
      margin-top: 20px;
      table-layout: fixed;
    }

    /* ================== B·∫£ng quy tr√¨nh 12 c·ªôt ================== */
    #processTable th,
    #processTable td {
      border: 1px solid #eee;
      padding: 8px;
      font-size: 14px;
      vertical-align: top;
      word-wrap: break-word;
      text-align: left;
    }

    #processTable th {
      background: #f9f6f0;
      color: var(--text);
      font-weight: 600;
    }

    /* C·ªôt 1: N·ªôi dung th·ª±c hi·ªán */
    #processTable th:nth-child(1),
    #processTable td:nth-child(1) {
      width: 16%;
    }

    /* C·ªôt 2: Ng∆∞·ªùi th·ª±c hi·ªán/Ph√™ duy·ªát */
    #processTable th:nth-child(2),
    #processTable td:nth-child(2) {
      width: 10%;
    }

    /* C·ªôt 3: Ng√†y g·ª≠i */
    #processTable th:nth-child(3),
    #processTable td:nth-child(3) {
      width: 10%;
    }

    /* C·ªôt 4: Ng∆∞·ªùi g·ª≠i */
    #processTable th:nth-child(4),
    #processTable td:nth-child(4) {
      width: 10%;
    }

    /* C·ªôt 5: Ng∆∞·ªùi nh·∫≠n */
    #processTable th:nth-child(5),
    #processTable td:nth-child(5) {
      width: 10%;
    }

    /* C·ªôt 6: ƒê∆°n v·ªã nh·∫≠n */
    #processTable th:nth-child(6),
    #processTable td:nth-child(6) {
      width: 10%;
    }

    /* C·ªôt 7: Th·ªùi gian x·ª≠ l√Ω */
    #processTable th:nth-child(7),
    #processTable td:nth-child(7) {
      width: 7%;
      text-align: center;
    }

    /* C·ªôt 8: Th·ªùi gian ch·ªù */
    #processTable th:nth-child(8),
    #processTable td:nth-child(8) {
      width: 7%;
      text-align: center;
    }

    /* C·ªôt 9: VƒÉn b·∫£n d·ª± th·∫£o */
    #processTable th:nth-child(9),
    #processTable td:nth-child(9) {
      width: 8%;
    }

    /* C·ªôt 10: K·∫øt qu·∫£ */
    #processTable th:nth-child(10),
    #processTable td:nth-child(10) {
      width: 12%;
    }

    /* C·ªôt 11: Ng√†y ho√†n th√†nh */
    #processTable th:nth-child(11),
    #processTable td:nth-child(11) {
      width: 12%;
    }

    /* C·ªôt 12: Quy·∫øt ƒë·ªãnh */
    #processTable th:nth-child(12),
    #processTable td:nth-child(12) {
      width: 8%;
      text-align: center;
    }

    textarea.result-input {
      width: 100%;
      min-height: 80px;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 6px;
      resize: vertical;
      font-family: "Segoe UI", sans-serif;
      font-size: 14px;
    }

    .btn {
      margin-top: 6px;
      padding: 6px 12px;
      border: 0;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      color: #fff;
    }

    .btn-next {
      background: var(--accent);
    }

    .btn-edit {
      background: var(--accent-2);
    }

    .btn:hover {
      opacity: 0.9;
    }

    tr.hidden {
      display: none;
    }

    /* H√†ng ti√™u ƒë·ªÅ b∆∞·ªõc */
    .step-title td {
      background: #f2eee7;
      font-weight: 700;
      text-align: center !important;
      /* √©p cƒÉn gi·ªØa */
      font-size: 15px;
      padding: 10px;
      color: #222;
    }

    .hidden {
      display: none !important;
    }

    .actions {
      margin: 20px 0;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .actions button {
      background: #2196f3;
      color: #fff;
      border: 0;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
    }

    .actions button:hover {
      opacity: 0.9;
    }

    #summaryTable {
      margin-top: 20px;
      border-collapse: collapse;
      width: 100%;
      background: #fafafa;
    }

    #summaryTable th,
    #summaryTable td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    #summaryTable th {
      background: #eee;
    }

    input[type="datetime-local"] {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: "Segoe UI", sans-serif;
      font-size: 14px;
      background: #fff;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    input[type="datetime-local"]:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 3px var(--accent);
    }

    .time-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .time-input {
      position: absolute;
      width: 1px;
      height: 1px;
      opacity: 0;
      pointer-events: none;
      /* ·∫©n kh·ªèi user click tr·ª±c ti·∫øp */
    }

    .time-icon {
      cursor: pointer;
      font-size: 18px;
      color: goldenrod;
      /* v√†ng */
      margin-top: 4px;
      display: inline-block;
    }

    .time-icon:hover {
      opacity: 0.8;
    }

    #processTable td span {
      display: block;
      font-size: 13px;
      color: #555;
      margin-top: 2px;
    }

    .actions {
      margin: 20px 0;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .actions button,
    .actions label.icon-btn {
      background: #2196f3;
      color: #fff;
      border: 0;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      /* icon to r√µ */
      line-height: 1;
      text-align: center;
    }

    .actions button:hover,
    .actions label.icon-btn:hover {
      opacity: 0.85;
    }

    /* ================== EDOC BLOCK ================== */
    .edoc-block {
      margin-top: 20px;
      border: 1px solid #eee;
      background: #fff;
      font-family: "Segoe UI", sans-serif;
      font-size: 14px;
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .edoc-block .edoc-title {
      padding: 10px 14px;
      border-bottom: 1px solid #eee;
      background: #f9f6f0;
      /* ƒë·ªìng b·ªô v·ªõi processTable header */
      font-weight: 600;
      font-size: 15px;
      color: #222;
    }

    .edoc-block table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }

    .edoc-block th,
    .edoc-block td {
      border: 1px solid #eee;
      padding: 8px 10px;
      vertical-align: middle;
      font-size: 14px;
      text-align: left;
    }

    .edoc-block th {
      background: #f9f6f0;
      /* gi·ªëng header processTable */
      font-weight: 600;
      color: #222;
    }

    .edoc-block tbody tr:nth-of-type(odd) {
      background: #fcfcfc;
    }

    .edoc-block tbody tr:hover {
      background: #f5f5f5;
    }

    .edoc-label {
      display: inline-block;
      padding: 3px 8px;
      font-size: 12px;
      border-radius: 4px;
      color: #fff;
      font-weight: 500;
      text-align: center;
    }

    /* Tr·∫°ng th√°i */
    .edoc-label.warning {
      background-color: #f0ad4e;
    }

    .edoc-label.danger {
      background-color: #d9534f;
    }

    .edoc-label.success {
      background-color: #5cb85c;
    }

    /* CƒÉn gi·ªØa c·ªôt Tr·∫°ng th√°i */
    .edoc-block td:nth-child(7) {
      text-align: center;
    }

    .edoc-block th:nth-child(6),
    .edoc-block td:nth-child(6) {
      display: center;
    }
    /* ========= TONE & COLORS ========= */
:root{
  --line-strong:#D0D5DD;      /* vi·ªÅn b·∫£ng */
  --line-strong-2:#98A2B3;    /* hover/outline */
  --fill-strong-1:#F2F4F7;    /* header th */
  --row-zebra:#FAFAFB;        /* h√†ng ch·∫µn */
  --ink-strong:#101828;       /* ch·ªØ ƒë·∫≠m */
}

/* ========= CARD / SECTION ========= */
.card{
  background:#fff;
  border:1px solid var(--line-strong);
  border-radius:12px;
  box-shadow:0 4px 14px rgba(16,24,40,.06);
}

/* ========= TABLE ========= */
.table{
  width:100%;
  border-collapse:separate;   /* ƒë·ªÉ bo g√≥c ƒë·∫πp */
  border-spacing:0;
  border:1.25px solid var(--line-strong);
  border-radius:10px;
  overflow:hidden;            /* bo g√≥c cho header */
  font-size:14.5px;
  color:var(--ink-strong);
}

.table th,
.table td{
  padding:10px 12px;
  border-right:1.25px solid var(--line-strong);
  border-bottom:1.25px solid var(--line-strong);
  vertical-align:top;
}

.table th{
  background:var(--fill-strong-1);
  font-weight:600;
}

.table tr:nth-child(even) td{
  background:var(--row-zebra);
}

/* b·ªè vi·ªÅn ph·∫£i √¥ cu·ªëi & vi·ªÅn d∆∞·ªõi h√†ng cu·ªëi */
.table tr > *:last-child{ border-right:none; }
.table tr:last-child > *{ border-bottom:none; }

/* hover h√†ng (t√πy th√≠ch) */
.table tbody tr:hover td{
  background:#EEF2F6;
}

/* ========= BADGE / STATUS ========= */
.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:999px;
  font-size:12.5px;
  font-weight:600;
  border:1px solid transparent;
}

.badge--info{    background:#E0EAFF; color:#1E40AF; border-color:#BFD5FF; }
.badge--warn{    background:#FEF0C7; color:#92400E; border-color:#FDE68A; }
.badge--success{ background:#D1FADF; color:#05603A; border-color:#A6F4C5; }
.badge--danger{  background:#FEE4E2; color:#912018; border-color:#FECDCA; }

/* ========= LABEL (c·ªôt ti√™u ƒë·ªÅ b√™n tr√°i) ========= */
.kv-label{
  font-weight:600;
  color:#0F172A;
}

/* ========= BUTTON SAVE (nh√¨n s·∫Øc n√©t h∆°n) ========= */
.btn-primary{
  background:#1D4ED8; color:#fff;
  border:1px solid #1E40AF;
  padding:8px 14px; border-radius:10px;
  box-shadow:0 2px 8px rgba(29,78,216,.25);
}
.btn-primary:hover{ background:#1B46C2; } 
.select-donvi {
  width: 100%;
  padding: 6px 8px;
  border: 1px solid #d0d5dd;
  border-radius: 8px;
  font-size: 14px;
  background-color: #fff;
  color: #111827;
  outline: none;
}

.select-donvi:focus {
  border-color: #2563eb;
  box-shadow: 0 0 0 2px rgba(37,99,235,0.25);
}
  </style>
  
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>

<body>
  <div class="navbar">
    <div class="logo"><img src="photo/logo-nhnnvn-3-1129x800.webp" alt="Logo"></div>
    <div class="dept" id="deptName">Ph√≤ng: C√ÅN B·ªò ƒê·ªäA PH∆Ø∆†NG</div>
    <div class="dept" id="refDisplay"></div>
  </div>

  <div class="container">
    <h1>Ph√™ duy·ªát/c√≥ √Ω ki·∫øn v·ªÅ K·∫ø ho·∫°ch tuy·ªÉn d·ª•ng c√¥ng ch·ª©c lo·∫°i D t·∫°i c√°c NHNN chi nh√°nh Khu v·ª±c</h1>

    <!-- Dropdown ch·ªçn trang -->
    <div id="processSelectWrapper" class="hidden">
      <label for="processSelect"><b>Ch·ªçn quy tr√¨nh:</b></label>
      <select id="processSelect">
        <option value="test.html" selected>K·∫ø ho·∫°ch tuy·ªÉn d·ª•ng c√¥ng ch·ª©c lo·∫°i D t·∫°i c√°c NHNN chi nh√°nh Khu v·ª±c</option>
        <option value="test1.html">C·ª≠ c√°n b·ªô ƒëi c√¥ng t√°c n∆∞·ªõc ngo√†i</option>
        <option value="test2.html">T·ªï ch·ª©c ƒë√≥n nh·∫≠n c√°c danh hi·ªáu thi ƒëua, h√¨nh th·ª©c khen th∆∞·ªüng c·∫•p Nh√† N∆∞·ªõc, c·∫•p Ng√†nh
        </option>
        <option value="test3.html">Tri·ªÉn khai quy ho·∫°ch L√£nh ƒê·∫°o c·∫•p Ph√≤ng t·∫°i NHTW</option>
        <option value="test4.html">Quy Tr√¨nh Ph√™ Duy·ªát ƒê·ªëi V·ªõi N√¢ng L∆∞∆°ng Th∆∞·ªùng Xuy√™n, Ph·ª• C·∫•p Th√¢m Ni√™n V∆∞·ª£t Khung
          Thu·ªôc Th·∫©m Quy·ªÅn V·ª• TCCB Duy·ªát K√Ω</option>
        <option value="test5.html">Quy tr√¨nh x√¢y d·ª±ng b√°o c√°o ƒë·ªãnh k·ª≥/ƒë·ªôt xu·∫•t/tham gia √Ω ki·∫øn/tr·∫£ l·ªùi ki·∫øn ngh·ªã g·ª≠i c√°c
          ƒë∆°n v·ªã thu·ªôc NHNN do l√£nh ƒë·∫°o V·ª• TCCB duy·ªát k√Ω</option>
      </select>
    </div>

    <!-- Export / Import CSV -->
    <div class="actions">
      <button onclick="exportRawJson()" style="display: none;">üì• Export Local File</button>
      <button onclick="sendToSharePoint()">‚òÅÔ∏è Save D·ªØ Li·ªáu</button>
      <button onclick="importFromCloud()" style="display: none;">‚òÅÔ∏è Import Cloud</button>
      <button onclick="exportExcelSharePointFormat()" style="display: none;">‚¨áÔ∏è Export Excel</button>
      <!-- Import Token Key -->
      <label for="importToken" title="Import Token Key" class="icon-btn" style="display: none;">üîë Import Token Key
        File</label>
      <input type="file" id="importToken" accept=".csv,.txt" onchange="importToken(event)" hidden>

      <!-- Import Encoded TXT -->
      <label for="importEncoded" title="Import Encoded TXT" class="icon-btn" style="display: none;">üìÇ Import Data Local
        File</label>
      <input type="file" id="importEncoded" accept=".txt" onchange="importEncoded(event)" hidden>
    </div>
    <div id="chitiet-container"></div>
    <div id="ykien-container"></div>
    <div id="luanchuyen-container"></div>
    <div id="detailWrapper"></div>
    <div class="edoc-block" style="margin-top: 30px;">
      <div class="edoc-title">CHI TI·∫æT K·∫æ HO·∫†CH C·ª¶A C√ÅN B·ªò ƒê·∫¶U M·ªêI</div>
      <div id="processTable">
        <table class="process-table-inner">
          <thead>
            <tr>
              <th>N·ªôi dung th·ª±c hi·ªán</th>
              <th>Ng∆∞·ªùi th·ª±c hi·ªán/Ph√™ duy·ªát</th>
              <th>Ng√†y g·ª≠i</th>
              <th>ƒê∆°n v·ªã nh·∫≠n</th>
              <th>Th·ªùi gian x·ª≠ l√Ω</th>
              <th>Th·ªùi gian ch·ªù</th>
              <th>K·∫øt qu·∫£</th>
              <th>Ng√†y ho√†n th√†nh</th>
              <th>Quy·∫øt ƒë·ªãnh</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="summary"></div>

  </div>

  <script>
  function getDropdownHTML(selectedValue = "") {
    let html = `<select class="select-donvi"><option value="">-- Ch·ªçn ƒë∆°n v·ªã nh·∫≠n --</option>`;
    donViNhanData.forEach(group => {
      html += `<optgroup label="${group.group}">`;
      group.items.forEach(item => {
        const sel = item === selectedValue ? "selected" : "";
        html += `<option value="${item}" ${sel}>${item}</option>`;
      });
      html += `</optgroup>`;
    });
    html += `</select>`;
    return html;
  }

const donViNhanData = [
  {
    group: "Ng√¢n h√†ng Nh√† n∆∞·ªõc Trung ∆∞∆°ng",
    items: [
      "V·ª• Ch√≠nh s√°ch ti·ªÅn t·ªá",
      "V·ª• Thanh to√°n",
      "V·ª• T√≠n d·ª•ng c√°c ng√†nh kinh t·∫ø",
      "V·ª• D·ª± b√°o, th·ªëng k√™ ‚Äì ·ªîn ƒë·ªãnh ti·ªÅn t·ªá, t√†i ch√≠nh",
      "V·ª• H·ª£p t√°c qu·ªëc t·∫ø",
      "V·ª• Ph√°p ch·∫ø",
      "V·ª• T√†i ch√≠nh ‚Äì K·∫ø to√°n",
      "V·ª• T·ªï ch·ª©c c√°n b·ªô",
      "VƒÉn ph√≤ng",
      "Thanh tra Ng√¢n h√†ng Nh√† n∆∞·ªõc",
      "S·ªü Giao d·ªãch",
      "C·ª•c C√¥ng ngh·ªá th√¥ng tin",
      "C·ª•c Ph√°t h√†nh v√† Kho qu·ªπ",
      "C·ª•c Qu·∫£n l√Ω ngo·∫°i h·ªëi",
      "C·ª•c Ph√≤ng, ch·ªëng r·ª≠a ti·ªÅn",
      "C·ª•c Qu·∫£n l√Ω, gi√°m s√°t t·ªï ch·ª©c t√≠n d·ª•ng",
      "C·ª•c An to√†n h·ªá th·ªëng c√°c t·ªï ch·ª©c t√≠n d·ª•ng",
      "Ng√¢n h√†ng Nh√† n∆∞·ªõc chi nh√°nh t·∫°i c√°c khu v·ª±c",
      "Trung t√¢m Th√¥ng tin t√≠n d·ª•ng Qu·ªëc gia Vi·ªát Nam",
      "Th·ªùi b√°o Ng√¢n h√†ng"
    ]
  },
  {
    group: "B·ªô, C∆° quan ngang B·ªô Trung ∆∞∆°ng",
    items: [
      "B·ªô Qu·ªëc ph√≤ng",
      "B·ªô C√¥ng an",
      "B·ªô Ngo·∫°i giao",
      "B·ªô N·ªôi v·ª•",
      "B·ªô T∆∞ ph√°p",
      "B·ªô K·∫ø ho·∫°ch v√† ƒê·∫ßu t∆∞",
      "B·ªô T√†i ch√≠nh",
      "B·ªô C√¥ng Th∆∞∆°ng",
      "B·ªô N√¥ng nghi·ªáp v√† Ph√°t tri·ªÉn n√¥ng th√¥n",
      "B·ªô Giao th√¥ng v·∫≠n t·∫£i",
      "B·ªô X√¢y d·ª±ng",
      "B·ªô T√†i nguy√™n v√† M√¥i tr∆∞·ªùng",
      "B·ªô Th√¥ng tin v√† Truy·ªÅn th√¥ng",
      "B·ªô Lao ƒë·ªông - Th∆∞∆°ng binh v√† X√£ h·ªôi",
      "B·ªô VƒÉn h√≥a, Th·ªÉ thao v√† Du l·ªãch",
      "B·ªô Khoa h·ªçc v√† C√¥ng ngh·ªá",
      "B·ªô Gi√°o d·ª•c v√† ƒê√†o t·∫°o",
      "B·ªô Y t·∫ø",
      "·ª¶y ban D√¢n t·ªôc",
      "Ng√¢n h√†ng Nh√† n∆∞·ªõc Vi·ªát Nam",
      "Thanh tra Ch√≠nh ph·ªß",
      "VƒÉn ph√≤ng Ch√≠nh ph·ªß"
    ]
  },
  {
    group: "Ng√¢n h√†ng Nh√† n∆∞·ªõc khu v·ª±c",
    items: Array.from({ length: 15 }, (_, i) => `Ng√¢n h√†ng Nh√† n∆∞·ªõc khu v·ª±c ${i + 1}`)
  },
  {
    group: "Ph√≤ng ban thu·ªôc V·ª• TCNS",
    items: [
      "Ph√≤ng c√°n b·ªô trung ∆∞∆°ng",
      "Ph√≤ng c√°n b·ªô ƒë·ªãa ph∆∞∆°ng",
      "Ph√≤ng t·ªï ch·ª©c - ti·ªÅn l∆∞∆°ng",
      "Ph√≤ng Thi ƒëua, khen th∆∞·ªüng",
      "Ph√≤ng ƒê√†o t·∫°o v√† ph√°t tri·ªÉn ngu·ªìn nh√¢n l·ª±c"
    ]
  }
];

    let edocData = [];
    try {
      const stored = sessionStorage.getItem("edocData");
      if (stored) {
        edocData = JSON.parse(stored);
        console.log("‚úÖ Nh·∫≠n t·ª´ homepage:", edocData);
      } else {
        console.warn("‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu edocData trong sessionStorage");
      }
    } catch (e) {
      console.error("‚ùå L·ªói parse edocData:", e);
    };
    // üîß Endpoint Power Automate Flow (l·∫•y t·ª´ SharePoint)
    const FLOW_URL =
      "https://default460cecfbf0c64dd7a5ec66ef4d75ae.63.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/e92a5c03c0524754a5957ec23d945b77/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=ytc79DxIlkb3uRhF93uLhGp8DuWxVMETGyFkZDtfQ-Y";

// ‚úÖ L·∫•y danh s√°ch quy tr√¨nh t·ª´ Flow SharePoint v√† fill v√†o dropdown
// ‚úÖ L·∫•y danh s√°ch quy tr√¨nh t·ª´ Flow SharePoint v√† fill v√†o dropdown
// ‚úÖ L·∫•y danh s√°ch quy tr√¨nh t·ª´ Flow SharePoint v√† fill v√†o dropdown
async function loadProcessList() {
  const container = document.getElementById("chitiet-container");
  if (container) container.innerHTML = "<p>‚è≥ ƒêang t·∫£i danh s√°ch quy tr√¨nh...</p>";

  try {
    console.log("üîÑ [loadProcessList] G·ªçi Flow ƒë·ªÉ l·∫•y danh s√°ch quy tr√¨nh...");
    const res = await fetch(FLOW_URL, { method: "POST" });
    if (!res.ok) throw new Error(`L·ªói t·∫£i danh m·ª•c (${res.status})`);

    const text = await res.text();
    let data;
    try {
      data = JSON.parse(text);
    } catch {
      data = JSON.parse(JSON.parse(text)); // fallback n·∫øu JSON l·ªìng
    }

    const list = Array.isArray(data) ? data : [data];

    // üîπ Chu·∫©n h√≥a format d·ªØ li·ªáu t·ª´ SharePoint
    const normalized = list.map(item => ({
      maSo: item["M√É S·ªê"] || item["MASO"] || "",
      ten: (item["T√äN QUY TR√åNH"] || item["TENQUYTRINH"] || item["QUYTRINH_NAME"] || "").trim(),
      QUYTRINH_NAME: (item["QUYTRINH_NAME"] || item["T√äN QUY TR√åNH"] || item["TENQUYTRINH"] || "").trim(),
      steps: (() => {
        let raw = item["STEP QUY TR√åNH"] || item["CAYQUYTRINH"] || "[]";
        try {
          const parsed = JSON.parse(raw);
          return Array.isArray(parsed) ? parsed : JSON.parse(parsed);
        } catch (e) {
          console.warn("‚ö†Ô∏è STEP parse l·ªói:", e);
          return [];
        }
      })()
    }));

    // üîπ Cache danh s√°ch ƒë·ªÉ t√°i s·ª≠ d·ª•ng
    sessionStorage.setItem("processListChiTiet", JSON.stringify(normalized));
    console.log("‚úÖ ƒê√£ nh·∫≠n", normalized.length, "quy tr√¨nh t·ª´ SharePoint");

    // --- Render dropdown ---
    const select = document.getElementById("processSelectChiTiet");
    const title = document.getElementById("pageTitle");
    if (!select) {
      console.error("‚ùå Kh√¥ng t√¨m th·∫•y dropdown #processSelectChiTiet");
      if (container) container.innerHTML = "<p>‚ö†Ô∏è Kh√¥ng c√≥ dropdown quy tr√¨nh ƒë·ªÉ hi·ªÉn th·ªã.</p>";
      return;
    }

    select.innerHTML = `<option value="">-- Ch·ªçn quy tr√¨nh --</option>`;
    normalized.forEach(q => {
      const opt = document.createElement("option");
      opt.value = q.maSo;
      opt.textContent = q.QUYTRINH_NAME || q.ten || q.maSo;
      select.appendChild(opt);
    });

    // --- Khi ng∆∞·ªùi d√πng ch·ªçn ---
select.onchange = e => {
  const maSo = e.target.value;
  const found = normalized.find(x => x.maSo === maSo);
  if (!found) return;

  console.log("üü¢ [ƒê√£ ch·ªçn th·ªß c√¥ng]", found.QUYTRINH_NAME);

  const title = document.getElementById("pageTitle") || document.querySelector("h1");
  if (title) {
    title.textContent = found.QUYTRINH_NAME || found.ten || found.maSo;
    title.style.display = "block";
  }

  // ‚úÖ G√°n data & render full inner UI
  window.processData = found.steps;
  if (typeof renderSteps === "function") {
    renderSteps(window.processData); // ‚ö° G·ªçi h√†m g·ªëc c√≥ icon, textarea, n√∫t
  } else {
    console.warn("‚ö†Ô∏è Ch∆∞a c√≥ renderSteps() ‚Äî fallback v·ªÅ renderProcessFromJson()");
    renderProcessFromJson();
  }
};

    if (container) container.innerHTML = ""; // clear loading

    // ‚úÖ ƒê·ª£i dropdown render ƒë·∫ßy ƒë·ªß r·ªìi m·ªõi auto-select
    await new Promise(resolve => {
      let tries = 0;
      const timer = setInterval(() => {
        if (select.options.length > 1 || tries++ > 30) {
          clearInterval(timer);
          resolve();
        }
      }, 100);
    });

    // ‚úÖ N·∫øu c√≥ record ƒëang edit ‚Üí t·ª± ƒë·ªông ch·ªçn quy tr√¨nh ƒë√∫ng t√™n ho·∫∑c m√£
    const selectedRow = sessionStorage.getItem("selectedRow");
    if (selectedRow) {
      try {
        const row = JSON.parse(selectedRow);
        if (row.QUYTRINH_NAME || row.MASO) {
          console.log("üìå [Auto-select] T√¨m quy tr√¨nh:", row.QUYTRINH_NAME || row.MASO);

          const found = normalized.find(x =>
            x.maSo.trim().toLowerCase() === (row.MASO || "").trim().toLowerCase() ||
            x.QUYTRINH_NAME.trim().toLowerCase() === (row.QUYTRINH_NAME || "").trim().toLowerCase()
          );

          if (found) {
            // ‚úÖ G√°n selected ƒë√∫ng
            select.value = found.maSo;
            const opt = [...select.options].find(o => o.value === found.maSo);
            if (opt) opt.setAttribute("selected", "selected");

            // ‚úÖ C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
            if (title) {
              title.textContent = found.QUYTRINH_NAME || found.ten || found.maSo;
              title.style.display = "block";
            }

            console.log("‚úÖ [Auto-select] Ch·ªçn th√†nh c√¥ng:", found.QUYTRINH_NAME);

            // ‚úÖ G√°n d·ªØ li·ªáu & render
            window.processData = found.steps;
            await new Promise(r => setTimeout(r, 100)); // ƒë·ª£i DOM update
            renderProcessFromJson();
          } else {
            console.warn("‚ö†Ô∏è [Auto-select] Kh√¥ng t√¨m th·∫•y quy tr√¨nh kh·ªõp:", row.QUYTRINH_NAME);
          }
        }
      } catch (err) {
        console.warn("‚ö†Ô∏è L·ªói parse selectedRow khi auto-select:", err);
      }
    }

  } catch (err) {
    console.error("‚ùå loadProcessList l·ªói:", err);
    if (container)
      container.innerHTML = `<p>‚ùå L·ªói t·∫£i danh s√°ch: ${err.message}</p>`;
  }
}

    // ‚úÖ Render step xu·ªëng b·∫£ng chi ti·∫øt (processTable)
    // ‚úÖ Icon tr·∫°ng th√°i
    function renderStatus(status) {
      if (!status) return "";
      const s = status.toLowerCase();
      if (s.includes("ƒë√£")) return "‚úÖ";
      if (s.includes("ƒëang")) return "‚è≥";
      return "‚ùå";
    }

    // üöÄ Kh·ªüi t·∫°o khi trang load
    window.addEventListener("DOMContentLoaded", () => {
      console.log("üåê DOM ready ‚Üí loadProcessList()");
      loadProcessList();
    });
    // =============== RENDER CHI TI·∫æT ===================
    function renderChiTiet(chitiet) {
      if (!chitiet) return "";
      return `
    <div class="edoc-block">
  <div class="edoc-title">QUY TR√åNH X·ª¨ L√ù</div>
  <div style="padding:10px;">
    <label for="processSelectChiTiet"><b>Ch·ªçn quy tr√¨nh:</b></label>
    <select id="processSelectChiTiet" style="margin-left:8px; padding:6px 8px; min-width:400px;"></select>
  </div>
      <div class="edoc-title">CHI TI·∫æT VƒÇN B·∫¢N ƒê·∫æN</div>
      <div class="edoc-body">
        <table>
          <tr>
            <td><b>S·ªë vƒÉn b·∫£n</b></td><td>${chitiet.soVanBan || ""}</td>
            <td><b>STT</b></td><td>${chitiet.stt || ""}</td>
          </tr>
          <tr>
            <td><b>C∆° quan/ƒë∆°n v·ªã g·ª≠i ƒë·∫øn</b></td><td>${chitiet.coQuanGui || ""}</td>
            <td><b>S·ªë k√Ω hi·ªáu</b></td><td>${chitiet.soKyHieu || ""}</td>
          </tr>
          <tr>
            <td><b>Ng√†y g·ª≠i ƒë·∫øn</b></td><td>${chitiet.ngayGuiDen || ""}</td>
            <td><b>Ng√†y vƒÉn b·∫£n</b></td><td>${chitiet.ngayVanBan || ""}</td>
          </tr>
          <tr>
            <td><b>ƒê·ªô kh·∫©n</b></td><td>${chitiet.doKhan || ""}</td>
            <td><b>ƒê·ªô m·∫≠t</b></td><td>${chitiet.doMat || ""}</td>
          </tr>
          <tr>
            <td><b>Tr√≠ch y·∫øu</b></td><td colspan="3">${chitiet.trichYeu || ""}</td>
          </tr>
          <tr>
            <td><b>Ghi ch√∫</b></td><td colspan="3">${chitiet.ghiChu || ""}</td>
          </tr>
          <tr>
            <td><b>Tr·∫°ng th√°i ng∆∞·ªùi d√πng</b></td>
            <td><span class="edoc-label danger">${chitiet.trangThaiND || ""}</span></td>
            <td><b>Tr·∫°ng th√°i vƒÉn b·∫£n</b></td>
            <td><span class="edoc-label warning">${chitiet.trangThaiVB || ""}</span></td>
          </tr>
          <tr>
            <td><b>File vƒÉn b·∫£n</b></td>
            <td colspan="3">${chitiet.fileDinhKem ? `<a href="#">${chitiet.fileDinhKem}</a>` : ""}</td>
          </tr>
        </table>
      </div>
    </div>`;
    }

    // =============== RENDER √ù KI·∫æN ===================
    function renderYKienTable(data) {
      if (!data || !data.length) return "";
      let html = `
    <div class="edoc-block">
      <div class="edoc-title">√ù KI·∫æN X·ª¨ L√ù VƒÇN B·∫¢N</div>
      <div class="edoc-body">
        <table>
          <thead>
            <tr>
              <th>Ng∆∞·ªùi b√∫t ph√™</th>
              <th>Th·ªùi gian</th>
              <th>N·ªôi dung</th>
              <th>Ph√≤ng ban ƒë·∫ßu m·ªëi</th>
              <th>Ph√≤ng ban ph·ªëi h·ª£p</th>
            </tr>
          </thead>
          <tbody>`;
      data.forEach(r => {
        html += `<tr>
        <td>${r["Ng∆∞·ªùi b√∫t ph√™"] || ""}</td>
        <td>${r["Th·ªùi gian"] || ""}</td>
        <td>${r["N·ªôi dung"] || ""}</td>
        <td>${r["Ph√≤ng ban ƒë·∫ßu m·ªëi"] || ""}</td>
        <td>${r["Ph√≤ng ban ph·ªëi h·ª£p"] || ""}</td>
      </tr>`;
      });
      html += `</tbody></table></div></div>`;
      return html;
    }

    // =============== RENDER LU√ÇN CHUY·ªÇN ===================
    function renderLuanChuyenTable(data) {
      if (!data || !data.length) return "";
      let html = `
    <div class="edoc-block">
      <div class="edoc-title">TH√îNG TIN LU√ÇN CHUY·ªÇN VƒÇN B·∫¢N</div>
      <div class="edoc-body">
        <table>
          <thead>
            <tr>
              <th>Ng∆∞·ªùi g·ª≠i</th>
              <th>ƒê∆°n v·ªã nh·∫≠n</th>
              <th>Ng∆∞·ªùi nh·∫≠n</th>
              <th>Th·ªùi gian g·ª≠i</th>
              <th>Th·ªùi gian nh·∫≠n</th>
              <th style="text-align:center">Tr·∫°ng th√°i</th>
              <th>L√Ω do</th>
            </tr>
          </thead>
          <tbody>`;
      data.forEach(r => {
        // mapping tr·∫°ng th√°i -> class
        let statusClass = "warning";
        const status = (r.trang_thai || "").toLowerCase();

        if (status.includes("ƒë√£ nh·∫≠n")) {
          statusClass = "success";   // xanh
        } else if (status.includes("ƒë√£ g·ª≠i")) {
          statusClass = "warning";   // cam
        } else {
          statusClass = "danger";    // ƒë·ªè cho l·ªói/tr·∫°ng th√°i kh√°c
        }

        html += `<tr>
        <td>${r.nguoi_gui || ""}</td>
        <td>${r.don_vi_nhan || ""}</td>
        <td>${r.nguoi_nhan || ""}</td>
        <td>${r.thoi_gian_gui || ""}</td>
        <td>${r.thoi_gian_nhan || ""}</td>
        <td style="text-align:center">
          ${r.trang_thai ? `<span class="edoc-label ${statusClass}">${r.trang_thai}</span>` : ""}
        </td>
        <td>${r.ly_do || ""}</td>
      </tr>`;
      });
      html += `</tbody></table></div></div>`;
      return html;
    }
    // === Danh s√°ch nh√¢n s·ª± ph√≤ng T·ªï ch·ª©c - Ti·ªÅn l∆∞∆°ng ===
    const nhanSuPhong = [
      {
        "Hoten": "L√™ Anh H·∫£o",
        "Chucvu": "Tr∆∞·ªüng ph√≤ng"
      },
      {
        "Hoten": "Nguy·ªÖn Th·ªã B√≠ch Th·∫£o",
        "Chucvu": "Ph√≥ Tr∆∞·ªüng ph√≤ng"
      },
      {
        "Hoten": "S·∫ßm Th·ªã Kim Ph∆∞∆°ng",
        "Chucvu": "Ph√≥ Tr∆∞·ªüng ph√≤ng"
      },
      {
        "Hoten": "Tr∆∞∆°ng Ho√†ng Nam",
        "Chucvu": "Ph√≥ Tr∆∞·ªüng ph√≤ng"
      },
      {
        "Hoten": "Tr∆∞∆°ng H·ªìng Quang",
        "Chucvu": "C√¥ng ch·ª©c ph·ª• tr√°ch"
      },
      {
        "Hoten": "Tr·ªãnh Th·ªã Ph∆∞∆°ng",
        "Chucvu": "C√¥ng ch·ª©c ph·ª• tr√°ch"
      },
      {
        "Hoten": "Nguy·ªÖn Thu Th·ªßy",
        "Chucvu": "C√¥ng ch·ª©c ph·ª• tr√°ch"
      },
      {
        "Hoten": "Nguy·ªÖn Minh Anh",
        "Chucvu": "C√¥ng ch·ª©c ph·ª• tr√°ch"
      },
      {
        "Hoten": "Tr·∫ßn Th·ªã H·∫£i Y·∫øn",
        "Chucvu": "C√¥ng ch·ª©c ph·ª• tr√°ch"
      },
      {
        "Hoten": "Nguy·ªÖn Qu·ª≥nh Anh",
        "Chucvu": "VƒÉn th∆∞"
      },
      {
        "Hoten": "Ph·∫°m Thu Ho√†i",
        "Chucvu": "C√¥ng ch·ª©c ph·ª• tr√°ch"
      },
      {
        "Hoten": "Th√¢n Ho√†ng Duy",
        "Chucvu": "C√¥ng ch·ª©c ph·ª• tr√°ch"
      },
      {
        "Hoten": "Ho√†ng Qu·ª≥nh Li√™n",
        "Chucvu": "C√¥ng ch·ª©c ph·ª• tr√°ch"
      },
      {
        "Hoten": "L√™ Th·ªã Kim Oanh",
        "Chucvu": "VƒÉn th∆∞"
      },
      {
        "Hoten": "Tr·∫ßn Thu Huy·ªÅn",
        "Chucvu": "L√£nh ƒë·∫°o V·ª•"
      },
      {
        "Hoten": "L√™ Vi·ªát H√πng",
        "Chucvu": "L√£nh ƒë·∫°o V·ª•"
      },
      {
        "Hoten": "Nguy·ªÖn Anh Tu·∫•n",
        "Chucvu": "L√£nh ƒë·∫°o V·ª•"
      }
    ];
    function guessRole(label, nhanSuList = []) {
      const t = normalize(label || "");
      if (t.includes("vƒÉn th∆∞")) return "VƒÉn th∆∞";
      if (t.includes("l√£nh ƒë·∫°o v·ª•")) return "L√£nh ƒë·∫°o V·ª•";
      if (t.includes("l√£nh ƒë·∫°o ph√≤ng")) return "L√£nh ƒë·∫°o Ph√≤ng";
      if (t.includes("c√¥ng ch·ª©c ph·ª• tr√°ch")) return "C√¥ng ch·ª©c ph·ª• tr√°ch";  // üëà th√™m d√≤ng n√†y

      // n·∫øu label l√† t√™n th·∫≠t
      const hit = (window.nhanSuList || nhanSuList || []).find(
        n => t.includes(normalize(n.Hoten || ""))
      );
      return hit ? (hit.Chucvu || "Kh√°c") : "Kh√°c";
    }
    function normalize(str) {
      return str
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")   // b·ªè d·∫•u
        .replace(/[ƒëƒê]/g, "d")             // chu·∫©n h√≥a ƒë/ƒê th√†nh d
        .replace(/[^A-Za-z0-9\s]/g, "")    // gi·ªØ l·∫°i ch·ªØ (hoa + th∆∞·ªùng), s·ªë, kho·∫£ng tr·∫Øng
        .trim()
        .toLowerCase();
    };
    function toVNDateTime24s(str) {
      if (!str) return "";
      // B·∫Øt dd/MM/yyyy HH:mm[,ss] [AM|PM] (HH c√≥ th·ªÉ 1-2 ch·ªØ s·ªë)
      const m = str.match(/(\d{2}\/\d{2}\/\d{4})\s+(\d{1,2}):(\d{2})(?::(\d{2}))?\s*(AM|PM)?/i);
      if (!m) return str; // kh√¥ng kh·ªõp th√¨ gi·ªØ nguy√™n

      const date = m[1];
      let hour = parseInt(m[2], 10);
      const minute = m[3];
      let second = m[4] ?? "00";           // n·∫øu thi·∫øu gi√¢y ‚Üí "00"
      const ampm = m[5] ? m[5].toUpperCase() : null;

      if (ampm) {
        if (ampm === "PM" && hour < 12) hour += 12;
        if (ampm === "AM" && hour === 12) hour = 0;
      }
      return `${date} ${hour.toString().padStart(2, "0")}:${minute}:${second.padStart(2, "0")}`;
    }
    function cloneRowsFromArray(array, templateId, defaultRole, defaultTime) {
      if (!array || array.length === 0) return;

      const tbody = document.querySelector("#processTable tbody");
      const templateRow = document.getElementById(templateId);

      array.forEach((c, idx) => {
        const rowId = `${templateId}r${idx}`;
        const row = document.createElement("tr");
        row.id = rowId;

        row.innerHTML = `
        <td>${c.noidung || "X·ª≠ l√Ω T·ªù tr√¨nh"}</td>
        <td>${c.chuc_vu || defaultRole}</td>
        <td id="ngaygui-${rowId}">${c.thoi_gian || ""}</td>
        <td id="nguoigui-${rowId}">${c.nguoi_gui || ""}</td>
        <td id="nguoinhan-${rowId}">${c.nguoi_nhan || ""}</td>
        <td id="donvinhan-${rowId}">${c.don_vi_nhan || ""}</td>
        <td>${defaultTime || ""}</td>
        <td></td>
        <td></td>
        <td><textarea class="result-input" id="res-${rowId}" readonly placeholder="Nh·∫≠p k·∫øt qu·∫£"></textarea></td>
        <td><span id="time-text-${rowId}">${c.thoi_gian || ""}</span></td>
        <td id="decision-${rowId}"></td>
      `;

        tbody.insertBefore(row, templateRow.nextSibling);
        row.classList.remove("hidden");   // ‚úÖ th√™m d√≤ng n√†y
        lockEdocRow(rowId);
      });

      // ·∫®n d√≤ng template g·ªëc
      templateRow.classList.add("hidden");

      // üëâ m·ªü ti·∫øp b∆∞·ªõc sau d·ª±a tr√™n timestamp m·ªõi nh·∫•t
      const lastTime = array
        .map(c => parseVNDate(c.thoi_gian))
        .filter(Boolean)
        .reduce((a, b) => a > b ? a : b, null);

      if (lastTime) {
        const lastRowId = `${templateId}r${array.length - 1}`;
        const match = templateId.match(/s(\d+)r(\d+)/);
        if (match) {
          const s = parseInt(match[1]);
          const r = parseInt(match[2]);
          showNext(lastRowId, s, r);
        }
      }
    }
    // Chu·∫©n ho√° t√™n ng∆∞·ªùi nh·∫≠n (b·ªè " - Ph·ªëi h·ª£p" / " - ƒê·∫ßu m·ªëi")
    function cleanReceiverName(name) {
      if (!name) return "";
      return name.replace(/\s*-\s*(ph·ªëi h·ª£p|ƒë·∫ßu m·ªëi)$/i, "").trim();
    }

    function fillStepsFromEdoc(edocData, nhanSuList = []) {
      const steps = {
        vanThu: null,
        lanhDaoVu: [],
        lanhDaoPhong: null,
        congChuc: []
      };

      edocData.forEach((item, i) => {
        const cleanNguoiNhan = cleanReceiverName(item.nguoi_nhan || "");
        const nguoiNhan = normalize(cleanNguoiNhan);

        // t√¨m c√° nh√¢n trong danh s√°ch
        const matched = nhanSuList.find(n => nguoiNhan.includes(normalize(n.Hoten || "")));

        const record = {
          noidung: item.noidung || "Ti·∫øp nh·∫≠n T·ªù tr√¨nh",
          thoi_gian: toVNDateTime24s(item.thoi_gian_gui),
          nguoi_gui: item.nguoi_gui || "",
          nguoi_nhan: cleanNguoiNhan,
          don_vi_nhan: item.don_vi_nhan || "",
          chuc_vu: matched ? matched.Chucvu : ""
        };

        if (matched) {
          const role = normalize(matched.Chucvu || "");
          console.log(`role normalize: ${matched.Chucvu} => ${role}`);

          if (role.includes("van thu")) {
            if (!steps.vanThu) {
              steps.vanThu = record;
              console.log("‚úÖ PUSH VƒÉn th∆∞:", record);
            }
            return;
          }

          if (role.includes("lanh dao vu") || role.includes("vu truong") || role.includes("pho vu truong")) {
            const donvi = normalize(item.don_vi_nhan || "");
            if (donvi.includes("ban lanh dao vu")) {
              steps.lanhDaoVu.push(record);
              console.log("‚úÖ PUSH L√£nh ƒë·∫°o V·ª•:", record)
              console.log(donvi);
              return;
            }
            console.log("‚ö†Ô∏è B·ªè qua L√£nh ƒë·∫°o V·ª• v√¨ ƒë∆°n v·ªã nh·∫≠n kh√¥ng kh·ªõp:", record);
            console.log(donvi);
            return;
          }

          if (role.includes("lanh dao phong") || role.includes("truong phong") || role.includes("pho truong phong")) {
            if (!steps.lanhDaoPhong) {
              steps.lanhDaoPhong = record;
              console.log("‚úÖ PUSH L√£nh ƒë·∫°o Ph√≤ng:", record);
            }
            return;
          }

          if (role.includes("cong chuc phu trach") || role.includes("chuyen vien") || role.includes("chuyen vien chinh")) {
            steps.congChuc.push(record);
            console.log("‚úÖ PUSH C√¥ng ch·ª©c ph·ª• tr√°ch:", record);
            return;
          }
        }


      });

      // S·∫Øp x·∫øp theo th·ªùi gian
      steps.lanhDaoVu.sort((a, b) => parseVNDate(a.thoi_gian) - parseVNDate(b.thoi_gian));
      steps.congChuc.sort((a, b) => parseVNDate(a.thoi_gian) - parseVNDate(b.thoi_gian));

      console.log(">>> T·ªïng VƒÉn th∆∞:", steps.vanThu);
      console.log(">>> T·ªïng L√£nh ƒë·∫°o V·ª•:", steps.lanhDaoVu);
      console.log(">>> T·ªïng L√£nh ƒë·∫°o Ph√≤ng:", steps.lanhDaoPhong);
      console.log(">>> T·ªïng C√¥ng ch·ª©c ph·ª• tr√°ch:", steps.congChuc);

      return steps;
    }
    function exportExcelSharePointFormat() {
      // Thu th·∫≠p to√†n b·ªô step/sub
      const rows = [];
      processData.forEach((step, s) => {
        step.sub.forEach((row, r) => {
          const rowId = `s${s}r${r}`;
          rows.push({
            step: step.title,
            noidung: row.noidung,
            nguoi: row.nguoi || "",
            xuly: row.xuly || "",
            cho: row.cho || "",
            res: document.getElementById(`res-${rowId}`).value || "",
            time: document.getElementById(`time-text-${rowId}`).textContent || "",
            decision: document.getElementById(`decision-${rowId}`).textContent || ""
          });
        });
      });

      // Sinh REF
      const now = new Date();
      const pad = n => n.toString().padStart(2, "0");
      const ref = `TCCB5.003_${pad(now.getDate())}${pad(now.getMonth() + 1)}${now.getFullYear()}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;

      // G√≥i to√†n b·ªô rows v√†o 1 JSON string
      const jsonString = JSON.stringify(rows);

      // T·∫°o duy nh·∫•t 1 d√≤ng
      const excelData = [{
        REF: ref,
        DATA: jsonString,
        DEPT: document.getElementById("deptName")?.textContent.replace("Ph√≤ng: ", "").trim() || "",
        QUYTRINH: document.querySelector("h1")?.textContent.trim() || ""
      }];

      // Xu·∫•t Excel
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(excelData);
      XLSX.utils.book_append_sheet(wb, ws, "QuyTrinh");
      XLSX.writeFile(wb, "quytrinh.xlsx");
    }
    document.getElementById("processSelect")
      .addEventListener("change", e => window.location.href = e.target.value);



    // ‚úÖ RENDER PROCESS T·ª™ JSON PH·∫≤NG (thay cho renderProcess c≈©)
    function renderProcessFromJson() {
      const processData = window.processData || [];  // ‚öôÔ∏è l·∫•y d·ªØ li·ªáu to√†n c·ª•c
      const tableContainer = document.getElementById("processTable");

      if (!tableContainer) {
        console.error("‚ùå Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ #processTable trong DOM.");
        return;
      }

      if (!Array.isArray(processData) || processData.length === 0) {
        tableContainer.innerHTML = `<p>‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu quy tr√¨nh ƒë·ªÉ hi·ªÉn th·ªã.</p>`;
        return;
      }

      console.log("üìã [Render] B·∫Øt ƒë·∫ßu render", processData.length, "b∆∞·ªõc quy tr√¨nh");

      // üß© B·∫Øt ƒë·∫ßu d·ª±ng HTML b·∫£ng
  let html = `
  <table class="process-table-inner">
    <thead>
      <tr>
        <th>N·ªôi dung th·ª±c hi·ªán</th>
        <th>Ng∆∞·ªùi th·ª±c hi·ªán/Ph√™ duy·ªát</th>
        <th>Ng√†y g·ª≠i</th>
        <th>ƒê∆°n v·ªã nh·∫≠n</th>
        <th>Th·ªùi gian x·ª≠ l√Ω</th>
        <th>Th·ªùi gian ch·ªù</th>
        <th>K·∫øt qu·∫£</th>
        <th>Ng√†y ho√†n th√†nh</th>
        <th>Quy·∫øt ƒë·ªãnh</th>
      </tr>
    </thead>
    <tbody>
  `;

  processData.forEach((step, s) => {
    html += `<tr class="step-title"><td colspan="12"><b>${step.title || `B∆∞·ªõc ${s + 1}`}</b></td></tr>`;
    if (!step.sub || !Array.isArray(step.sub)) return;

    step.sub.forEach((row, r) => {
      const id = `s${s}r${r}`;
      const dropdown = getDropdownHTML(row.donviNhan);

      html += `
      <tr class="${(s === 0 && r === 0) ? '' : 'hidden'}" id="${id}">
        <td>${row.noidung || ''}</td>
        <td>${row.nguoi || ''}</td>
        <td id="ngaygui-${id}"></td>
        <td>${dropdown}</td>
        <td>${row.xuly || ''}</td>
        <td>${row.cho || ''}</td>
        <td>
          <textarea class="result-input" id="res-${id}" placeholder="Nh·∫≠p k·∫øt qu·∫£"></textarea>
      `;

      // ‚öôÔ∏è Decision logic gi·ªØ nguy√™n
      if (row.buttons && Array.isArray(row.buttons) && row.buttons.length >= 2) {
        const [positiveLabel, negativeLabel] = row.buttons;
        html += `
          <div id="decision-choices-${id}">
            <button class="btn btn-next" onclick="chooseDecision('${id}',${s},${r},true)">${positiveLabel}</button>
            <button class="btn btn-next" onclick="chooseDecision('${id}',${s},${r},false)">${negativeLabel}</button>
          </div>
          <div id="decision-time-${id}" class="hidden">
            <button class="btn btn-next" onclick="decisionStepNow('${id}',${s},${r})">‚è±</button>
            <button class="btn btn-next" onclick="decisionStepManual('${id}',${s},${r})">üìÖ</button>
          </div>
        `;
      } else {
        html += `
          <button class="btn btn-next" onclick="completeStepNow('${id}',${s},${r})">‚è±</button>
          <button class="btn btn-next" onclick="completeStepManual('${id}',${s},${r})">üìÖ</button>
        `;
      }

      html += `
        </td>
        <td>
          <div class="time-wrapper">
            <input type="datetime-local" id="time-${id}" class="time-input" onchange="applyManualTime('${id}')">
            <span id="time-text-${id}"></span>
            <span id="time-icon-${id}" class="time-icon hidden" onclick="openTimeInput('${id}')">üïí</span>
          </div>
        </td>
        <td id="decision-${id}"></td>
      </tr>
      `;
    });
  });

  html += `</tbody></table>`;
  tableContainer.innerHTML = html;

  console.log("‚úÖ [Render] Ho√†n t·∫•t render quy tr√¨nh");
}

function chooseDecision(id, s, r, isPositive) {
  console.groupCollapsed(`[chooseDecision] id=${id}, s=${s}, r=${r}, isPositive=${isPositive}`);

  // üß© L·∫•y th√¥ng tin step hi·ªán t·∫°i
  const row = processData[s]?.sub?.[r] || {};
  const stepType = row.type || "normal";

  // üß© ∆Øu ti√™n l·∫•y text t·ª´ buttons trong data (n·∫øu c√≥)
  const buttons = row.buttons && Array.isArray(row.buttons) && row.buttons.length >= 2
    ? row.buttons
    : stepType === "decision3"
      ? ["Th·ªëng nh·∫•t", "Ch∆∞a th·ªëng nh·∫•t"]
      : ["Ph√π h·ª£p", "Ch∆∞a ph√π h·ª£p"];

  // üß† X√°c ƒë·ªãnh text ƒë∆∞·ª£c ch·ªçn
  const choiceText = isPositive ? buttons[0] : buttons[1];

  // üîπ L∆∞u tr·∫°ng th√°i t·∫°m th·ªùi
  const decisionEl = document.getElementById(`decision-${id}`);
  if (decisionEl) {
    decisionEl.dataset.choice = choiceText;
    decisionEl.textContent = choiceText;
  }

  // üîπ ·∫®n nh√≥m n√∫t ch·ªçn
  document.getElementById(`decision-choices-${id}`)?.classList.add("hidden");

  // üîπ Hi·ªán c·ª•m ch·ªçn th·ªùi gian (‚è±üìÖ)
  document.getElementById(`decision-time-${id}`)?.classList.remove("hidden");

  console.log(`üü¢ [Decision] ${choiceText} ‚Üí ch·ªù ch·ªçn th·ªùi gian`);
  console.groupEnd();
}


    // === L·∫•y REF t·ª´ URL ===
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }



// === Import t·ª´ Cloud theo REF (Flow ph·∫£i h·ªó tr·ª£ query REF) ===
async function importFromCloudByRef(ref) {
  console.groupCollapsed(`üåê [importFromCloudByRef] B·∫Øt ƒë·∫ßu import REF="${ref}"`);

  if (!ref) {
    
    console.groupEnd();
    return;
  }

  try {
    // ‚öôÔ∏è G·ªçi Flow k√®m REF
    const FLOW_URL_BASE =
      "https://default460cecfbf0c64dd7a5ec66ef4d75ae.63.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/835980df6c0a4b5892289dcbc334ef50/triggers/manual/paths/invoke";
    const FLOW_SIG =
      "?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=YJ4F3Gm_-Z5fPBUfteIeNr5YK-Kg_6C3OyKIvqXfj1M";
    const url = `${FLOW_URL_BASE}${FLOW_SIG}&ref=${encodeURIComponent(ref)}`;

    console.log("üåê G·ªçi Flow:", url);
    const res = await fetch(url, { method: "GET" });
    if (!res.ok) throw new Error(`HTTP ${res.status}: ${res.statusText}`);

    const raw = (await res.text()).trim();
    console.log("üì¶ Raw:", raw.slice(0, 300));

    // ‚úÖ Parse JSON (k·ªÉ c·∫£ double encode)
    let data;
    try {
      data = JSON.parse(raw);
    } catch {
      data = JSON.parse(JSON.parse(raw));
    }

    if (!Array.isArray(data) || !data.length)
      throw new Error("Flow kh√¥ng tr·∫£ d·ªØ li·ªáu h·ª£p l·ªá.");
    const item = data[0];

    const quytrinhName = item.QUYTRINH_NAME || item["T√äN QUY TR√åNH"] || "";
    const dataRaw = item.DATA || "[]";

    console.log("üîπ QUYTRINH_NAME:", quytrinhName);
    console.log("üîπ DATA (raw):", dataRaw.slice(0, 200));

    // ‚úÖ 1. ƒê·ª£i dropdown render ƒë·∫ßy ƒë·ªß
    const select = document.getElementById("processSelectChiTiet");
    if (!select) throw new Error("Kh√¥ng t√¨m th·∫•y dropdown #processSelectChiTiet");

    console.log("‚è≥ ƒêang ch·ªù dropdown quy tr√¨nh render...");
    await new Promise(resolve => {
      const maxWait = 8000;
      const start = Date.now();
      const timer = setInterval(() => {
        if (select.options.length > 1) {
          clearInterval(timer);
          console.log("‚úÖ Dropdown quy tr√¨nh ƒë√£ s·∫µn s√†ng.");
          resolve();
        } else if (Date.now() - start > maxWait) {
          clearInterval(timer);
          console.warn("‚ö†Ô∏è Dropdown ch∆∞a s·∫µn sau 8s, ti·∫øp t·ª•c import...");
          resolve();
        }
      }, 300);
    });

    // ‚úÖ 2. Ch·ªçn option kh·ªõp t√™n
    const match = Array.from(select.options).find(
      o => o.textContent.trim().toLowerCase() === quytrinhName.trim().toLowerCase()
    );

    if (match) {
      console.log("‚úÖ [Auto-select] Kh·ªõp quy tr√¨nh:", match.textContent);
      select.value = match.value;
      select.dispatchEvent(new Event("change"));
    } else {
      console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y option kh·ªõp t√™n:", quytrinhName);
    }

    // ‚úÖ 3. C·∫≠p nh·∫≠t ti√™u ƒë·ªÅ
    const h1 = document.querySelector("h1");
    if (h1) h1.textContent = quytrinhName || ref;

    // ‚úÖ 4. ƒê·ª£i b·∫£ng render xong (inner table)
    console.log("‚è≥ ƒêang ch·ªù b·∫£ng #processTable render...");
    await new Promise(resolve => {
      const maxWait = 6000;
      const start = Date.now();
      const timer = setInterval(() => {
        const tbl = document.getElementById("processTable");
        if (tbl && tbl.querySelectorAll("tr").length > 1) {
          clearInterval(timer);
          console.log("‚úÖ B·∫£ng #processTable ƒë√£ render xong!");
          resolve();
        } else if (Date.now() - start > maxWait) {
          clearInterval(timer);
          console.warn("‚è∞ H·∫øt th·ªùi gian ch·ªù render b·∫£ng.");
          resolve();
        }
      }, 300);
    });

    // ‚úÖ 5. Parse d·ªØ li·ªáu DATA t·ª´ SharePoint
    let parsedData = [];
    try {
      parsedData = typeof dataRaw === "string" ? JSON.parse(dataRaw) : dataRaw;
    } catch (err) {
      console.warn("‚ö†Ô∏è DATA kh√¥ng parse ƒë∆∞·ª£c JSON:", err);
    }

    // ‚úÖ 6. G·ªçi render v√† fill d·ªØ li·ªáu
    if (Array.isArray(parsedData) && parsedData.length) {
      console.log("üìä parseDecodedToTable(parsedData)", parsedData);

      // üü© ƒê·∫£m b·∫£o b·∫£ng inner ƒë∆∞·ª£c render tr∆∞·ªõc
      if (typeof renderProcessFromJson === "function") {
        renderProcessFromJson();
      }

      // üü© Sau ƒë√≥ fill d·ªØ li·ªáu t·ª´ng d√≤ng t·ª´ SharePoint
      if (typeof hydrateFromSharePointData === "function") {
        hydrateFromSharePointData(parsedData);
      } else if (typeof parseDecodedToTable === "function") {
        parseDecodedToTable(parsedData);
      } else {
        console.table(parsedData);
        
      }

      // üü¢ NEW: ƒê·ªìng b·ªô l·∫°i tr·∫°ng th√°i v√†o processData ƒë·ªÉ c√≥ th·ªÉ PATCH ng∆∞·ª£c
      if (window.processData) {
        parsedData.forEach(item => {
          const stepIndex = window.processData.findIndex(
            s => (s.title || s.step || "").trim().toLowerCase() === (item.step || "").trim().toLowerCase()
          );
          if (stepIndex < 0) return;
          const subIndex = window.processData[stepIndex].sub.findIndex(
            sub => (sub.noidung || "").trim() === (item.noidung || "").trim()
          );
          if (subIndex < 0) return;

          window.processData[stepIndex].sub[subIndex] = {
            ...window.processData[stepIndex].sub[subIndex],
            ...item
          };
        });

        console.log("üîÅ processData ƒë√£ ƒë∆∞·ª£c sync v·ªõi SharePoint");
      }
    } else {
      console.warn("‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu DATA h·ª£p l·ªá trong SharePoint.");
    }

   
  } catch (err) {
    console.error("üí• L·ªói importFromCloudByRef:", err);
    
  } finally {
    console.groupEnd();
  }
}







    function formatDate(d) {
      return d.toLocaleDateString("vi-VN", { day: "2-digit", month: "2-digit", year: "numeric" }) + " " +
        d.toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }

    function lockStep(id, s, r) {
      document.getElementById(`res-${id}`).readOnly = true;
      document.querySelectorAll(`#${id} .btn-next`).forEach(btn => btn.classList.add("hidden"));

      // ‚úÖ Ch·ªâ hi·ªán n√∫t ch·ªânh s·ª≠a n·∫øu ƒë√£ c√≥ d·ªØ li·ªáu
      const res = document.getElementById(`res-${id}`).value.trim();
      const time = document.getElementById(`time-text-${id}`).textContent.trim();
      const decision = document.getElementById(`decision-${id}`).textContent.trim();


    }

    // ‚öôÔ∏è V√¨ b·∫°n render t·ª´ B∆∞·ªõc 2, ta c·ªông offset ƒë·ªÉ map ƒë√∫ng index


    function showNext(id, s, r) {
      console.groupCollapsed(`[showNext] id=${id}, s=${s}, r=${r}`);

      const step = processData[s];
      if (!step) {
        console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y step:", s);
        console.groupEnd();
        return;
      }

      // üëâ Ki·ªÉm tra n·∫øu c√≤n d√≤ng k·∫ø trong c√πng step
      const nextRow = document.getElementById(`s${s}r${r + 1}`);
      if (nextRow) {
        console.log("‚û°Ô∏è M·ªü ti·∫øp d√≤ng c√πng b∆∞·ªõc:", `s${s}r${r + 1}`);
        nextRow.classList.remove("hidden");
        updateSummary();
        console.groupEnd();
        return;
      }

      // üß© N·∫øu kh√¥ng c√≥ d√≤ng k·∫ø ‚Üí m·ªü b∆∞·ªõc k·∫ø
      const nextStepIndex = s + 1;
      const nextStep = processData[nextStepIndex];
      console.log("üü¢ Th·ª≠ m·ªü b∆∞·ªõc k·∫ø ti·∫øp:", nextStepIndex);

      if (nextStep) {
        const rid = `s${nextStepIndex}r0`;
        const rowEl = document.getElementById(rid);
        if (rowEl) {
          rowEl.classList.remove("hidden");

          document.getElementById(`decision-${rid}`).textContent = "";
          document.getElementById(`time-text-${rid}`).textContent = "";

          const stepType = nextStep.sub?.[0]?.type || "normal";
          console.log("üìå nextStep.type:", stepType);

          if (stepType === "decision2" || stepType === "decision3") {
            document.getElementById(`decision-choices-${rid}`)?.classList.remove("hidden");
            document.getElementById(`decision-time-${rid}`)?.classList.add("hidden");
          } else {
            rowEl.querySelectorAll(".btn-next").forEach(btn => {
              btn.classList.remove("hidden");
              btn.style.display = "inline-flex";
            });
          }
        }
      } else {
        console.warn("‚ö†Ô∏è Kh√¥ng c√≥ b∆∞·ªõc ti·∫øp theo (h·∫øt quy tr√¨nh)");
      }

      updateSummary();
      console.groupEnd();
    }

    // Gi·ªØ ƒë·ªìng b·ªô v·ªõi showNext


    function editStep(id, s, r, nguoi) {
      console.groupCollapsed("[editStep] START");
      console.log("‚ñ∂Ô∏è id:", id, "| s:", s, "| r:", r, "| nguoi:", nguoi);

      if (!confirm("‚ö†Ô∏è S·ª≠a b∆∞·ªõc n√†y? C√°c b∆∞·ªõc sau s·∫Ω b·ªã x√≥a.")) return;

      const pass = prompt(`Nh·∫≠p passcode (t√™n ng∆∞·ªùi: ${nguoi})`);
      if (pass !== nguoi) {
        alert("‚ùå Sai passcode");
        console.groupEnd();
        return;
      }

      // 1Ô∏è‚É£ Reset to√†n b·ªô b∆∞·ªõc sau
      for (let i = s; i < processData.length; i++) {
        const step = processData[i];
        if (!step?.sub) continue;

        for (let j = (i === s ? r : 0); j < step.sub.length; j++) {
          const rid = `s${i}r${j}`;
          const row = document.getElementById(rid);
          if (!row) continue;

          // reset n·ªôi dung
          const resEl = document.getElementById(`res-${rid}`);
          if (resEl) {
            resEl.removeAttribute("readonly");
            resEl.value = "";
          }
          document.getElementById(`time-text-${rid}`).textContent = "";
          document.getElementById(`decision-${rid}`).textContent = "";
          document.getElementById(`time-${rid}`).value = "";

          // ·∫©n c·ª•m cha
          document.getElementById(`decision-choices-${rid}`)?.classList.add("hidden");
          document.getElementById(`decision-time-${rid}`)?.classList.add("hidden");

          document.getElementById(`time-icon-${rid}`)?.classList.add("hidden");

          // ·∫©n to√†n d√≤ng tr·ª´ d√≤ng hi·ªán t·∫°i
          if (!(i === s && j === r)) row.classList.add("hidden");
        }
      }

      // 2Ô∏è‚É£ M·ªü l·∫°i d√≤ng hi·ªán t·∫°i
      const curRow = document.getElementById(id);
      if (!curRow) return;

      curRow.classList.remove("hidden");
      document.getElementById(`res-${id}`)?.removeAttribute("readonly");

      document.getElementById(`decision-${id}`).textContent = "";
      document.getElementById(`time-text-${id}`).textContent = "";

      // 3Ô∏è‚É£ X√°c ƒë·ªãnh lo·∫°i b∆∞·ªõc hi·ªán t·∫°i
      const stepType = processData[s]?.sub?.[r]?.type || "normal";
      console.log("üìå stepType:", stepType);

      const choicesEl = document.getElementById(`decision-choices-${id}`);
      const timeEl = document.getElementById(`decision-time-${id}`);

      // 4Ô∏è‚É£ Hi·ªán c·ª•m t∆∞∆°ng ·ª©ng cho b∆∞·ªõc n√†y
      if (stepType === "decision2" || stepType === "decision3") {
        console.log("üü° L√† b∆∞·ªõc decision ‚Üí b·∫≠t l·∫°i c·ª•m ch·ªçn quy·∫øt ƒë·ªãnh");
        choicesEl?.classList.remove("hidden");
        timeEl?.classList.add("hidden");

        // G·∫Øn l·∫°i onclick
        const btns = choicesEl?.querySelectorAll("button") || [];
        btns.forEach(btn => {
          const isOk =
            btn.textContent.includes("Ph√π h·ª£p") ||
            btn.textContent.includes("Th·ªëng nh·∫•t");
          btn.onclick = () => chooseDecision(id, s, r, isOk);
          btn.style.pointerEvents = "auto";
        });
      } else {
        console.log("üü¢ L√† b∆∞·ªõc th∆∞·ªùng ‚Üí b·∫≠t l·∫°i c·ª•m ‚è±üìÖ");
        if (timeEl) {
          timeEl.classList.remove("hidden");
          const btns = timeEl.querySelectorAll(".btn-next");
          btns.forEach(btn => {
            btn.classList.remove("hidden");
            btn.style.display = "inline-flex";
            btn.style.pointerEvents = "auto";

            // ph·ª•c h·ªìi onclick g·ªëc
            const oldOnClick = btn.getAttribute("onclick");
            if (oldOnClick) {
              btn.onclick = new Function(oldOnClick.replace(/^javascript:/, ""));
            }
          });
        }
      }

      // 5Ô∏è‚É£ X√°c ƒë·ªãnh b∆∞·ªõc k·∫ø ti·∫øp h·ª£p l·ªá ƒë·ªÉ m·ªü (n·∫øu c√≥)
      const nextStep = processData[s]?.sub?.[r + 1]
        ? `s${s}r${r + 1}`
        : processData[s + 1]
          ? `s${s + 1}r0`
          : null;

      if (nextStep) {
        const nextRow = document.getElementById(nextStep);
        if (nextRow) {
          nextRow.classList.remove("hidden");
          console.log("‚û°Ô∏è B·∫≠t b∆∞·ªõc k·∫ø ti·∫øp:", nextStep);
        }
      } else {
        console.log("‚ö™ Kh√¥ng c√≥ b∆∞·ªõc k·∫ø ti·∫øp");
      }

      console.log("‚úÖ Ho√†n t·∫•t kh√¥i ph·ª•c c·ª•m n√∫t cho d√≤ng", id);
      console.groupEnd();
      updateSummary();
    }



    // ===== Parse dd/MM/yyyy HH:mm:ss =====
    function parseVNDate(str) {
      if (!str) return null;

      // Match dd/MM/yyyy HH:mm[:ss] (c·∫£ 24h v√† 12h c√≥ AM/PM)
      const m = str.match(
        /(\d{2})\/(\d{2})\/(\d{4})\s+(\d{1,2}):(\d{2})(?::(\d{2}))?(?:\s*(AM|PM))?/i
      );
      if (!m) return null;

      const d = parseInt(m[1], 10);
      const mo = parseInt(m[2], 10) - 1;
      const y = parseInt(m[3], 10);
      let hh = parseInt(m[4], 10);
      const mm = parseInt(m[5], 10);
      const ss = m[6] ? parseInt(m[6], 10) : 0;
      const ampm = m[7] ? m[7].toUpperCase() : null;

      if (ampm) {
        if (ampm === "PM" && hh < 12) hh += 12;
        if (ampm === "AM" && hh === 12) hh = 0;
      }

      return new Date(y, mo, d, hh, mm, ss);
    }

    function fmt(sec) {
      const d = Math.floor(sec / 86400); sec %= 86400;
      const h = Math.floor(sec / 3600); sec %= 3600;
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${d} ng√†y ${h} gi·ªù ${m} ph√∫t ${s} gi√¢y`;
    }

    // ===== Summary: t√≠nh theo ng∆∞·ªùi, l·∫•y m·ªëc m·ªõi nh·∫•t =====


    // (tu·ª≥ ch·ªçn) g·ªôp t√™n ch·ª©c v·ª• v·ªÅ d·∫°ng chu·∫©n ƒë·ªÉ tr√°nh l·ªách ch√≠nh t·∫£
    function canonicalRole(role) {
      const t = normalize(role || "");
      if (t.includes("van thu")) return "VƒÉn th∆∞";
      if (t.includes("l√£nh ƒë·∫°o v·ª•") || t.includes("lanh dao vu")) return "L√£nh ƒë·∫°o V·ª•";
      if (t.includes("l√£nh ƒë·∫°o ph√≤ng") || t.includes("lanh dao phong") || t.includes("truong phong") || t.includes("pho truong phong"))
        return "L√£nh ƒë·∫°o Ph√≤ng";
      if (t.includes("c√¥ng ch·ª©c") || t.includes("cong chuc")) return "C√¥ng ch·ª©c ph·ª• tr√°ch";
      return role?.trim() || "";
    }

    // format g·ªçn: b·ªè b·ªõt s·ªë 0 ƒë·∫ßu
    function fmtCompact(sec) {
      sec = Math.max(0, Math.floor(sec));
      const d = Math.floor(sec / 86400); sec %= 86400;
      const h = Math.floor(sec / 3600); sec %= 3600;
      const m = Math.floor(sec / 60); const s = sec % 60;
      const parts = [];
      if (d) parts.push(`${d} ng√†y`);
      if (h || parts.length) parts.push(`${h} gi·ªù`);
      if (m || parts.length) parts.push(`${m} ph√∫t`);
      if (s || parts.length === 0) parts.push(`${s} gi√¢y`);
      return parts.join(" ");
    }

    function updateSummary() {
      // 1) Thu timeline s·ª± ki·ªán ƒëang hi·ªÉn th·ªã
      const events = [];
      document.querySelectorAll("#processTable tbody tr:not(.step-title)").forEach(tr => {
        if (tr.classList.contains("hidden")) return;  // ch·ªâ t√≠nh row ƒë√£ m·ªü
        const cells = tr.querySelectorAll("td");
        if (!cells.length) return;

        const roleRaw = cells[1]?.textContent.trim(); // c·ªôt 2 = Ch·ª©c v·ª• / Ng∆∞·ªùi th·ª±c hi·ªán
        const role = canonicalRole(roleRaw);
        const timeStr = tr.querySelector("span[id^='time-text-']")?.textContent.trim();
        if (!role || !timeStr) return;

        const dt = parseVNDate(timeStr);              // d√πng parseVNDate ƒë√£ s·ª≠a nh·∫≠n 24h & AM/PM
        if (!dt) return;

        events.push({ role, time: dt });
      });

      if (events.length < 2) { document.getElementById("summary").innerHTML = ""; return; }

      // 2) S·∫Øp theo th·ªùi gian tƒÉng d·∫ßn
      events.sort((a, b) => a.time - b.time);

      // 3) C·ªông d·ªìn th·ªùi l∆∞·ª£ng theo quy t·∫Øc: m·ªói row ƒÉn kho·∫£ng (row_i ‚Üí row_{i+1})
      const totals = new Map(); // role -> gi√¢y
      const counts = new Map(); // role -> s·ªë ƒëo·∫°n ƒë·∫£m nhi·ªám
      const order = [];         // th·ª© t·ª± xu·∫•t hi·ªán l·∫ßn ƒë·∫ßu (ƒë·ªÉ render ƒë·∫πp)

      for (let i = 0; i < events.length - 1; i++) {
        const cur = events[i];
        const next = events[i + 1];
        const diff = (next.time - cur.time) / 1000;
        if (diff < 0) continue; // b·ªè n·∫øu d·ªØ li·ªáu l√πi th·ªùi gian

        if (!totals.has(cur.role)) { totals.set(cur.role, 0); order.push(cur.role); }
        totals.set(cur.role, totals.get(cur.role) + diff);
        counts.set(cur.role, (counts.get(cur.role) || 0) + 1);
      }

      // 4) Render b·∫£ng t·ªïng h·ª£p theo ch·ª©c v·ª•
      let html = `<h2>‚è± T·ªïng th·ªùi gian theo ch·ª©c v·ª• (c·ªông d·ªìn to√†n tr√¨nh)</h2>
                <table id="summaryTable">
                  <tr><th>Ch·ª©c v·ª•</th><th>T·ªïng th·ªùi gian</th><th>S·ªë ƒëo·∫°n ƒë·∫£m nhi·ªám</th></tr>`;

      for (const role of order) {
        if (!totals.has(role)) continue;
        html += `<tr>
                <td>${role}</td>
                <td>${fmtCompact(totals.get(role))}</td>
                <td>${counts.get(role) || 0}</td>
              </tr>`;
      }

      const totalOverall = (events[events.length - 1].time - events[0].time) / 1000;
      html += `<tr><th colspan="2">T·ªïng quy tr√¨nh</th><th>${fmtCompact(totalOverall)}</th></tr>`;
      html += `</table>`;

      document.getElementById("summary").innerHTML = html;
    }
    // ===== Export CSV (ch·ªâ export row ƒëang hi·ªÉn th·ªã) =====



    // L·∫•y th·ªùi gian cu·ªëi c√πng ƒë√£ c√≥ tr∆∞·ªõc b∆∞·ªõc hi·ªán t·∫°i
    function getLastTimeBefore(s, r) {
      for (let i = s; i >= 0; i--) {
        const rows = processData[i].sub;
        for (let j = (i === s ? r - 1 : rows.length - 1); j >= 0; j--) {
          const txt = document.getElementById(`time-text-s${i}r${j}`);
          if (txt && txt.textContent) {
            return parseVNDate(txt.textContent);
          }
        }
      }
      return null;
    }
    function applyManualTime(id) {
      const inp = document.getElementById(`time-${id}`);
      const txt = document.getElementById(`time-text-${id}`);

      if (inp.value) {
        const dt = new Date(inp.value);

        const match = id.match(/s(\d+)r(\d+)/);
        const s = parseInt(match[1]), r = parseInt(match[2]);
        const last = getLastTimeBefore(s, r);
        if (last && dt <= last) {
          alert("‚ùå Th·ªùi gian ph·∫£i l·ªõn h∆°n c√°c b∆∞·ªõc tr∆∞·ªõc!");
          inp.value = "";
          return;
        }

        txt.textContent = formatDate(dt);
        document.getElementById(`time-icon-${id}`).classList.add("hidden");

        // ·∫®n c√°c n√∫t thao t√°c, ch·ªâ c√≤n n√∫t ch·ªânh s·ª≠a
        document.querySelectorAll(`#${id} .btn-next`).forEach(btn => btn.classList.add("hidden"));
        document.getElementById(`res-${id}`).readOnly = true;


        const choice = document.getElementById(`decision-${id}`).dataset.choice;
        if (choice) {
          const isPositive = (choice === "Ph√π h·ª£p" || choice === "Th·ªëng nh·∫•t");
          finishDecision(id, s, r, isPositive);
        } else {  
          showNext(id, s, r);
          updateSummary();
        }
      } else {
        txt.textContent = "";
      }
    }

    function openTimeInput(id) {
      const inp = document.getElementById(`time-${id}`);
      if (inp.showPicker) {
        inp.showPicker();   // Chrome
      } else {
        inp.click();        // fallback
      }
    }
// üß© T·ª± ƒë·ªông ch·ªçn quy tr√¨nh khi record ƒëang edit c√≥ QUYTRINH_NAME tr√πng SharePoint
function autoSelectProcessChiTiet(row) {
  let attempts = 0;

  const timer = setInterval(() => {
    const drop = document.getElementById("processSelectChiTiet");
    const listStr = sessionStorage.getItem("processListChiTiet");
    attempts++;

    if (!drop || !listStr) {
      console.log("‚è≥ [autoSelectProcessChiTiet] ƒêang ch·ªù dropdown ho·∫∑c processListChiTiet...");
      if (attempts > 10) {
        clearInterval(timer);
        console.warn("‚õî H·∫øt th·ªùi gian ch·ªù load processListChiTiet.");
      }
      return;
    }

    clearInterval(timer);

    const list = JSON.parse(listStr);
    const normalize = s => s.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase().trim();

    // üîπ T√™n quy tr√¨nh t·ª´ record ƒëang edit
    const queryName = (row.QUYTRINH_NAME || row.quytrinh || "").trim();
    if (!queryName) {
      console.warn("‚ö†Ô∏è Kh√¥ng c√≥ QUYTRINH_NAME trong record ‚Üí b·ªè qua auto-select");
      return;
    }

    const normQuery = normalize(queryName);

    // üîπ So kh·ªõp v·ªõi QUYTRINH_NAME ho·∫∑c TEN QUY TR√åNH t·ª´ SharePoint
    const found = list.find(x =>
      normalize(x.QUYTRINH_NAME || x.ten || "") === normQuery ||
      normalize(x.maSo || "") === normQuery
    );

    if (found) {
      // ‚úÖ Set dropdown
      drop.value = found.maSo || "";

      // ‚úÖ L·∫•y text hi·ªÉn th·ªã t·ª´ dropdown (ch√≠nh l√† h1)
      const selectedText = drop.selectedOptions[0]?.textContent?.trim() || found.QUYTRINH_NAME || "";
      const h1 = document.querySelector("h1");
      if (h1) h1.textContent = selectedText;

      // ‚úÖ Render d·ªØ li·ªáu quy tr√¨nh
      window.processData = found.steps || [];
      renderProcessFromJson();

      console.log(`üü¢ Auto ch·ªçn quy tr√¨nh: [${found.maSo}] ${selectedText}`);
    } else {
      console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y quy tr√¨nh kh·ªõp t√™n:", queryName);
    }
  }, 500);
}
    function saveProcess(ref) {
      const data = {
        ref: ref,
        steps: [],
        summary: document.getElementById("summary").innerHTML
      };

      processData.forEach((step, s) => {
        step.sub.forEach((row, r) => {
          const id = `s${s}r${r}`;
          const res = document.getElementById(`res-${id}`).value;
          const time = document.getElementById(`time-text-${id}`).textContent;
          const decision = document.getElementById(`decision-${id}`).textContent;
          data.steps.push({
            step: step.title,
            noidung: row.noidung,
            nguoi: row.nguoi,
            xuly: row.xuly || "",
            cho: row.cho || "",
            res, time, decision
          });
        });
      });

      // üîÑ l∆∞u v√†o sessionStorage thay v√¨ localStorage
      let store = JSON.parse(sessionStorage.getItem("processStore") || "[]");
      store.push(data);
      sessionStorage.setItem("processStore", JSON.stringify(store));

      alert("‚úÖ ƒê√£ l∆∞u quy tr√¨nh (phi√™n hi·ªán t·∫°i) v·ªõi REF: " + ref);
    }

    document.addEventListener("DOMContentLoaded", () => {
      console.groupCollapsed("üöÄ DOMContentLoaded");

      // 1Ô∏è‚É£ L·∫•y token key
      const savedToken = sessionStorage.getItem("tokenKey");
      if (savedToken) {
        window.tokenKey = savedToken;
        console.log("üîë TokenKey ƒë√£ kh√¥i ph·ª•c:", window.tokenKey.slice(0, 10) + "...");
      } else {
        console.warn("‚ö†Ô∏è Ch∆∞a c√≥ TOKEN_KEY trong sessionStorage");
      }

      // 2Ô∏è‚É£ L·∫•y mode + selectedRow + ref
      const mode = sessionStorage.getItem("mode");
      const dataStr = sessionStorage.getItem("selectedRow");
      const refQuery = getQueryParam("ref");
      console.log("üí¨ mode =", mode, "| selectedRow =", !!dataStr, "| refQuery =", refQuery);

      // 3Ô∏è‚É£ Ch·∫ø ƒë·ªô NEW
      if (mode === "new") {
        console.log("üÜï Ch·∫ø ƒë·ªô NEW ‚Üí hi·ªÉn th·ªã form ch·ªçn quy tr√¨nh ban ƒë·∫ßu");
        document.getElementById("processSelectWrapper").classList.remove("hidden");
        const first = document.getElementById("s0r0");
        if (first) first.classList.remove("hidden");
        console.groupEnd();
        return;
      }

      // 4Ô∏è‚É£ Ch·∫ø ƒë·ªô EDIT (ƒë∆∞·ª£c g·ªçi t·ª´ homepage)
      // 4Ô∏è‚É£ Ch·∫ø ƒë·ªô EDIT (ƒë∆∞·ª£c g·ªçi t·ª´ homepage)
if (mode === "edit") {
  console.log("‚úèÔ∏è Ch·∫ø ƒë·ªô EDIT t·ª´ sessionStorage");
  document.getElementById("processSelectWrapper").classList.add("hidden");

  if (dataStr) {
    const row = JSON.parse(dataStr);
    console.log("üì¶ ƒêang load selectedRow t·ª´ session:", row);

    // ===============================
    // üîπ L·∫•y d·ªØ li·ªáu ph·ª• trong session
    // ===============================
    const chitiet = JSON.parse(sessionStorage.getItem("chitietData") || "{}");
    const ykien = JSON.parse(sessionStorage.getItem("ykienData") || "[]");
    const rawLuan = JSON.parse(sessionStorage.getItem("luanchuyenData") || "[]");
    const edoc = JSON.parse(sessionStorage.getItem("edocData") || "[]");

    // ===============================
    // üîπ Chu·∫©n h√≥a luanchuyenData
    // ===============================
    const luan = rawLuan.map(raw => ({
      nguoi_gui:      raw["ƒê∆°n v·ªã nh·∫≠n"]      || "",
      don_vi_nhan:    raw["Ng∆∞·ªùi nh·∫≠n"]       || "",
      nguoi_nhan:     raw["Th·ªùi gian g·ª≠i"]    || "",
      thoi_gian_gui:  raw["Th·ªùi gian nh·∫≠n"]   || "",
      thoi_gian_nhan: raw["M√¥i tr∆∞·ªùng"]       || "",
      trang_thai:     raw["L√Ω do"]            || "",
      ly_do:          "",
      ref: raw.ref ?? ""
    }));

    console.log("üí¨ luanchuyenData (chu·∫©n h√≥a):", luan);
    setTimeout(() => {
  console.log("üîç G·ªçi extractPhongDauMoi sau khi ƒë√£ c√≥ luanchuyenData th·∫≠t:", luan.length, "d√≤ng");
  const phong = extractPhongDauMoi(luan);
  console.log("üè¢ K·∫øt qu·∫£ extractPhongDauMoi =", phong);
}, 200);
    console.log("üìä chitiet =", chitiet);
    console.log("üí¨ ykienData =", ykien.length, "| luanchuyenData =", luan.length, "| edocData =", edoc.length);

    // ===============================
// üîç T√¨m ph√≤ng trong luanchuyenData d·ª±a theo "Ph√≤ng" + "ƒê·∫ßu m·ªëi"
let dept = "Kh√¥ng x√°c ƒë·ªãnh";

if (Array.isArray(luan) && luan.length > 0) {
  const cleanText = s =>
    (s || "")
      .normalize("NFD")
      .replace(/[\u0300-\u036f]/g, "") // b·ªè d·∫•u ti·∫øng Vi·ªát
      .replace(/\s+/g, " ") // g·ªôp space, tab, xu·ªëng d√≤ng
      .replace(/\n/g, " ")
      .trim()
      .toLowerCase();

  console.groupCollapsed("üîé Ki·ªÉm tra t·ª´ng d√≤ng t√¨m 'Ph√≤ng ... - ƒê·∫ßu m·ªëi'");
  let matched = null;

  luan.forEach((item, i) => {
    const val = cleanText(item.nguoi_nhan);
    if (val.includes("phong") && val.includes("dau moi")) {
      matched = item;
      console.log(`‚úÖ [${i}] Match:`, item.nguoi_nhan);
    } else if (val.includes("phong")) {
      console.log(`‚ö†Ô∏è [${i}] C√≥ 'phong' nh∆∞ng thi·∫øu 'dau moi':`, item.nguoi_nhan);
    } else if (val.includes("dau moi")) {
      console.log(`‚ö†Ô∏è [${i}] C√≥ 'dau moi' nh∆∞ng thi·∫øu 'phong':`, item.nguoi_nhan);
    }
  });
  console.groupEnd();

  if (matched) {
    let raw = (matched.nguoi_nhan || "").replace(/\s+/g, " ").trim();

    // C·∫Øt ra ph·∫ßn "Ph√≤ng ..." n·∫øu c√≥
    const found = raw.match(/(Ph√≤ng|Phong)[^-\n]+/i);
    if (found) {
      dept = found[0].replace(/Phong/i, "Ph√≤ng").trim();
    } else {
      dept = matched.don_vi_nhan?.trim() || "Kh√¥ng x√°c ƒë·ªãnh";
    }

    console.log("üè¢ Ph√≤ng x√°c ƒë·ªãnh:", dept, "‚Üí t·ª´ d√≤ng:", matched);
  } else {
    console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y d√≤ng ch·ª©a 'ph√≤ng' v√† 'ƒë·∫ßu m·ªëi'");
  }
} else {
  console.warn("‚ö†Ô∏è luanchuyenData kh√¥ng h·ª£p l·ªá:", luan);
}

// üîπ Chu·∫©n h√≥a t√™n ph√≤ng qua normalizeDept()
dept = normalizeDept(dept);

// üîπ C·∫≠p nh·∫≠t giao di·ªán
document.getElementById("deptName").textContent = "Ph√≤ng: " + dept + " - ƒê·∫ßu m·ªëi";
console.log("‚úÖ K·∫øt qu·∫£ cu·ªëi c√πng:", dept);

    // ===============================
    // üîπ Render b·∫£ng chi ti·∫øt & d·ªØ li·ªáu ph·ª•
    // ===============================
    document.getElementById("detailWrapper").innerHTML =
      renderChiTiet(chitiet) +
      renderYKienTable(ykien) +
      renderLuanChuyenTable(luan);

    // ===============================
    // üîπ Ch·ªçn l·∫°i quy tr√¨nh chi ti·∫øt (dropdown)
    // ===============================
    setTimeout(() => {
      const quytrinhName = row.quytrinh?.trim() || "";
      if (!quytrinhName) {
        console.warn("‚ö†Ô∏è Kh√¥ng c√≥ t√™n quy tr√¨nh trong row.quytrinh");
        return;
      }

      const drop = document.getElementById("processSelectChiTiet");
      const listStr = sessionStorage.getItem("processListChiTiet");

      if (!drop || !listStr) {
        console.warn("‚ö†Ô∏è Ch∆∞a c√≥ dropdown ho·∫∑c danh s√°ch quy tr√¨nh trong sessionStorage");
        return;
      }

      const list = JSON.parse(listStr);
      const found = list.find(
        x => x.ten.toLowerCase().trim() === quytrinhName.toLowerCase().trim()
      );

      if (found) {
        drop.value = found.maSo;
        console.log("üü¢ Ch·ªçn s·∫µn quy tr√¨nh:", found.ten);
        document.querySelector("h1").textContent = found.ten;

        window.processData = found.steps;
        renderProcessFromJson();
      } else {
        console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y quy tr√¨nh kh·ªõp t√™n:", quytrinhName);
      }
    }, 800);

    // ===============================
    // üîπ Render quy tr√¨nh ch√≠nh
    // ===============================
    renderProcessFromJson();

    // N·∫øu ch∆∞a c√≥ edocData ‚Üí import l·∫°i
    if (!sessionStorage.getItem("edocData") || edoc.length === 0) {
      console.warn("‚ö†Ô∏è Kh√¥ng c√≥ edocData trong sessionStorage ‚Üí t·ª± import t·ª´ Cloud theo REF:", row.ref);
      importFromCloudByRef(row.ref);
    } else {
      console.log("‚úÖ C√≥ edocData trong sessionStorage, kh√¥ng c·∫ßn import l·∫°i");
    }

    console.groupEnd();
    return;
  }

  // ===============================
  // üîπ Fallback khi kh√¥ng c√≥ selectedRow
  // ===============================
  if (refQuery) {
    console.log("üîç Kh√¥ng c√≥ selectedRow ‚Üí l·∫•y theo refQuery:", refQuery);
    document.getElementById("processSelectWrapper").classList.add("hidden");
    document.getElementById("refDisplay").textContent = "REF: " + refQuery;
    importFromCloudByRef(refQuery);
  } else {
    console.warn("‚ö†Ô∏è Kh√¥ng c√≥ selectedRow v√† kh√¥ng c√≥ refQuery ‚Üí kh√¥ng th·ªÉ load d·ªØ li·ªáu");
  }

  console.groupEnd();
  return;
}


      // 5Ô∏è‚É£ M·∫∑c ƒë·ªãnh (auto load theo ref tr√™n URL)
      console.log("‚ÑπÔ∏è Kh√¥ng c√≥ mode ‚Üí auto load theo ref tr√™n URL n·∫øu c√≥");
      document.getElementById("processSelectWrapper").classList.add("hidden");

      if (refQuery) {
        console.log("üîç Auto import theo REF tr√™n URL:", refQuery);
        document.getElementById("refDisplay").textContent = "REF: " + refQuery;
        importFromCloudByRef(refQuery);
      } else {
        console.warn("‚ö†Ô∏è Kh√¥ng c√≥ REF trong URL ‚Üí trang ƒëang ·ªü tr·∫°ng th√°i r·ªóng");
      }

      console.groupEnd();
    });



    // ================== TOKEN ==================
    // Bi·∫øn to√†n c·ª•c l∆∞u key
    window.tokenKey = "";

    // Import Token t·ª´ CSV ho·∫∑c TXT
    function importToken(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (evt) {
        const text = evt.target.result.trim();

        const lines = text.split(/\r?\n/);
        const header = lines[0].split(",");

        const idx = header.findIndex(h => h.toUpperCase().includes("TOKEN_KEY"));
        if (idx >= 0 && lines.length > 1) {
          // l·∫•y token t·ª´ d√≤ng 2
          const cols = lines[1].split(",");
          window.tokenKey = cols[idx].replace(/^"|"$/g, "").trim();
        } else {
          // file ch·ªâ ch·ª©a token d·∫°ng txt
          window.tokenKey = text.replace(/^"|"$/g, "").trim();
        }

        document.getElementById("currentToken").textContent = "üîë Token hi·ªán t·∫°i: " + window.tokenKey;
        alert("‚úÖ ƒê√£ n·∫°p TOKEN_KEY: " + window.tokenKey);
      };
      reader.readAsText(file, "utf-8");
    }

    // Encode d·ªØ li·ªáu (xu·∫•t)
    function encodeData(obj) {
      if (!window.tokenKey || window.tokenKey.trim() === "") {
        alert("‚ö†Ô∏è Ch∆∞a c√≥ TOKEN_KEY, vui l√≤ng import tr∆∞·ªõc");
        return null;
      }

      try {
        // üîπ B1: Chu·ªói JSON g·ªëc
        const jsonStr = JSON.stringify(obj);

        // üîπ B2: Gh√©p th√™m TOKEN_KEY ƒë·ªÉ x√°c th·ª±c
        const combined = jsonStr + "::" + window.tokenKey.trim();

        // üîπ B3: M√£ ho√° Base64 (ch·ªâ 1 l·∫ßn)
        return btoa(unescape(encodeURIComponent(combined)));
      } catch (err) {
        console.error("‚ùå L·ªói encodeData:", err);
        alert("‚ùå L·ªói khi m√£ ho√° d·ªØ li·ªáu!");
        return null;
      }
    }


    // Decode d·ªØ li·ªáu (nh·∫≠p)
    function decodeData(base64) {
      try {
        // L√†m s·∫°ch chu·ªói Base64
        const clean = base64.replace(/[\r\n\s]/g, "").trim();

        // Gi·∫£i m√£ Base64 v·ªÅ m·∫£ng byte
        const binary = atob(clean);
        const bytes = new Uint8Array(binary.length);
        for (let i = 0; i < binary.length; i++) {
          bytes[i] = binary.charCodeAt(i);
        }

        // D√πng TextDecoder ƒë·ªÉ ƒë·ªçc UTF-8 ch√≠nh x√°c
        const decoder = new TextDecoder("utf-8");
        const decodedStr = decoder.decode(bytes);

        // N·∫øu chu·ªói tr√¥ng gi·ªëng JSON ‚Üí parse lu√¥n
        if (decodedStr.trim().startsWith("[") || decodedStr.trim().startsWith("{")) {
          return JSON.parse(decodedStr);
        }

        console.warn("‚ö†Ô∏è Kh√¥ng ph·∫£i JSON, tr·∫£ v·ªÅ chu·ªói thu·∫ßn");
        return decodedStr;
      } catch (err) {
        console.error("‚ùå L·ªói gi·∫£i m√£ Base64:", err);
        alert("‚ö†Ô∏è L·ªói gi·∫£i m√£ Base64 (chu·ªói kh√¥ng h·ª£p l·ªá ho·∫∑c sai m√£ h√≥a).");
        return null;
      }
    }

    function decodeDataDouble(base64) {
      const first = decodeData(base64);
      if (typeof first === "string" && /^[A-Za-z0-9+/=]+$/.test(first)) {
        return decodeData(first);
      }
      return first;
    }



    // ================== EXPORT ==================
    function exportRawJson() {
      // Thu th·∫≠p to√†n b·ªô step/sub (k·ªÉ c·∫£ hidden)
      const rows = [];
      processData.forEach((step, s) => {
        step.sub.forEach((row, r) => {
          const rowId = `s${s}r${r}`;
          rows.push({
            step: step.title,
            noidung: row.noidung,
            nguoi: row.nguoi || "",
            xuly: row.xuly || "",
            cho: row.cho || "",
            res: document.getElementById(`res-${rowId}`).value || "",
            time: document.getElementById(`time-text-${rowId}`).textContent || "",
            decision: document.getElementById(`decision-${rowId}`).textContent || ""
          });
        });
      });

      // T·∫°o ref d·∫°ng BB_ddMMyyyy_hhmmss
      const now = new Date();
      const pad = n => n.toString().padStart(2, "0");
      const ref = `TCCB5.003_${pad(now.getDate())}${pad(now.getMonth() + 1)}${now.getFullYear()}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;

      // G√≥i JSON {ref, rows}
      const output = { ref: ref, rows: rows };

      // Xu·∫•t file JSON
      const blob = new Blob([JSON.stringify(output, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = ref + ".json";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }


    // ================== IMPORT ENCODED ==================
    function importEncoded(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (evt) {
        const encoded = evt.target.result.trim();
        const data = decodeData(encoded);
        if (!data) return;
        parseDecodedToTable(data);
      };
      reader.readAsText(file, "utf-8");
    }
function hydrateFromSharePointData(data) {
  console.groupCollapsed("üìã [hydrateFromSharePointData] √Åp tr·∫°ng th√°i t·ª´ SharePoint DATA");

  let arr = typeof data === "string" ? JSON.parse(data) : data;
  if (!Array.isArray(arr)) {
    console.warn("‚ö†Ô∏è DATA kh√¥ng ph·∫£i m·∫£ng h·ª£p l·ªá");
    return;
  }

  arr.forEach((item) => {
    const step = item.step || "";
    const sIndex = window.processData.findIndex(
      s => (s.title || s.step || "").trim().toLowerCase() === step.trim().toLowerCase()
    );
    if (sIndex < 0) return;

    const rIndex = window.processData[sIndex]?.sub?.findIndex(
      sub => (sub.noidung || "").trim() === (item.noidung || "").trim()
    );
    if (rIndex < 0) return;

    const id = `s${sIndex}r${rIndex}`;
    const tr = document.getElementById(id);
    if (!tr) return;

    // ‚úÖ ·∫®n / hi·ªán h√†ng
    tr.classList.toggle("hidden", !!item.hidden);

    // ‚úÖ ƒêi·ªÅn d·ªØ li·ªáu
    const res = document.getElementById(`res-${id}`);
    const timeText = document.getElementById(`time-text-${id}`);
    const decisionCell = document.getElementById(`decision-${id}`);

    if (res) {
      res.value = item.res || "";
      res.readOnly = !!item.readonly || !!item.done;
    }
    if (timeText) timeText.textContent = item.time || "";
    if (decisionCell) decisionCell.textContent = item.decision || "";

    // ‚úÖ X·ª≠ l√Ω nh√≥m n√∫t
    const btns = tr.querySelectorAll("button");
    const decGroup = document.getElementById(`decision-choices-${id}`);
    const decTime = document.getElementById(`decision-time-${id}`);

    if (item.done || item.readonly) {
      // ·∫®n t·∫•t c·∫£ nh√≥m n√∫t
      btns.forEach(b => b.classList.add("hidden"));
      decGroup?.classList.add("hidden");
      decTime?.classList.add("hidden");
    } else {
      // B∆∞·ªõc decision: ch·ªâ hi·ªán nh√≥m l·ª±a ch·ªçn
      if (item.type === "decision2" || item.type === "decision3") {
        decGroup?.classList.remove("hidden");
        decTime?.classList.add("hidden");
      } else {
        // B∆∞·ªõc th∆∞·ªùng
        btns.forEach(b => b.classList.remove("hidden"));
      }
    }

    // ‚úÖ Hi·ªÉn th·ªã bi·ªÉu t∆∞·ª£ng ƒë·ªìng h·ªì n·∫øu c√≥ time
   // ‚úÖ Hi·ªÉn th·ªã bi·ªÉu t∆∞·ª£ng ƒë·ªìng h·ªì n·∫øu c√≥ time v√† b∆∞·ªõc ch∆∞a ho√†n t·∫•t
const timeIcon = document.getElementById(`time-icon-${id}`);
if (timeIcon) {
  if (item.time && !item.done && !item.readonly) {
    timeIcon.classList.remove("hidden");
  } else {
    timeIcon.classList.add("hidden");
  }
}

    // ‚úÖ M·ªü b∆∞·ªõc k·∫ø ti·∫øp n·∫øu done
    if (item.done && typeof showNext === "function") {
      showNext(id, sIndex, rIndex);
    }
  });

  console.log("‚úÖ Hydrate ho√†n t·∫•t theo tr·∫°ng th√°i SharePoint");
  console.groupEnd();
}



    // ================== APPLY DECODED DATA ==================
// ‚úÖ Hydrate l·∫°i b·∫£ng inner t·ª´ DATA (RES/TIME/DECISION) theo ƒë√∫ng step/sub
function parseDecodedToTable(rows) {
  console.groupCollapsed("üìã [parseDecodedToTable] Hydrate b·∫£ng inner");
  try {
    // 1) Chu·∫©n h√≥a input
    let dataArr = rows;
    if (typeof rows === "string") {
      try { dataArr = JSON.parse(rows); } catch(e) {
        console.error("‚ùå DATA kh√¥ng ph·∫£i JSON h·ª£p l·ªá:", e);
        alert("‚ö†Ô∏è D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá ƒë·ªÉ render");
        return;
      }
    }
    if (!Array.isArray(dataArr)) {
      console.warn("‚ö†Ô∏è DATA kh√¥ng ph·∫£i m·∫£ng, b·ªè qua");
      return;
    }

    // 2) B·∫£ng inner ph·∫£i t·ªìn t·∫°i r·ªìi (renderProcessFromJson ƒë√£ ch·∫°y)
    const table = document.querySelector("#processTable tbody");
    if (!table) {
      console.warn("‚ö†Ô∏è Ch∆∞a c√≥ b·∫£ng inner (#processTable) ‚Üí g·ªçi renderProcessFromJson tr∆∞·ªõc");
      if (typeof renderProcessFromJson === "function") renderProcessFromJson();
    }

    // 3) L·∫≠p bucket id cho t·ª´ng step theo processData (theo th·ª© t·ª±)
    const buckets = {}; // { stepKey: [{id,s,r}, ...] }
    const pd = (window.processData || []);
    const norm = (s) => (s || "").toString().trim().toLowerCase();

    pd.forEach((step, s) => {
      const key = norm(step.title || `B∆∞·ªõc ${s + 1}`);
      buckets[key] = (step.sub || []).map((_, r) => ({ id: `s${s}r${r}`, s, r }));
    });

    // 4) Hydrate t·ª´ng d√≤ng ƒë√£ l∆∞u
    dataArr.forEach((rowSaved, i) => {
      const stepKey = norm(rowSaved.step);
      const bucket = buckets[stepKey] || [];
      const item = bucket.shift();                // l·∫•y ƒë√∫ng h√†ng theo th·ª© t·ª± xu·∫•t
      if (!item) {
        console.warn("‚ö†Ô∏è Kh√¥ng match ƒë∆∞·ª£c id cho d√≤ng:", rowSaved);
        return;
      }

      const { id, s, r } = item;

      // üëâ M·ªü h√†ng hi·ªán t·∫°i
      const tr = document.getElementById(id);
      tr?.classList.remove("hidden");

      // üëâ ƒêi·ªÅn K·∫æT QU·∫¢
      const resEl = document.getElementById(`res-${id}`);
      if (resEl && rowSaved.res != null && rowSaved.res !== "") {
        resEl.value = rowSaved.res;
        resEl.readOnly = true;
      }

      // üëâ ƒêi·ªÅn NG√ÄY HO√ÄN TH√ÄNH (c·ªôt cu·ªëi c√πng c√≥ span time-text-*)
      const timeTxt = document.getElementById(`time-text-${id}`);
      const timeInp = document.getElementById(`time-${id}`);
      if (rowSaved.time) {
        timeTxt && (timeTxt.textContent = rowSaved.time);
        // ·∫®n icon m·ªü l·ªãch n·∫øu c√≥
        document.getElementById(`time-icon-${id}`)?.classList.add("hidden");
      }

      // üëâ ƒêi·ªÅn QUY·∫æT ƒê·ªäNH (n·∫øu c√≥)
      const decEl = document.getElementById(`decision-${id}`);
      if (rowSaved.decision) {
        decEl && (decEl.textContent = rowSaved.decision);
        // ·∫®n group ch·ªçn quy·∫øt ƒë·ªãnh/time picker c·ªßa b∆∞·ªõc decision
        document.getElementById(`decision-choices-${id}`)?.classList.add("hidden");
        document.getElementById(`decision-time-${id}`)?.classList.add("hidden");
      }

      // üëâ Kh√≥a thao t√°c c·ªßa h√†ng hi·ªán t·∫°i & m·ªü h√†ng k·∫ø ti·∫øp theo flow
      if (typeof lockStep === "function") lockStep(id, s, r);
      if (typeof showNext === "function")  showNext(id, s, r);
    });

    // 5) C·∫≠p nh·∫≠t b·∫£ng t·ªïng h·ª£p
    if (typeof updateSummary === "function") updateSummary();

    console.log(`‚úÖ Hydrate xong ${dataArr.length} d√≤ng`);
  } catch (err) {
    console.error("üí• parseDecodedToTable l·ªói:", err);
  } finally {
    console.groupEnd();
  }
}

    //Send to SharePoint via Power Automate
    // ================== EXPORT CLOUD ==================
function normalizeDept(rawDept = "") {
  if (!rawDept) return "";

  let dept = rawDept
    .normalize("NFD").replace(/[\u0300-\u036f]/g, "") // b·ªè d·∫•u ti·∫øng Vi·ªát
    .toLowerCase()
    .replace(/[()\-‚Äì_]/g, " ") // b·ªè k√Ω t·ª± ƒë·∫∑c bi·ªát
    .replace(/\s+/g, " ")
    .trim();

  if (dept.includes("to chuc tien luong") || dept.includes("tien luong tccb"))
    return "Ph√≤ng T·ªï ch·ª©c ti·ªÅn l∆∞∆°ng";
  if (dept.includes("thi dua") || dept.includes("khen thuong"))
    return "Ph√≤ng Thi ƒëua - Khen th∆∞·ªüng";
  if (dept.includes("can bo dia phuong") || dept.includes("dia phuong"))
    return "Ph√≤ng C√°n b·ªô ƒë·ªãa ph∆∞∆°ng";
  if (dept.includes("dao tao") || dept.includes("nguon nhan luc") || dept.includes("phat trien"))
    return "Ph√≤ng ƒê√†o t·∫°o v√† Ph√°t tri·ªÉn ngu·ªìn nh√¢n l·ª±c";
  if (dept.includes("to chuc can bo") || dept.includes("tccb"))
    return "V·ª• T·ªï ch·ª©c c√°n b·ªô";

  console.warn("‚ö†Ô∏è Dept ch∆∞a mapping:", rawDept);
  return rawDept.trim();
}


// ‚úÖ H√†m g·ª≠i d·ªØ li·ªáu sang SharePoint (c√≥ normalizeDept)
async function sendToSharePoint() {
  console.groupCollapsed("üì§ [sendToSharePoint] G·ª≠i d·ªØ li·ªáu sang SharePoint...");

  try {
    const rows = [];

    processData.forEach((step, s) => {
      step.sub.forEach((row, r) => {
        const rowId = `s${s}r${r}`;
        const rowEl = document.getElementById(rowId);
        const resInput = document.getElementById(`res-${rowId}`);
        const timeText = document.getElementById(`time-text-${rowId}`);
        const decisionText = document.getElementById(`decision-${rowId}`);
const donviSelect = document.getElementById(`donvinhan-${rowId}`);
        const isHidden = rowEl?.classList.contains("hidden") || false;
        const isDone = !!(timeText?.textContent || decisionText?.textContent);
        const isReadOnly = resInput?.readOnly || false;

        rows.push({
          step: step.title,
          noidung: row.noidung || "",
          nguoi: row.nguoi || "",
          xuly: row.xuly || "",
          cho: row.cho || "",
          donvinhan: donviSelect?.value || row.donvinhan || "", // ‚úÖ l·∫•y dropdown
          res: resInput?.value || "",
          time: timeText?.textContent || "",
          decision: decisionText?.textContent || "",
          hidden: isHidden,
          readonly: isReadOnly,
          done: isDone
        });
      });
    });

    // üîπ REF gi·ªØ l·∫°i n·∫øu ƒëang EDIT
    let ref = null;
    const selectedRow = sessionStorage.getItem("selectedRow");
    if (selectedRow) {
      try {
        const parsed = JSON.parse(selectedRow);
        if (parsed.ref) ref = parsed.ref;
      } catch (err) {
        console.warn("‚ö†Ô∏è selectedRow parse l·ªói:", err);
      }
    }

    // üîπ N·∫øu ch∆∞a c√≥ REF ‚Üí t·∫°o m·ªõi
    if (!ref) {
      const now = new Date();
      const pad = n => n.toString().padStart(2, "0");
      ref = `TCCB5.003_${pad(now.getDate())}${pad(now.getMonth() + 1)}${now.getFullYear()}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
    }

    // üîπ L·∫•y v√† quy chu·∫©n ph√≤ng ban
let deptRaw = document.getElementById("deptName")?.textContent.trim() || "";

// üß† Ch·ªâ b·ªè ph·∫ßn t√™n c√° nh√¢n, gi·ªØ ‚Äú- ƒê·∫ßu m·ªëi‚Äù, ‚Äú- Ph·ªëi h·ª£p‚Äù, ‚Äú- Ch·ªß tr√¨‚Äù
deptRaw = deptRaw.replace(/^Ph√≤ng:\s*/i, "");

// N·∫øu c√≥ d·∫°ng ‚ÄúT√™n ng∆∞·ªùi - ƒê·∫ßu m·ªëi‚Äù th√¨ gi·ªØ l·∫°i h·∫≠u t·ªë
if (!deptRaw.includes("Ph√≤ng") && !deptRaw.includes("V·ª•")) {
  // Tr∆∞·ªùng h·ª£p c√° nh√¢n: ‚ÄúL√™ Anh H·∫£o - ƒê·∫ßu m·ªëi‚Äù -> v·∫´n gi·ªØ ‚Äú- ƒê·∫ßu m·ªëi‚Äù
  const match = deptRaw.match(/^(.*?)(?=(\s-\s(ƒê·∫ßu m·ªëi|Ph·ªëi h·ª£p|Ch·ªß tr√¨))|$)/i);
  deptRaw = match ? match[0].trim() : deptRaw.trim();
} else {
  // C√≤n n·∫øu ƒë√£ l√† ‚ÄúPh√≤ng T·ªï ch·ª©c - Ti·ªÅn l∆∞∆°ng (TCCB) - ƒê·∫ßu m·ªëi‚Äù
  // th√¨ gi·ªØ nguy√™n, KH√îNG split '-'
  deptRaw = deptRaw.trim();
}

deptRaw = deptRaw.replace(/\s{2,}/g, " ");
if (!deptRaw) deptRaw = "Kh√¥ng x√°c ƒë·ªãnh";

const dept = normalizeDept(deptRaw);
console.log("üè¢ Ph√≤ng ban x√°c ƒë·ªãnh:", dept);

    // üîπ Th√¥ng tin quy tr√¨nh
    const drop = document.getElementById("processSelectChiTiet");
    const quytrinhCode = drop?.value || "";
    const quytrinhName = drop?.selectedOptions?.[0]?.textContent?.trim() || "";

    if (!quytrinhCode) {
      alert("‚ö†Ô∏è Vui l√≤ng ch·ªçn quy tr√¨nh tr∆∞·ªõc khi g·ª≠i l√™n SharePoint!");
      console.groupEnd();
      return;
    }

    // ‚úÖ Payload cu·ªëi c√πng
    const payload = {
      REF: ref,
      DEPT: dept,
      QUYTRINH_CODE: quytrinhCode,
      QUYTRINH_NAME: quytrinhName,
      DATA: rows,
      savedAt: new Date().toISOString()
    };

    console.log("üì¶ Payload g·ª≠i SharePoint:", payload);

    const flowUrl =
      "https://default460cecfbf0c64dd7a5ec66ef4d75ae.63.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/16754f7e54a04f2e9b8fb60caaaf33b4/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=aXhGTYEd9zepjAkPLtbU1nJvzosQwgmJlylq7riqiwA";

    const res = await fetch(flowUrl, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (res.ok) {
      console.log("‚úÖ G·ª≠i th√†nh c√¥ng:", await res.text());
      alert("‚úÖ ƒê√£ g·ª≠i d·ªØ li·ªáu tr·ª±c ti·∫øp sang SharePoint!");
      sessionStorage.removeItem("mode");
      window.close();
    } else {
      const text = await res.text();
      console.error("‚ùå L·ªói HTTP:", res.status, text);
      alert(`‚ùå L·ªói khi g·ª≠i: ${res.status} - ${text}`);
    }
  } catch (err) {
    console.error("üí• L·ªói khi g·ª≠i sang Flow:", err);
    alert("‚ùå Kh√¥ng th·ªÉ g·ª≠i d·ªØ li·ªáu: " + err.message);
  } finally {
    console.groupEnd();
  }
}




 // ‚úÖ Import t·ª´ Cloud (l·∫•y danh s√°ch quy tr√¨nh SharePoint v√† fill dropdown) ‚Äî c√≥ log chi ti·∫øt
async function importFromCloud() {
  if (!window.tokenKey || window.tokenKey.trim() === "") {
    alert("‚ö†Ô∏è B·∫°n ph·∫£i import TOKEN_KEY tr∆∞·ªõc!");
    return;
  }

  console.group("üåê importFromCloud");

  try {
    console.log("üîπ [STEP 1] G·ªçi Flow Power Automate...");
    const FLOW_URL =
      "https://default460cecfbf0c64dd7a5ec66ef4d75ae.63.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/835980df6c0a4b5892289dcbc334ef50/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=YJ4F3Gm_-Z5fPBUfteIeNr5YK-Kg_6C3OyKIvqXfj1M";

    // ‚ö†Ô∏è N·∫øu Flow c·ªßa b·∫°n d√πng Manual Trigger, th·ª≠ GET; n·∫øu HTTP Request th√¨ ƒë·ªïi th√†nh POST
    const res = await fetch(FLOW_URL, {
      method: "GET",
      headers: {
        "Content-Type": "application/json"
      }
    });

    console.log("üîπ [STEP 2] HTTP status:", res.status, res.statusText);
    console.log("üîπ [STEP 3] Response headers:", Object.fromEntries(res.headers.entries()));

    // üì¶ Th·ª≠ ƒë·ªçc raw text ƒë·ªÉ xem Flow tr·∫£ v·ªÅ g√¨
    const raw = await res.text();
    console.log("üì¶ [STEP 4] Raw response:", raw.slice(0, 500), raw.length > 500 ? "..." : "");

    if (!res.ok) {
      console.error("‚ùå [ERROR] Flow tr·∫£ m√£ l·ªói:", res.status);
      throw new Error(`HTTP ${res.status} - ${res.statusText}`);
    }

    // üß© Th·ª≠ parse JSON (k·ªÉ c·∫£ khi double encoded)
    let data;
    try {
      data = JSON.parse(raw);
    } catch (e1) {
      try {
        data = JSON.parse(JSON.parse(raw));
      } catch (e2) {
        console.error("‚ùå [ERROR] Kh√¥ng parse ƒë∆∞·ª£c JSON:", e1, e2);
        throw new Error("Flow kh√¥ng tr·∫£ v·ªÅ JSON h·ª£p l·ªá.");
      }
    }

    console.log("‚úÖ [STEP 5] ƒê√£ parse JSON, t·ªïng s·ªë quy tr√¨nh:", Array.isArray(data) ? data.length : 0);
    console.log("üî∏ [SAMPLE ITEM]", data[0]);

    if (!Array.isArray(data) || data.length === 0) {
      alert("‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu quy tr√¨nh tr·∫£ v·ªÅ t·ª´ Cloud.");
      console.groupEnd();
      return;
    }

    // üîπ Chu·∫©n h√≥a d·ªØ li·ªáu
    const list = data.map(item => ({
      maSo: item["M√É S·ªê"] || item["MASO"] || "",
      ten: (item["T√äN QUY TR√åNH"] || item["TENQUYTRINH"] || item["QUYTRINH_NAME"] || "").trim(),
      QUYTRINH_NAME: (item["QUYTRINH_NAME"] || item["T√äN QUY TR√åNH"] || item["TENQUYTRINH"] || "").trim(),
      steps: (() => {
        let rawSteps = item["STEP QUY TR√åNH"] || item["CAYQUYTRINH"] || "[]";
        try {
          const parsed = JSON.parse(rawSteps);
          return Array.isArray(parsed) ? parsed : JSON.parse(parsed);
        } catch (e) {
          console.warn("‚ö†Ô∏è [STEP parse l·ªói]", e);
          return [];
        }
      })()
    }));

    console.log("‚úÖ [STEP 6] Chu·∫©n h√≥a xong:", list.length, "items");
    sessionStorage.setItem("processListChiTiet", JSON.stringify(list));

    // üîπ Fill dropdown
    const select = document.getElementById("processSelectChiTiet");
    if (!select) {
      alert("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y dropdown #processSelectChiTiet tr√™n trang!");
      console.groupEnd();
      return;
    }

    select.innerHTML = `<option value="">-- Ch·ªçn quy tr√¨nh --</option>`;
    list.forEach(q => {
      const opt = document.createElement("option");
      opt.value = q.maSo;
      opt.textContent = q.QUYTRINH_NAME || q.ten || q.maSo;
      select.appendChild(opt);
    });
    console.log("‚úÖ [STEP 7] ƒê√£ fill dropdown th√†nh c√¥ng.");

    // üîπ Khi ng∆∞·ªùi d√πng ch·ªçn th·ªß c√¥ng
    select.onchange = e => {
      const maSo = e.target.value;
      if (!maSo) return;
      const found = list.find(x => x.maSo === maSo);
      if (!found) return;

      const h1 = document.querySelector("h1");
      if (h1) h1.textContent = found.QUYTRINH_NAME || found.ten || found.maSo;

      window.processData = found.steps;
      renderProcessFromJson();
    };

    // üîπ N·∫øu c√≥ record ƒëang edit ‚Üí auto ch·ªçn
    const selectedRow = sessionStorage.getItem("selectedRow");
    if (selectedRow) {
      try {
        const row = JSON.parse(selectedRow);
        console.log("üîπ [STEP 8] ƒêang auto ch·ªçn quy tr√¨nh cho record:", row.QUYTRINH_NAME);
        autoSelectProcessChiTiet(row);
      } catch (err) {
        console.warn("‚ö†Ô∏è L·ªói parse selectedRow:", err);
      }
    }

    alert("‚úÖ ƒê√£ import d·ªØ li·ªáu quy tr√¨nh t·ª´ Cloud!");
  } catch (err) {
    console.error("‚ùå [ERROR importFromCloud]:", err);
    alert("‚ùå L·ªói khi import t·ª´ Cloud: " + err.message);
  } finally {
    console.groupEnd();
  }
}


    renderProcessFromJson();
    // H√†m kh√≥a row eDoc (·∫©n n√∫t, readonly)
    function lockEdocRow(id) {
      document.getElementById(`time-icon-${id}`)?.classList.add("hidden");

      document.querySelectorAll(`#${id} .btn-next`).forEach(btn => btn.classList.add("hidden"));
      document.getElementById(`res-${id}`)?.setAttribute("readonly", true);
    }



    document.addEventListener("DOMContentLoaded", () => {
      const result = fillStepsFromEdoc(edocData, nhanSuPhong);

      // VƒÉn th∆∞ (1 record duy nh·∫•t)
      if (result.vanThu) {
        const id = "s0r0";
        document.getElementById(id).classList.remove("hidden");
        document.getElementById(`time-text-${id}`).textContent = result.vanThu.thoi_gian;
        document.getElementById(`ngaygui-${id}`).textContent = result.vanThu.thoi_gian;
        document.getElementById(`nguoigui-${id}`).textContent = result.vanThu.nguoi_gui;
        document.getElementById(`nguoinhan-${id}`).textContent = result.vanThu.nguoi_nhan;
        document.getElementById(`donvinhan-${id}`).textContent = result.vanThu.don_vi_nhan;

        lockEdocRow(id);
        showNext(id, 0, 0);
      }

      // L√£nh ƒë·∫°o V·ª• (nhi·ªÅu ng∆∞·ªùi ‚Üí clone nhi·ªÅu row)
      if (result.lanhDaoVu.length > 0) {
        const tbody = document.querySelector("#processTable tbody");
        const templateRow = document.getElementById("s0r1");

        result.lanhDaoVu.forEach((c, idx) => {
          const rowId = `s0r1r${idx}`;
          const row = document.createElement("tr");
          row.id = rowId;

          row.innerHTML = `
      <td>${c.noidung || "X·ª≠ l√Ω T·ªù tr√¨nh"}</td>
      <td>${c.chuc_vu || "L√£nh ƒë·∫°o V·ª•"}</td>
      <td id="ngaygui-${rowId}">${c.thoi_gian || ""}</td>
      <td id="nguoigui-${rowId}">${c.nguoi_gui || ""}</td>
      <td id="nguoinhan-${rowId}">${c.nguoi_nhan || ""}</td>
      <td id="donvinhan-${rowId}">${c.don_vi_nhan || ""}</td>
      <td>01 ng√†y</td>
      <td></td>
      <td></td>
      <td><textarea class="result-input" id="res-${rowId}" readonly placeholder="Nh·∫≠p k·∫øt qu·∫£"></textarea></td>
      <td><span id="time-text-${rowId}">${c.thoi_gian || ""}</span></td>
      <td id="decision-${rowId}"></td>
    `;

          tbody.insertBefore(row, templateRow.nextSibling);
          row.classList.remove("hidden");   // üëà ƒë·∫£m b·∫£o hi·ªán ra
          lockEdocRow(rowId);
        });

        // ·∫®n d√≤ng g·ªëc s0r1 (ch·ªâ l√†m template)
        templateRow.classList.add("hidden");

        // üëâ m·ªü ti·∫øp b∆∞·ªõc sau d·ª±a tr√™n timestamp m·ªõi nh·∫•t
        const lastTime = result.lanhDaoVu
          .map(c => parseVNDate(c.thoi_gian))
          .filter(Boolean)
          .reduce((a, b) => a > b ? a : b);

        if (lastTime) {
          showNext("s0r1r" + (result.lanhDaoVu.length - 1), 0, 1);
        }
      }

      // L√£nh ƒë·∫°o Ph√≤ng (1 record duy nh·∫•t)
      if (result.lanhDaoPhong) {
        const id = "s0r2";
        document.getElementById(id).classList.remove("hidden");
        document.getElementById(`time-text-${id}`).textContent = result.lanhDaoPhong.thoi_gian;
        document.getElementById(`ngaygui-${id}`).textContent = result.lanhDaoPhong.thoi_gian;
        document.getElementById(`nguoigui-${id}`).textContent = result.lanhDaoPhong.nguoi_gui;
        document.getElementById(`nguoinhan-${id}`).textContent = result.lanhDaoPhong.nguoi_nhan;
        document.getElementById(`donvinhan-${id}`).textContent = result.lanhDaoPhong.don_vi_nhan;

        lockEdocRow(id);
        showNext(id, 0, 2);
      }

      // C√¥ng ch·ª©c ph·ª• tr√°ch (nhi·ªÅu ng∆∞·ªùi ‚Üí clone nhi·ªÅu row)
      cloneRowsFromArray(result.congChuc, "s0r3", "C√¥ng ch·ª©c ph·ª• tr√°ch", "0,5 ng√†y", 0, 3);
    });
    function completeStepNow(id, s, r) {
      const now = new Date();
      const last = getLastTimeBefore(s, r);
      if (last && now <= last) {
        alert("‚ùå Th·ªùi gian ph·∫£i l·ªõn h∆°n c√°c b∆∞·ªõc tr∆∞·ªõc!");
        return;
      }

      document.getElementById(`time-${id}`).value = now.toISOString().slice(0, 16);
      document.getElementById(`time-text-${id}`).textContent = formatDate(now);

      // Kh√¥ng add hidden cho t·ª´ng n√∫t, ch·ªâ ·∫©n c·ª•m cha n·∫øu c√≥
      document.getElementById(`time-icon-${id}`)?.classList.add("hidden");

      lockStep(id, s, r);
      showNext(id, s, r);
    }


    function completeStepManual(id, s, r) {
      const inp = document.getElementById(`time-${id}`);
      if (inp.showPicker) {
        inp.showPicker();  // b·∫≠t l·ªãch ch·ªçn
      } else {
        inp.click();       // fallback cho browser kh√°c
      }
    }

    function decisionStepNow(id, s, r) {
      console.groupCollapsed(`[decisionStepNow] id=${id}, s=${s}, r=${r}`);

      const isPositive =
        document.getElementById(`decision-${id}`).dataset.choice === "Ph√π h·ª£p" ||
        document.getElementById(`decision-${id}`).dataset.choice === "Th·ªëng nh·∫•t";

      const now = new Date();
      const last = getLastTimeBefore(s, r);
      if (last && now <= last) {
        alert("‚ùå Th·ªùi gian ph·∫£i l·ªõn h∆°n c√°c b∆∞·ªõc tr∆∞·ªõc!");
        console.groupEnd();
        return;
      }

      // c·∫≠p nh·∫≠t th·ªùi gian
      document.getElementById(`time-${id}`).value = now.toISOString().slice(0, 16);
      document.getElementById(`time-text-${id}`).textContent = formatDate(now);

      // ch·ªâ ·∫©n c·ª•m cha (kh√¥ng add hidden v√†o t·ª´ng n√∫t)
      document.getElementById(`decision-time-${id}`)?.classList.add("hidden");

      finishDecision(id, s, r, isPositive);
      console.groupEnd();
    }


    function finishDecision(id, s, r, isPositive) {
  console.groupCollapsed(`[finishDecision] id=${id}, s=${s}, r=${r}, isPositive=${isPositive}`);

  const row = processData[s]?.sub?.[r] || {};
  const stepType = row.type || "";

  // üß© ∆Øu ti√™n l·∫•y text t·ª´ buttons trong data n·∫øu c√≥
  const buttons = row.buttons && Array.isArray(row.buttons) && row.buttons.length >= 2
    ? row.buttons
    : stepType === "decision3"
      ? ["Th·ªëng nh·∫•t", "Ch∆∞a th·ªëng nh·∫•t"]
      : ["Ph√π h·ª£p", "Ch∆∞a ph√π h·ª£p"];

  // üß† L·∫•y l·ª±a ch·ªçn th·ª±c t·∫ø (∆∞u ti√™n dataset.choice)
  const decisionEl = document.getElementById(`decision-${id}`);
  const choiceText = decisionEl?.dataset.choice || (isPositive ? buttons[0] : buttons[1]);

  // üîπ C·∫≠p nh·∫≠t hi·ªÉn th·ªã quy·∫øt ƒë·ªãnh
  if (decisionEl) {
    decisionEl.textContent = choiceText;
    decisionEl.classList.add("locked");
  }

  // üîπ ·∫®n c·ª•m ch·ªçn th·ªùi gian (‚è±üìÖ)
  document.getElementById(`decision-time-${id}`)?.classList.add("hidden");

  // üîπ Kh√≥a n·ªôi dung ph·∫£n h·ªìi
  document.getElementById(`res-${id}`)?.setAttribute("readonly", true);

  // üîπ L∆∞u l·∫°i quy·∫øt ƒë·ªãnh v√† th·ªùi gian v√†o data
  row.decision = choiceText;
  row.time = new Date().toLocaleString("vi-VN");

  // üîπ M·ªü b∆∞·ªõc k·∫ø ti·∫øp
  if (isPositive) {
    // m·ªü b∆∞·ªõc ƒë·∫ßu ti√™n c·ªßa step k·∫ø ti·∫øp
    document.getElementById(`s${s + 1}r0`)?.classList.remove("hidden");
  } else {
    // m·ªü d√≤ng k·∫ø trong c√πng step
    document.getElementById(`s${s}r${r + 1}`)?.classList.remove("hidden");
  }

  updateSummary();
  console.log(`‚úÖ [Finish Decision] ${choiceText}`);
  console.groupEnd();
}




    function decisionStepManual(id, s, r, isPositive) {
      const inp = document.getElementById(`time-${id}`);
      inp.dataset.decision = isPositive;
      if (inp.showPicker) {
        inp.showPicker();
      } else {
        inp.click();
      }
    }
// üß© Khi trang load, t·ª± ƒë·ªông l·∫•y ?ref=... tr√™n URL v√† g·ªçi importFromCloudByRef
document.addEventListener("DOMContentLoaded", () => {
  const urlParams = new URLSearchParams(window.location.search);
  const ref = urlParams.get("ref") || "";

  console.log("üöÄ DOM ready ‚Üí REF =", ref);
  if (ref) {
    importFromCloudByRef(ref);
  } else {
    console.warn("‚ö†Ô∏è Kh√¥ng c√≥ ref trong URL, b·ªè qua importFromCloudByRef()");
  }
});

window.addEventListener("DOMContentLoaded", () => {
  // üß© L·∫•y d·ªØ li·ªáu t·ª´ sessionStorage
  const row = JSON.parse(sessionStorage.getItem("selectedRow") || "{}");
  const chitiet = JSON.parse(sessionStorage.getItem("chitietData") || "{}");
  const ykien = JSON.parse(sessionStorage.getItem("ykienData") || "[]");
  const luanchuyen = JSON.parse(sessionStorage.getItem("luanchuyenData") || "[]");

  console.log("üì¶ Nh·∫≠n d·ªØ li·ªáu t·ª´ homepage:", { row, chitiet, ykien, luanchuyen });

  // üè¢ G√°n REF hi·ªÉn th·ªã
  const refEl = document.getElementById("refDisplay");
  if (refEl) {
    refEl.textContent = `REF: ${row.ref || chitiet.stt || "‚Äî"}`;
  }

  // üè¢ G√°n ph√≤ng ban hi·ªÉn th·ªã (∆∞u ti√™n row.dept, fallback t·ª´ luanchuyen)
  const deptEl = document.getElementById("deptName");
  if (deptEl) {
    const deptText = row.dept || extractPhongDauMoi(luanchuyen) || "‚Äî";
    deptEl.textContent = `Ph√≤ng: ${deptText}`;
  }

  // L∆∞u global n·∫øu c·∫ßn d√πng ti·∫øp
  window.currentRow = row;
  window.currentChitiet = chitiet;
  window.currentYkien = ykien;
  window.currentLuanchuyen = luanchuyen;
});

/** üß† H√†m t√¨m 'Ph√≤ng ƒë·∫ßu m·ªëi' trong d·ªØ li·ªáu lu√¢n chuy·ªÉn */
// helper: normalize like b·∫°n mu·ªën (gi·ªØ c√°c mapping c≈©)
function normalizeToSharePointDept(raw = "") {
  if (!raw) return "";

  const txt = raw
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "") // b·ªè d·∫•u
    .replace(/[()\-‚Äì_]/g, " ")
    .replace(/\s+/g, " ")
    .trim();

  if (txt.includes("to chuc tien luong") || txt.includes("tien luong tccb"))
    return "Ph√≤ng T·ªï ch·ª©c ti·ªÅn l∆∞∆°ng";
  if (txt.includes("thi dua") || txt.includes("khen thuong"))
    return "Ph√≤ng Thi ƒëua - Khen th∆∞·ªüng";
  if (txt.includes("can bo dia phuong") || txt.includes("dia phuong"))
    return "Ph√≤ng C√°n b·ªô ƒë·ªãa ph∆∞∆°ng";
  if (txt.includes("dao tao") || txt.includes("nguon nhan luc") || txt.includes("phat trien"))
    return "Ph√≤ng ƒê√†o t·∫°o v√† Ph√°t tri·ªÉn ngu·ªìn nh√¢n l·ª±c";
  if (txt.includes("to chuc can bo") || txt.includes("tccb"))
    return "V·ª• T·ªï ch·ª©c c√°n b·ªô";

  return raw.trim();
}

// t√¨m "Ph√≤ng ... - ƒê·∫ßu m·ªëi" trong luanchuyen array
function extractPhongDauMoi(luanchuyenData) {
  console.group("[extractPhongDauMoi] Debug chi ti·∫øt");

  let dept = "Kh√¥ng x√°c ƒë·ªãnh";

  if (Array.isArray(luanchuyenData)) {
    console.log(`üîé B·∫Øt ƒë·∫ßu qu√©t ${luanchuyenData.length} d√≤ng luanchuyenData`);

    for (let i = 0; i < luanchuyenData.length; i++) {
      const item = luanchuyenData[i];
      const raw =
        item.nguoi_nhan ||
        item["Ng∆∞·ªùi nh·∫≠n"] ||
        item["Th·ªùi gian g·ª≠i"] ||
        item["ƒê∆°n v·ªã nh·∫≠n"] ||
        "";

      const val = raw
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "")
        .replace(/ƒë/g, "d")
        .replace(/ƒê/g, "D")
        .replace(/\s+/g, " ")
        .trim()
        .toLowerCase();

      console.log(`üîç [${i}] raw="${raw}" ‚Üí val="${val}"`);

      // üéØ N·∫øu c√≥ "phong" v√† "dau moi"
      if (val.includes("phong") && val.includes("dau moi")) {
        console.log(`‚úÖ Kh·ªõp t·∫°i [${i}] ${raw}`);

        // üß© Regex m·ªü r·ªông ƒë·ªÉ l·∫•y to√†n c·ª•m "Ph√≤ng ... (TCCB)"
        const found =
          raw.match(/(Ph√≤ng|Phong)[^‚Äì‚Äî-]+(?:\(TCCB\))?/i)?.[0] ||
          raw.match(/(Ph√≤ng|Phong)[^‚Äì‚Äî-]+/i)?.[0];

        if (found) {
          dept = found
            .replace(/Phong/i, "Ph√≤ng")
            .replace(/\s{2,}/g, " ")
            .trim();
          break;
        }
      }

      // üîÅ fallback: n·∫øu c√≥ "TCCB" ho·∫∑c "Tien luong"
      if (val.includes("tccb") || val.includes("tien luong")) {
        const found =
          raw.match(/(Ph√≤ng|Phong)[^‚Äì‚Äî-]+/i)?.[0] ||
          raw.match(/(Ph√≤ng|Phong)[^(]+/i)?.[0];
        if (found) {
          dept = found.replace(/Phong/i, "Ph√≤ng").trim();
          console.log(`‚öôÔ∏è Fallback match t·∫°i [${i}] ‚Üí ${dept}`);
          break;
        }
      }
    }
  }

  console.log("üèÅ K·∫øt qu·∫£ cu·ªëi c√πng:", dept);
  console.groupEnd();
  return dept;
}
// ƒë·ªçc sessionStorage v√† c·∫≠p nh·∫≠t DOM
window.addEventListener("DOMContentLoaded", () => {
  console.group("‚öôÔ∏è DOMContentLoaded (detail page)");
  const selectedRaw = sessionStorage.getItem("selectedRow");
  const row = selectedRaw ? JSON.parse(selectedRaw) : {};
  console.log("üßæ selectedRow:", row);

  // ∆∞u ti√™n l·∫•y luanchuyenData t·ª´ selectedRow, fallback t·ª´ key ri√™ng
  const luanchuyen = row.luanchuyenData || JSON.parse(sessionStorage.getItem("luanchuyenData") || "[]");
  console.log("üì¶ luanchuyenData (effective):", luanchuyen);

  // hi·ªÉn th·ªã REF
  const refEl = document.getElementById("refDisplay");
  const refVal = row.ref || (row.chitietData && row.chitietData.stt) || "‚Äî";
  if (refEl) refEl.textContent = `REF: ${refVal}`;

  // hi·ªÉn th·ªã PH√íNG
  const deptEl = document.getElementById("deptName");
  if (deptEl) {
    const phong = extractPhongDauMoi(luanchuyen);
    deptEl.textContent = `Ph√≤ng: ${phong || "‚Äî"}`;
  } else {
    console.warn("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y ph·∫ßn t·ª≠ #deptName tr√™n trang");
  }

  console.groupEnd();
});                     


  </script>
</body>

</html>