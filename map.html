<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>VCB ATM Routing + Xe ch·∫°y</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind -->
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">

  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css" rel="stylesheet">

  <!-- Leaflet -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    #map { height: 100vh; width: 100%; }

    .number-icon {
      background: #ff5722; color: white; border-radius: 50%;
      text-align: center; font-weight: bold; font-size: 14px;
      line-height: 30px; width: 30px; height: 30px;
    }
    .tick-icon {
      position: relative; background: #2e7d32; color: white;
      border-radius: 50%; width: 34px; height: 34px;
      display: flex; justify-content: center; align-items: center;
      font-size: 18px; font-weight: bold;
      box-shadow: 0 0 8px rgba(0,128,0,0.6);
    }
    .tick-icon .badge {
      position: absolute; bottom: -6px; right: -6px;
      background: white; color: #2e7d32; font-size: 10px;
      font-weight: bold; border-radius: 50%; width: 16px; height: 16px;
      display: flex; justify-content: center; align-items: center;
      border: 1px solid #2e7d32;
    }

    #status-bar {
      position: absolute; top: 0; left: 0; right: 0;
      background: #2e7d32; color: #fff;
      font-size: 15px; font-weight: 500;
      padding: 10px 16px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      z-index: 1000;
    }
    #status-bar .route { font-size: 13px; margin-top: 4px; }
    #status-bar b { color: #ffd700; }

    /* Hi·ªáu ·ª©ng line ch·∫°y */
    .animated-route {
      stroke-dasharray: 12 18;
      animation: dashmove 1s linear infinite;
    }
    @keyframes dashmove {
      to { stroke-dashoffset: -30; }
    }
  </style>
</head>
<body class="bg-gray-100">
  <div id="map"></div>
  <div id="status-bar">
    <div id="status-text"><i class="fas fa-spinner fa-spin"></i> ƒêang t·∫£i b·∫£n ƒë·ªì...</div>
    <div id="route-info" class="route"></div>
  </div>

  <script>
    const startPoint = {id:"VCB H·∫£i Ph√≤ng", lat:20.8453891, lon:106.6815777};
    const atms = [
      {id: "10800964", lat: 20.833259, lon: 106.697571},
      {id: "10800945", lat: 20.694132, lon: 106.484218},
      {id: "10800946", lat: 20.813541, lon: 106.623697},
      {id: "10800970", lat: 20.833259, lon: 106.697571}, // tr√πng t·ªça ƒë·ªô
      {id: "10800920", lat: 20.941910, lon: 107.031156},
      {id: "10800912", lat: 20.820652, lon: 106.538555},
      {id: "10800904", lat: 20.795430, lon: 106.690935}
    ];
    const completedCount = 4;

    let map, routeLayer, markersLayer, carMarker, routeCoords;

    function distance(a, b) {
      const R = 6371;
      const dLat = (b.lat - a.lat) * Math.PI/180;
      const dLon = (b.lon - a.lon) * Math.PI/180;
      const lat1 = a.lat * Math.PI/180;
      const lat2 = b.lat * Math.PI/180;
      const x = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2);
      return R * 2 * Math.atan2(Math.sqrt(x), Math.sqrt(1-x));
    }

    function nearestRoute(start, points) {
      let route = [], unvisited = [...points], current = start;
      while (unvisited.length > 0) {
        let nearest = unvisited.reduce((min, p) =>
          distance(current, p) < distance(current, min) ? p : min
        );
        route.push(nearest);
        unvisited = unvisited.filter(p => p !== nearest);
        current = nearest;
      }
      return route;
    }

    async function buildRoute() {
      document.getElementById("status-text").innerHTML =
        "<i class='fas fa-spinner fa-spin'></i> ƒêang t√≠nh l·ªô tr√¨nh...";
      document.getElementById("route-info").textContent = "";

      if (!map) {
        map = L.map('map').setView([startPoint.lat, startPoint.lon], 11);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
      }

      if (routeLayer) map.removeLayer(routeLayer);
      if (markersLayer) markersLayer.clearLayers();
      markersLayer = L.layerGroup().addTo(map);

      const orderedATMs = nearestRoute(startPoint, atms);

      // Gom ATM c√πng t·ªça ƒë·ªô
      const coordMap = {};
      orderedATMs.forEach((atm, i) => {
        const key = atm.lat.toFixed(6)+","+atm.lon.toFixed(6);
        if (!coordMap[key]) coordMap[key] = [];
        coordMap[key].push({atm, order: i+1});
      });

      Object.values(coordMap).forEach(group => {
        const {lat, lon} = group[0].atm;
        let htmlPopup = group.map(g =>
          `ATMID: ${g.atm.id} (b∆∞·ªõc ${g.order})`
        ).join("<br>");
        let order = group[0].order;
        let icon;
        if (order <= completedCount) {
          icon = L.divIcon({
            className: "tick-icon",
            html: `<div>‚úî</div><div class="badge">${order}</div>`,
            iconSize: [34,34], iconAnchor: [17,17]
          });
        } else {
          icon = L.divIcon({
            className: "number-icon",
            html: order,
            iconSize: [30,30], iconAnchor: [15,15]
          });
        }
        L.marker([lat, lon], {icon}).addTo(markersLayer).bindPopup(htmlPopup);
      });

      // Marker start/end
      L.marker([startPoint.lat, startPoint.lon], {icon: L.icon({
        iconUrl: "https://cdn-icons-png.flaticon.com/512/190/190411.png",
        iconSize: [32, 32], iconAnchor: [16, 32]
      })}).addTo(markersLayer).bindPopup("<b>VCB H·∫£i Ph√≤ng (B·∫Øt ƒë·∫ßu/K·∫øt th√∫c)</b>");

      // OSRM route
      const coords = [[startPoint.lon, startPoint.lat]]
        .concat(orderedATMs.map(p => [p.lon, p.lat]))
        .concat([[startPoint.lon, startPoint.lat]]);
      const coordStr = coords.map(c => c.join(",")).join(";");
      const url = `https://router.project-osrm.org/route/v1/driving/${coordStr}?overview=full&geometries=geojson`;

      try {
        const res = await fetch(url);
        const data = await res.json();
        if (data.routes && data.routes.length > 0) {
          const route = data.routes[0];
          // V·∫Ω line v·ªõi class "animated-route"
          routeLayer = L.geoJSON(route.geometry, {
            style: {color: "blue", weight: 5, opacity: 1, className: "animated-route"}
          }).addTo(map);

          document.getElementById("status-text").innerHTML =
            `‚úÖ Ho√†n t·∫•t! T·ªïng qu√£ng ƒë∆∞·ªùng <b>${(route.distance/1000).toFixed(1)} km</b>`;

          // hi·ªÉn th·ªã ch·∫∑ng
          let routeHtml = `<b>VCB</b>`;
          route.legs.forEach((leg, i) => {
            const dist = (leg.distance/1000).toFixed(1);
            if (i < orderedATMs.length) {
              routeHtml += ` ‚Üí [${i+1}] ${orderedATMs[i].id} (${dist} km)`;
            } else {
              routeHtml += ` ‚Üí <b>VCB</b> (${dist} km)`;
            }
          });
          document.getElementById("route-info").innerHTML = routeHtml;

          // l∆∞u route ƒë·ªÉ animate xe
          routeCoords = route.geometry.coordinates.map(c => [c[1], c[0]]);
          animateCar();
        }
      } catch (err) {
        console.error("OSRM error", err);
        document.getElementById("status-text").textContent = "‚ùå L·ªói khi g·ªçi OSRM.";
      }
    }

    // animate xe
    function animateCar() {
      if (carMarker) map.removeLayer(carMarker);
      let i = 0;
      carMarker = L.marker(routeCoords[0], {
        icon: L.divIcon({
          html: "üöó",
          className: "",
          iconSize: [30,30],
          iconAnchor: [15,15]
        })
      }).addTo(map);

      setInterval(() => {
        if (!routeCoords || routeCoords.length === 0) return;
        i = (i+1) % routeCoords.length;
        carMarker.setLatLng(routeCoords[i]);
      }, 300); // t·ªëc ƒë·ªô: 300ms m·ªói b∆∞·ªõc
    }

    buildRoute();
  </script>
</body>
</html>
