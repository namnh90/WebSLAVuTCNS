<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WEB TH·ªêNG K√ä SLA</title>
    <style>
        :root {
            --bg: #ffffff;
            --nav: #f4ebdd;
            --text: #222;
            --card: #ffffff;
            --muted: #555;
            --accent: #a87d48;
            --accent-2: #d27d2d;
            --radius: 12px;
            --shadow: 0 4px 18px rgba(0, 0, 0, .08);
        }

        body {
            margin: 0;
            font-family: "Segoe UI", sans-serif;
            background: var(--bg);
            color: var(--text);
        }

        .navbar {
            background: linear-gradient(180deg, var(--nav) 0%, #ffffff 100%);
            color: var(--text);
            height: 70px;
            padding: 0 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .logo img {
            height: 60px;
            object-fit: contain;
        }

        .navbar h1 {
            margin: 0 20px;
            font-size: 20px;
            flex: 1;
        }

        .new-actions {
            position: relative;
        }

        .btn-new {
            background: var(--accent);
            color: #fff;
            border: 0;
            padding: 8px 14px;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .btn-new:hover {
            opacity: 0.9;
        }

        .new-menu {
            position: absolute;
            top: 110%;
            right: 0;
            background: #fff;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            display: flex;
            flex-direction: column;
            min-width: 900px;
            z-index: 100;
        }

        .new-menu a {
            padding: 12px 16px;
            text-decoration: none;
            color: var(--text);
            font-size: 14px;
        }

        .new-menu a:hover {
            background: #f9f6f0;
            color: var(--accent-2);
        }

        .hidden {
            display: none;
        }

        .layout {
            display: flex;
            min-height: calc(100vh - 70px);
        }

        .sidebar {
            width: 260px;
            background: #f9f6f0;
            border-right: 1px solid #ddd;
            padding: 20px;
            overflow-y: auto;
        }

        .sidebar h3 {
            margin-top: 0;
            font-size: 16px;
        }

        .sidebar ul {
            list-style: none;
            padding-left: 12px;
        }

        .sidebar li {
            margin: 6px 0;
            cursor: pointer;
        }

        .sidebar li.disabled {
            color: #bbb;
            cursor: not-allowed;
        }

        .sidebar li:hover:not(.disabled) {
            color: var(--accent-2);
        }

        .content {
            flex: 1;
            padding: 20px;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: var(--card);
            padding: 20px;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
        }

        .card h2 {
            margin: 0;
            font-size: 28px;
            color: var(--accent);
        }

        .card p {
            margin: 6px 0 0;
            font-size: 14px;
            color: var(--muted);
        }

        .action-bar {
            display: flex;
            justify-content: flex-end;
            /* ƒë·∫©y sang ph·∫£i */
            margin: 10px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            background: var(--card);
            box-shadow: var(--shadow);
            border-radius: var(--radius);
            overflow: hidden;
        }

        th,
        td {
            border: 1px solid #eee;
            padding: 10px;
            font-size: 14px;
            text-align: left;
        }

        th {
            background: #f9f6f0;
            color: var(--text);
        }

        .btn-orange {
            background: #ff9800;
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .btn-blue {
            background: #2196f3;
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .btn-green {
            background: green;
            color: #fff;
            border: none;
            padding: 8px 14px;
            border-radius: var(--radius);
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
        }

        .tree {
            list-style: none;
            padding-left: 0;
        }

        .tree li {
            margin: 6px 0;
        }

        .tree .dept-item {
            cursor: pointer;
            display: block;
            font-weight: 500;
        }

        .tree .dept-item:hover {
            color: var(--accent-2);
        }

        .tree .sub {
            list-style: none;
            padding-left: 18px;
            margin-top: 4px;
        }

        .tree .sub li {
            margin: 4px 0;
            cursor: pointer;
        }

        .tree .sub li:hover {
            color: var(--accent);
        }
    </style>
</head>

<body>
    <div class="navbar">
        <div class="logo"><img src="photo/logo-nhnnvn-3-1129x800.webp" alt="Logo"></div>
        <h1>WEB TH·ªêNG K√ä SLA</h1>
        <div class="new-actions" style="display: none;" >
            <button class="btn-green">‚ûï T·∫°o m·ªõi</button>
            <div class="new-menu hidden" id="newMenu">
                <a href="#" onclick="openProcessNew('test.html')">K·∫ø ho·∫°ch tuy·ªÉn d·ª•ng c√¥ng ch·ª©c lo·∫°i D t·∫°i c√°c NHNN chi
                    nh√°nh Khu v·ª±c</a>
                <a href="#" onclick="openProcessNew('test1.html')">C·ª≠ c√°n b·ªô ƒëi c√¥ng t√°c n∆∞·ªõc ngo√†i</a>
                <a href="#" onclick="openProcessNew('test2.html')">T·ªï ch·ª©c ƒë√≥n nh·∫≠n c√°c danh hi·ªáu thi ƒëua, h√¨nh th·ª©c
                    khen th∆∞·ªüng c·∫•p Nh√† N∆∞·ªõc, c·∫•p Ng√†nh</a>
                <a href="#" onclick="openProcessNew('test3.html')">Tri·ªÉn khai quy ho·∫°ch L√£nh ƒê·∫°o c·∫•p Ph√≤ng t·∫°i NHTW</a>
                <a href="#" onclick="openProcessNew('test4.html')">Ph√™ Duy·ªát ƒê·ªëi V·ªõi N√¢ng L∆∞∆°ng Th∆∞·ªùng Xuy√™n, Ph·ª• C·∫•p
                    Th√¢m Ni√™n V∆∞·ª£t Khung
                    Thu·ªôc Th·∫©m Quy·ªÅn V·ª• TCCB Duy·ªát K√Ω</a>
                <a href="#" onclick="openProcessNew('test5.html')">X√¢y d·ª±ng b√°o c√°o ƒë·ªãnh k·ª≥/ƒë·ªôt xu·∫•t/tham gia √Ω ki·∫øn/tr·∫£
                    l·ªùi ki·∫øn ngh·ªã g·ª≠i c√°c
                    ƒë∆°n v·ªã thu·ªôc NHNN do l√£nh ƒë·∫°o V·ª• TCCB duy·ªát k√Ω</a>
            </div>
        </div>
    </div>

    <div class="layout">
        <div class="sidebar">
            <h3>üè¢ Danh s√°ch vƒÉn b·∫£n ƒë·∫øn</h3>
            <ul id="deptMenu" class="tree">
                <li><span class="dept-item" onclick="filterDept('ALL')"><b>T·∫•t c·∫£</b></span></li>
                <li><span class="dept-item" onclick="toggleSub('sub-dept-1','ƒê√ÄO T·∫†O V√Ä PH√ÅT TRI·ªÇN NGU·ªíN NH√ÇN L·ª∞C')">üìÇ
                        VƒÉn b·∫£n ch∆∞a x·ª≠ l√Ω</span>
                    <ul id="sub-dept-1" class="sub hidden"></ul>
                </li>
                <li><span class="dept-item" onclick="toggleSub('sub-dept-2','THI ƒêUA KHEN TH∆Ø·ªûNG')">üìÇ VƒÉn b·∫£n ƒëang x·ª≠ l√Ω</span>
                    <ul id="sub-dept-2" class="sub hidden"></ul>
                </li>
                <li><span class="dept-item" onclick="toggleSub('sub-dept-3','C√ÅN B·ªò ƒê·ªäA PH∆Ø∆†NG')">üìÇ VƒÉn b·∫£n ƒë√£ x·ª≠ l√Ω</span>
                    <ul id="sub-dept-3" class="sub hidden"></ul>
                </li>
                
            </ul>
        </div>

        <div class="content">
            <div class="stats">
                <div class="card">
                    <h2 id="total">0</h2>
                    <p>T·ªïng s·ªë t·ªù tr√¨nh</p>
                </div>
                <div class="card">
                    <h2 id="completed">0</h2>
                    <p>ƒê√£ ho√†n th√†nh</p>
                </div>
                <div class="card">
                    <h2 id="pending">0</h2>
                    <p>ƒêang pending</p>
                </div>
                <div class="card">
                    <h2 id="avgTime">0 ng√†y</h2>
                    <p>Th·ªùi gian x·ª≠ l√Ω TB</p>
                </div>
                <div class="card">
                    <h2 id="sumStraight">0</h2>
                    <p>T·ªïng c√≤n l·∫°i (ch·∫°y th·∫≥ng)</p>
                </div>
                <div class="card">
                    <h2 id="sumConflict">0</h2>
                    <p>T·ªïng c√≤n l·∫°i (t·∫•t c·∫£ tr∆∞·ªùng h·ª£p d·ª± ki·∫øn)</p>
                </div>


            </div>
            <div class="action-bar">
                <button class="btn-blue" onclick="refreshDataHybrid()">üîÑ Refresh</button>
            </div>
            <table>
                <thead>
                    <tr>
                        <th>REF</th>
                        <th>Ph√≤ng ban</th>
                        <th>Quy tr√¨nh</th>
                        <th>B∆∞·ªõc hi·ªán t·∫°i</th>
                        <th>Th·ªùi gian ƒë√£ tr√¥i qua</th>
                        <th>∆Ø·ªõc t√≠nh th·ªùi gian c·∫ßn thi·∫øt (Ch·∫°y th·∫≥ng)</th>
                        <th>∆Ø·ªõc t√≠nh th·ªùi gian c·∫ßn thi·∫øt (C√≥ ph√°t sinh v·∫•n ƒë·ªÅ)</th>
                        <th>Nh√¢n s·ª± pending</th>
                        <th>H√†nh ƒë·ªông</th>
                    </tr>
                </thead>
                <tbody id="refTable"></tbody>
            </table>
        </div>
    </div>

    <script>
        // ‚úÖ Demo data (chu·∫©n h√≥a t·ª´ Sheet4 ‚Äì chia ri√™ng ykienData v√† luanchuyenData)
        const rawData = [{
    chitietData: {
      soVanBan: "1512/TCKT5",
      stt: "12933",
      ngayGuiDen: "03/10/2025",
      ngayVanBan: "03/10/2025",
      coQuanGui: "V·ª• T√†i ch√≠nh - K·∫ø to√°n",
      loaiVanBan: "C√¥ng vƒÉn",
      doMat: "Th∆∞·ªùng",
      doKhan: "Th∆∞·ªùng",
      trichYeu: "V/v L·ªô tr√¨nh tri·ªÉn khai gi√° d·ªãch v·ª• s·ª± nghi·ªáp c√¥ng",
      ghiChu: "",
      trangThaiND: "Ch∆∞a x·ª≠ l√Ω",
      trangThaiVB: "ƒêang x·ª≠ l√Ω",
      fileDinhKem: "1512-TCKT5-03102025.pdf"
    },
                ykienData: [
                    {
                        "Ng∆∞·ªùi b√∫t ph√™": "L√™ Anh H·∫£o",
                        "Th·ªùi gian": "30/09/2025 09:45 AM",
                        "N·ªôi dung": "K/c Quang xly, b/c c.Th·∫£o PTP (TL m·∫≠t ƒë√≠nh k√®m ng√†y 30/9 m·ªõi nh·∫≠n ƒë∆∞·ª£c)",
                        "Ph√≤ng ban ƒë·∫ßu m·ªëi": "",
                        "Ph√≤ng ban ph·ªëi h·ª£p": "",
                        "H·∫°n x·ª≠ l√Ω": "",
                        "col7": "",
                        "col8": "",
                        "col9": "",
                        "ref": 12933
                    },
                    {
                        "Ng∆∞·ªùi b√∫t ph√™": "L√™ Th·ªã Kim Oanh",
                        "Th·ªùi gian": "24/09/2025 08:04 AM",
                        "N·ªôi dung": "B√°o c√°o Tr∆∞·ªüng ph√≤ng, ƒë·∫øn h·∫øt ng√†y 23/9/2025, t√†i li·ªáu m·∫≠t ƒë√≠nh k√®m ch∆∞a g·ª≠i ƒë·∫øn V·ª• TCCB",
                        "Ph√≤ng ban ƒë·∫ßu m·ªëi": "",
                        "Ph√≤ng ban ph·ªëi h·ª£p": "",
                        "H·∫°n x·ª≠ l√Ω": "",
                        "col7": "",
                        "col8": "",
                        "col9": "",
                        "ref": 12933
                    },
                    {
                        "Ng∆∞·ªùi b√∫t ph√™": "L√™ Anh H·∫£o",
                        "Th·ªùi gian": "23/09/2025 20:06 PM",
                        "N·ªôi dung": "K/c Oanh r√† so√°t vb m·∫≠t ƒë√£ ƒë·∫øn V·ª• ch∆∞a",
                        "Ph√≤ng ban ƒë·∫ßu m·ªëi": "",
                        "Ph√≤ng ban ph·ªëi h·ª£p": "",
                        "H·∫°n x·ª≠ l√Ω": "",
                        "col7": "",
                        "col8": "",
                        "col9": "",
                        "ref": 12933
                    },
                    {
                        "Ng∆∞·ªùi b√∫t ph√™": "Nguy·ªÖn Anh Tu·∫•n",
                        "Th·ªùi gian": "23/09/2025 13:24 PM",
                        "N·ªôi dung": "K/ch Ph√≤ng TCTL ƒë·∫ßu m·ªëi nghi√™n c·ª©u, tham gia √Ω ki·∫øn.",
                        "Ph√≤ng ban ƒë·∫ßu m·ªëi": "Ph√≤ng T·ªï ch·ª©c ti·ªÅn l∆∞∆°ng",
                        "Ph√≤ng ban ph·ªëi h·ª£p": "",
                        "H·∫°n x·ª≠ l√Ω": "",
                        "col7": "",
                        "col8": "",
                        "col9": "",
                        "ref": 12933
                    },
                    {
                        "Ng∆∞·ªùi b√∫t ph√™": "Nguy·ªÖn Qu·ª≥nh Anh",
                        "Th·ªùi gian": "23/09/2025 11:42 AM",
                        "N·ªôi dung": "K√≠nh tr√¨nh: Ph√≥ V·ª• Tr∆∞·ªüng Nguy·ªÖn Anh Tu·∫•n",
                        "Ph√≤ng ban ƒë·∫ßu m·ªëi": "Ph√≤ng T·ªï ch·ª©c ti·ªÅn l∆∞∆°ng",
                        "Ph√≤ng ban ph·ªëi h·ª£p": "",
                        "H·∫°n x·ª≠ l√Ω": "",
                        "col7": "",
                        "col8": "",
                        "col9": "",
                        "ref": 12933
                    }
                ],
                luanchuyenData: [{ "Ng∆∞·ªùi g·ª≠i": "0", "ƒê∆°n v·ªã nh·∫≠n": "L√™ Anh H·∫£o", "Ng∆∞·ªùi nh·∫≠n": "", "Th·ªùi gian g·ª≠i": "Tr∆∞∆°ng H·ªìng Quang - ƒê·∫ßu m·ªëi", "Th·ªùi gian nh·∫≠n": "30/09/2025 09:45 AM", "M√¥i tr∆∞·ªùng": "30/09/2025 10:02 AM", "Tr·∫°ng th√°i": "H·ªá th·ªëng", "L√Ω do": "ƒê√£ nh·∫≠n", "col9": "", "col10": "", "col11": "", "ref": 12933 }, { "Ng∆∞·ªùi g·ª≠i": "0", "ƒê∆°n v·ªã nh·∫≠n": "L√™ Anh H·∫£o", "Ng∆∞·ªùi nh·∫≠n": "", "Th·ªùi gian g·ª≠i": "Nguy·ªÖn Th·ªã B√≠ch Th·∫£o  - ƒê·∫ßu m·ªëi", "Th·ªùi gian nh·∫≠n": "30/09/2025 09:45 AM", "M√¥i tr∆∞·ªùng": "30/09/2025 10:05 AM", "Tr·∫°ng th√°i": "H·ªá th·ªëng", "L√Ω do": "ƒê√£ nh·∫≠n", "col9": "", "col10": "", "col11": "", "ref": 12933 }, { "Ng∆∞·ªùi g·ª≠i": "0", "ƒê∆°n v·ªã nh·∫≠n": "L√™ Th·ªã Kim Oanh", "Ng∆∞·ªùi nh·∫≠n": "", "Th·ªùi gian g·ª≠i": "L√™ Anh H·∫£o  - ƒê·∫ßu m·ªëi", "Th·ªùi gian nh·∫≠n": "24/09/2025 08:04 AM", "M√¥i tr∆∞·ªùng": "26/09/2025 01:29 PM", "Tr·∫°ng th√°i": "H·ªá th·ªëng", "L√Ω do": "ƒê√£ nh·∫≠n", "col9": "", "col10": "", "col11": "", "ref": 12933 }, { "Ng∆∞·ªùi g·ª≠i": "0", "ƒê∆°n v·ªã nh·∫≠n": "L√™ Anh H·∫£o", "Ng∆∞·ªùi nh·∫≠n": "", "Th·ªùi gian g·ª≠i": "L√™ Th·ªã Kim Oanh  - ƒê·∫ßu m·ªëi", "Th·ªùi gian nh·∫≠n": "23/09/2025 08:06 PM", "M√¥i tr∆∞·ªùng": "24/09/2025 08:02 AM", "Tr·∫°ng th√°i": "H·ªá th·ªëng", "L√Ω do": "ƒê√£ nh·∫≠n", "col9": "", "col10": "", "col11": "", "ref": 12933 }, { "Ng∆∞·ªùi g·ª≠i": "10113", "ƒê∆°n v·ªã nh·∫≠n": "Phong To chuc - Tien luong (TCCB)", "Ng∆∞·ªùi nh·∫≠n": "V·ª• T·ªï ch·ª©c c√°n b·ªô NHNN", "Th·ªùi gian g·ª≠i": "L√™ Anh H·∫£o", "Th·ªùi gian nh·∫≠n": "23/09/2025 01:36 PM", "M√¥i tr∆∞·ªùng": "23/09/2025 08:05 PM", "Tr·∫°ng th√°i": "H·ªá th·ªëng", "L√Ω do": "ƒê√£ nh·∫≠n", "col9": "", "col10": "", "col11": "", "ref": 12933 }, { "Ng∆∞·ªùi g·ª≠i": "10113", "ƒê∆°n v·ªã nh·∫≠n": "Nguy·ªÖn Qu·ª≥nh Anh", "Ng∆∞·ªùi nh·∫≠n": "V·ª• T·ªï ch·ª©c c√°n b·ªô NHNN", "Th·ªùi gian g·ª≠i": "Nguy·ªÖn Anh Tu·∫•n", "Th·ªùi gian nh·∫≠n": "23/09/2025 11:42 AM", "M√¥i tr∆∞·ªùng": "23/09/2025 01:24 PM", "Tr·∫°ng th√°i": "H·ªá th·ªëng", "L√Ω do": "ƒê√£ nh·∫≠n", "col9": "", "col10": "", "col11": "", "ref": 12933 }, { "Ng∆∞·ªùi g·ª≠i": "10113", "ƒê∆°n v·ªã nh·∫≠n": "CucAnToanHTTCTD VanThu", "Ng∆∞·ªùi nh·∫≠n": "V·ª• T·ªï ch·ª©c c√°n b·ªô NHNN", "Th·ªùi gian g·ª≠i": "L√™ Th·ªã Kim Oanh", "Th·ªùi gian nh·∫≠n": "23/09/2025 11:09 AM", "M√¥i tr∆∞·ªùng": "24/09/2025 08:02 AM", "Tr·∫°ng th√°i": "H·ªá th·ªëng", "L√Ω do": "ƒê√£ nh·∫≠n", "col9": "", "col10": "", "col11": "", "ref": 12933 }, { "Ng∆∞·ªùi g·ª≠i": "10408", "ƒê∆°n v·ªã nh·∫≠n": "Nguy·ªÖn Anh Tu·∫•n", "Ng∆∞·ªùi nh·∫≠n": "Ph√≤ng T·ªï ch·ª©c ti·ªÅn l∆∞∆°ng", "Th·ªùi gian g·ª≠i": "Phong To chuc - Tien luong (TCCB) - ƒê·∫ßu m·ªëi", "Th·ªùi gian nh·∫≠n": "23/09/2025 01:24 PM", "M√¥i tr∆∞·ªùng": "23/09/2025 01:36 PM", "Tr·∫°ng th√°i": "H·ªá th·ªëng", "L√Ω do": "ƒê√£ nh·∫≠n", "col9": "", "col10": "", "col11": "", "ref": 12933 }, { "Ng∆∞·ªùi g·ª≠i": "10408", "ƒê∆°n v·ªã nh·∫≠n": "Nguy·ªÖn Qu·ª≥nh Anh", "Ng∆∞·ªùi nh·∫≠n": "Ph√≤ng T·ªï ch·ª©c ti·ªÅn l∆∞∆°ng", "Th·ªùi gian g·ª≠i": "Phong To chuc - Tien luong (TCCB)  - ƒê·∫ßu m·ªëi", "Th·ªùi gian nh·∫≠n": "23/09/2025 11:42 AM", "M√¥i tr∆∞·ªùng": "23/09/2025 01:36 PM", "Tr·∫°ng th√°i": "H·ªá th·ªëng", "L√Ω do": "ƒê√£ nh·∫≠n", "col9": "", "col10": "", "col11": "", "ref": 12933 }].map(normalizeRow)
            },
            {
    chitietData: {
      soVanBan: "1512/TCKT5",
      stt: "11215",
      ngayGuiDen: "03/10/2025",
      ngayVanBan: "03/10/2025",
      coQuanGui: "V·ª• T√†i ch√≠nh - K·∫ø to√°n",
      loaiVanBan: "C√¥ng vƒÉn",
      doMat: "Th∆∞·ªùng",
      doKhan: "Th∆∞·ªùng",
      trichYeu: "V/v L·ªô tr√¨nh tri·ªÉn khai gi√° d·ªãch v·ª• s·ª± nghi·ªáp c√¥ng",
      ghiChu: "",
      trangThaiND: "Ch∆∞a x·ª≠ l√Ω",
      trangThaiVB: "ƒêang x·ª≠ l√Ω",
      fileDinhKem: "1512-TCKT5-03102025.pdf"
    },
                ykienData: [
                    {
                        "Ng∆∞·ªùi b√∫t ph√™": "Nguy·ªÖn Anh Tu·∫•n",
                        "Th·ªùi gian": "16/08/2025 14:23 PM",
                        "N·ªôi dung": "K/ch Ph√≤ng TCTL ƒë·∫ßu m·ªëi ph·ªëi h·ª£p c√°c ph√≤ng li√™n quan, nghi√™n c·ª©u, tham gia √Ω ki·∫øn.",
                        "Ph√≤ng ban ƒë·∫ßu m·ªëi": "Ph√≤ng T·ªï ch·ª©c ti·ªÅn l∆∞∆°ng",
                        "ref": 11215
                    },
                    {
                        "Ng∆∞·ªùi b√∫t ph√™": "L√™ Anh H·∫£o",
                        "Th·ªùi gian": "15/08/2025 14:09 PM",
                        "N·ªôi dung": "K/c Quang xly, b/c c.th·∫£o - PTP",
                        "ref": 11215
                    },
                    {
                        "Ng∆∞·ªùi b√∫t ph√™": "Nguy·ªÖn Qu·ª≥nh Anh",
                        "Th·ªùi gian": "15/08/2025 13:44 PM",
                        "N·ªôi dung": "K√≠nh tr√¨nh: Ph√≥ V·ª• Tr∆∞·ªüng Nguy·ªÖn Anh Tu·∫•n",
                        "Ph√≤ng ban ƒë·∫ßu m·ªëi": "Ph√≤ng T·ªï ch·ª©c ti·ªÅn l∆∞∆°ng",
                        "ref": 11215
                    }
                ],
                luanchuyenData: [{"Ng∆∞·ªùi g·ª≠i":"0","ƒê∆°n v·ªã nh·∫≠n":"L√™ Anh H·∫£o","Ng∆∞·ªùi nh·∫≠n":"","Th·ªùi gian g·ª≠i":"Nguy·ªÖn Minh Anh - Ph·ªëi h·ª£p","Th·ªùi gian nh·∫≠n":"15/08/2025 02:09 PM","M√¥i tr∆∞·ªùng":"15/08/2025 02:12 PM","Tr·∫°ng th√°i":"H·ªá th·ªëng","L√Ω do":"ƒê√£ nh·∫≠n","col9":"","col10":"","col11":"","ref":11215},{"Ng∆∞·ªùi g·ª≠i":"0","ƒê∆°n v·ªã nh·∫≠n":"L√™ Anh H·∫£o","Ng∆∞·ªùi nh·∫≠n":"","Th·ªùi gian g·ª≠i":"Tr∆∞∆°ng H·ªìng Quang  \n                - Ph·ªëi h·ª£p","Th·ªùi gian nh·∫≠n":"15/08/2025 02:09 PM","M√¥i tr∆∞·ªùng":"15/08/2025 02:28 PM","Tr·∫°ng th√°i":"H·ªá th·ªëng","L√Ω do":"ƒê√£ nh·∫≠n","col9":"","col10":"","col11":"","ref":11215},{"Ng∆∞·ªùi g·ª≠i":"0","ƒê∆°n v·ªã nh·∫≠n":"L√™ Anh H·∫£o","Ng∆∞·ªùi nh·∫≠n":"","Th·ªùi gian g·ª≠i":"Nguy·ªÖn Th·ªã B√≠ch Th·∫£o  \n                - Ph·ªëi h·ª£p","Th·ªùi gian nh·∫≠n":"15/08/2025 02:09 PM","M√¥i tr∆∞·ªùng":"15/08/2025 03:03 PM","Tr·∫°ng th√°i":"H·ªá th·ªëng","L√Ω do":"ƒê√£ nh·∫≠n","col9":"","col10":"","col11":"","ref":11215},{"Ng∆∞·ªùi g·ª≠i":"10113","ƒê∆°n v·ªã nh·∫≠n":"Phong To chuc - Tien luong (TCCB)","Ng∆∞·ªùi nh·∫≠n":"V·ª• T·ªï ch·ª©c c√°n b·ªô NHNN","Th·ªùi gian g·ª≠i":"L√™ Anh H·∫£o","Th·ªùi gian nh·∫≠n":"15/08/2025 02:08 PM","M√¥i tr∆∞·ªùng":"15/08/2025 02:08 PM","Tr·∫°ng th√°i":"H·ªá th·ªëng","L√Ω do":"ƒê√£ nh·∫≠n","col9":"","col10":"","col11":"","ref":11215},{"Ng∆∞·ªùi g·ª≠i":"10113","ƒê∆°n v·ªã nh·∫≠n":"Nguy·ªÖn Qu·ª≥nh Anh","Ng∆∞·ªùi nh·∫≠n":"V·ª• T·ªï ch·ª©c c√°n b·ªô NHNN","Th·ªùi gian g·ª≠i":"Nguy·ªÖn Anh Tu·∫•n","Th·ªùi gian nh·∫≠n":"15/08/2025 01:44 PM","M√¥i tr∆∞·ªùng":"16/08/2025 02:22 PM","Tr·∫°ng th√°i":"H·ªá th·ªëng","L√Ω do":"ƒê√£ nh·∫≠n","col9":"","col10":"","col11":"","ref":11215},{"Ng∆∞·ªùi g·ª≠i":"10113","ƒê∆°n v·ªã nh·∫≠n":"CucAnToanHTTCTD VanThu","Ng∆∞·ªùi nh·∫≠n":"V·ª• T·ªï ch·ª©c c√°n b·ªô NHNN","Th·ªùi gian g·ª≠i":"L√™ Th·ªã Kim Oanh","Th·ªùi gian nh·∫≠n":"15/08/2025 11:20 AM","M√¥i tr∆∞·ªùng":"","Tr·∫°ng th√°i":"H·ªá th·ªëng","L√Ω do":"ƒê√£ g·ª≠i","col9":"","col10":"","col11":"","ref":11215},{"Ng∆∞·ªùi g·ª≠i":"10408","ƒê∆°n v·ªã nh·∫≠n":"Nguy·ªÖn Anh Tu·∫•n","Ng∆∞·ªùi nh·∫≠n":"Ph√≤ng T·ªï ch·ª©c ti·ªÅn l∆∞∆°ng","Th·ªùi gian g·ª≠i":"Phong To chuc - Tien luong (TCCB) - ƒê·∫ßu m·ªëi","Th·ªùi gian nh·∫≠n":"16/08/2025 02:23 PM","M√¥i tr∆∞·ªùng":"18/08/2025 08:06 AM","Tr·∫°ng th√°i":"H·ªá th·ªëng","L√Ω do":"ƒê√£ nh·∫≠n","col9":"","col10":"","col11":"","ref":11215},{"Ng∆∞·ªùi g·ª≠i":"10408","ƒê∆°n v·ªã nh·∫≠n":"Nguy·ªÖn Qu·ª≥nh Anh","Ng∆∞·ªùi nh·∫≠n":"Ph√≤ng T·ªï ch·ª©c ti·ªÅn l∆∞∆°ng","Th·ªùi gian g·ª≠i":"Phong To chuc - Tien luong (TCCB)  - ƒê·∫ßu m·ªëi","Th·ªùi gian nh·∫≠n":"15/08/2025 01:44 PM","M√¥i tr∆∞·ªùng":"15/08/2025 02:08 PM","Tr·∫°ng th√°i":"H·ªá th·ªëng","L√Ω do":"ƒê√£ nh·∫≠n","col9":"","col10":"","col11":"","ref":11215}].map(normalizeRow)
            }
        ];






        window.tokenKey = sessionStorage.getItem("tokenKey") || "";
        let currentUser = null;

        window.addEventListener("DOMContentLoaded", () => {
            const stored = sessionStorage.getItem("currentUser");
            if (!stored) {
                alert("‚ö†Ô∏è B·∫°n ch∆∞a ƒëƒÉng nh·∫≠p!");
                window.location.href = "loginpage.html";
                return;
            }
            currentUser = JSON.parse(stored);
            console.log("ƒêang ƒëƒÉng nh·∫≠p:", currentUser);  // s·∫Ω th·∫•y dept

            // L·ªçc sidebar n·∫øu user kh√¥ng thu·ªôc ALL
            //if (currentUser.dept && currentUser.dept !== "ALL") {
                //limitSidebarToDept(currentUser.dept);
            //}

            // ‚úÖ G·ªçi refreshData ƒë·ªÉ hi·ªÉn th·ªã d·ªØ li·ªáu b·∫£ng ngay sau login
            refreshDataHybrid();
        });

        function importToken(e) {
            const file = e.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function (evt) {
                window.tokenKey = evt.target.result.trim().replace(/^"|"$/g, "");
                alert("‚úÖ ƒê√£ n·∫°p TOKEN_KEY th√†nh c√¥ng!");
            };
            reader.readAsText(file, "utf-8");
        }

        function decodeData(encoded) {
            if (!window.tokenKey || window.tokenKey.trim() === "") return null;
            try {
                const combined = decodeURIComponent(escape(atob(encoded)));
                const [base64, token] = combined.split("::");
                if (token.trim() !== window.tokenKey.trim()) return null;
                return JSON.parse(decodeURIComponent(escape(atob(base64))));
            } catch { return null; }
        }

        function parseVNDate(str) {
            if (!str) return null;
            const [date, time] = str.split(" ");
            if (!date || !time) return null;
            const [d, m, y] = date.split("/").map(Number);
            const [hh, mm, ss] = time.split(":").map(Number);
            return new Date(y, m - 1, d, hh, mm, ss);
        }

        function fmt(sec) {
            const d = Math.floor(sec / 86400); sec %= 86400;
            const h = Math.floor(sec / 3600); sec %= 3600;
            const m = Math.floor(sec / 60);
            return `${d} ng√†y ${h} gi·ªù ${m} ph√∫t`;
        }

        function parseDuration(str) {
            if (!str) return 0;
            str = str.replace(",", ".");
            let total = 0;
            const parts = str.split(" ");
            for (let i = 0; i < parts.length; i++) {
                const val = parseFloat(parts[i]);
                if (isNaN(val)) continue;
                if (parts[i + 1]?.includes("ng√†y")) total += val * 86400;
                if (parts[i + 1]?.includes("gi·ªù")) total += val * 3600;
                if (parts[i + 1]?.includes("ph√∫t")) total += val * 60;
            }
            return total;
        }

        function calcElapsed(decoded) {
            if (!decoded[0]?.time) return "0 ng√†y 0 gi·ªù 0 ph√∫t";
            const start = parseVNDate(decoded[0].time);
            if (!start) return "0 ng√†y 0 gi·ªù 0 ph√∫t";
            const now = new Date();
            const diff = (now - start) / 1000;
            return fmt(diff);
        }

/** üß© L·∫•y d·ªØ li·ªáu SharePoint (l·ªçc t·ª´ Flow ho·∫∑c client n·∫øu c·∫ßn) */

async function refreshDataHybrid() {
  if (!window.tokenKey) {
    alert("‚ö†Ô∏è Import TOKEN_KEY tr∆∞·ªõc!");
    return;
  }

  try {
    const userDept = currentUser?.dept || "ALL";
    console.log("üë§ userDept g·ª≠i sang Flow =", userDept);

    const urlRaw =
      "https://default460cecfbf0c64dd7a5ec66ef4d75ae.63.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/ebcb4285fccf4518b684ddf6cbb181d7/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=03tXAPGH1SbNYPpRgthOuhn8MYs5fNPHR2eYk8nPK54";

    const urlProcess =
      "https://default460cecfbf0c64dd7a5ec66ef4d75ae.63.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/6cefafdd3f6f4eb199b1645f78282acc/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=MTDVG89mus9HQtlNA-4ye2ZgzAg6B-9X5XoZJfHzDTk";

    console.log("üöÄ G·ªçi song song 2 Flow (Raw + Process)");

    const [resRaw, resProcess] = await Promise.all([
      fetch(urlRaw, { method: "POST", headers: { "Content-Type": "application/json" } }),
      fetch(urlProcess, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ dept: userDept })
      })
    ]);

    const listRaw = await resRaw.json();
    const listProcess = await resProcess.json();

    console.log("üì¶ RawData t·ª´ SharePoint:", listRaw);
    console.log("üì¶ ProcessTable:", listProcess);

    /** üß© H√†m parse an to√†n (t·ª± nh·∫≠n bi·∫øt JSON l·ªìng) */
    function safeParse(data) {
      try {
        if (typeof data === "string") {
          const once = JSON.parse(data);
          if (typeof once === "string") return JSON.parse(once);
          return once;
        }
        return data;
      } catch {
        return [];
      }
    }

    /** üß± Chu·∫©n h√≥a t·ª´ rawData (SharePoint) */
    const rawFormatted = (listRaw || []).map((item, idx) => {
const chitiet = safeParse(item.CHITIET || "[]")[0] || {};
const ykien = safeParse(item.YKIEN || "[]");
const luanchuyen = safeParse(item.LUANCHUYEN || "[]");
console.log("üß© item keys:", Object.keys(item));

      console.groupCollapsed(`üßæ RAW ITEM [${idx}] REF=${chitiet?.stt || "?"}`);
      console.log("üìÇ chitiet:", chitiet);
      console.log("üó£Ô∏è ykien:", ykien);
      console.log("üîÅ luanchuyen:", luanchuyen);
      console.groupEnd();

      // üîç T√¨m ph√≤ng ban trong luanchuyen (b·∫•t k·ª≥ field n√†o c√≥ t·ª´ 'ph√≤ng' + '- ƒë·∫ßu m·ªëi')
 // üß© X√°c ƒë·ªãnh ph√≤ng ƒë·∫ßu m·ªëi (chu·∫©n h√≥a t·ª´ luanchuyen)
let dept = extractPhongDauMoi(luanchuyen);

      return {
        ref: chitiet?.stt || item.ref || "",
        dept,
        quytrinh: chitiet?.trichYeu || "",
        buoc: "",
        trong: "",
        conlaiStraight: "",
        conlaiConflict: "",
        nguoi: "",
        status: "pending",
        straightSec: 0,
        conflictSec: 0,
        chitietData: chitiet,
        ykienData: ykien,
        luanchuyenData: luanchuyen
      };
    });

    /** üß† Chu·∫©n h√≥a Process Table */
    const processTable = (listProcess || []).map(item => ({
      REF: item.REF,
      DEPT: item.DEPT,
      QUYTRINH: item.QUYTRINH,
      DATA: item.DATA
    }));

    console.log("üß± D·ªØ li·ªáu sau khi chu·∫©n h√≥a raw:", rawFormatted);
    console.log("‚öôÔ∏è ProcessTable:", processTable);

    /** üîó Merge 2 ngu·ªìn d·ªØ li·ªáu */
    const merged = rawFormatted.map(r => {
      const match = processTable.find(p => p.REF == r.ref);
if (match) {
  const decoded = safeParse(match.DATA || "[]");
  const stats = analyzeProcess(decoded);

  return {
    ...r,
    dept: match.DEPT || r.dept,
    quytrinh: match.QUYTRINH || r.quytrinh,
    decoded,
    buoc: stats.currentStep,
    trong: stats.elapsed,
    conlaiStraight: stats.conlaiStraight,
    conlaiConflict: stats.conlaiConflict,
    nguoi: stats.pendingNguoi,
    straightSec: stats.straightSec,
    conflictSec: stats.conflictSec,
    status: stats.currentStep === "Ho√†n th√†nh" ? "done" : "pending"
  };
}
      return r;
    });

    console.log("üß© D·ªØ li·ªáu sau khi merge & fill:", merged);
    window.allRows = merged;
    renderTable(merged);
    updateStats(merged);
  } catch (err) {
    console.error("‚ùå L·ªói refreshDataHybrid:", err);
    
  }
}





/** üîç L·ªçc b·∫£ng theo ph√≤ng ban trong sidebar */
function filterDept(deptName) {
  console.log("üü° filterDept ƒë∆∞·ª£c g·ªçi, nh∆∞ng Flow ƒë√£ l·ªçc s·∫µn ‚Äî b·ªè qua.");
  if (!window.allRows) return;
  renderTable(window.allRows);
  updateStats(window.allRows);
}


/** üè¢ Chu·∫©n h√≥a t√™n ph√≤ng ng∆∞·ªùi login sang format c√≥ d·∫•u (nh∆∞ SharePoint) */
function normalizeToSharePointDept(raw = "") {
  if (!raw) return "";

  const txt = raw
    .toLowerCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "") // b·ªè d·∫•u, ch·ªâ ƒë·ªÉ so kh·ªõp
    .replace(/[()\-‚Äì_]/g, " ")
    .replace(/\s+/g, " ")
    .trim();

  if (txt.includes("to chuc tien luong") || txt.includes("tien luong tccb"))
    return "Ph√≤ng T·ªï ch·ª©c ti·ªÅn l∆∞∆°ng";
  if (txt.includes("thi dua") || txt.includes("khen thuong"))
    return "Ph√≤ng Thi ƒëua - Khen th∆∞·ªüng";
  if (txt.includes("can bo dia phuong") || txt.includes("dia phuong"))
    return "Ph√≤ng C√°n b·ªô ƒë·ªãa ph∆∞∆°ng";
  if (txt.includes("dao tao") || txt.includes("nguon nhan luc") || txt.includes("phat trien"))
    return "Ph√≤ng ƒê√†o t·∫°o v√† Ph√°t tri·ªÉn ngu·ªìn nh√¢n l·ª±c";
  if (txt.includes("to chuc can bo") || txt.includes("tccb"))
    return "V·ª• T·ªï ch·ª©c c√°n b·ªô";

  return raw.trim();
}


/* üß† Chu·∫©n h√≥a t√™n ph√≤ng ban */
function normalizeDept(rawDept = "") {
  if (!rawDept) return "";
  return rawDept
    .toString()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "") // b·ªè d·∫•u
    .normalize("NFC")
    .toLowerCase()
    .replace(/phong/g, "phong")
    .replace(/vu/g, "vu")
    .replace(/[()\-‚Äì_]/g, " ")
    .replace(/\s+/g, " ")
    .trim();
}

/* üß© So kh·ªõp l√µi nghƒ©a ph√≤ng ban */
function isSameDept(a, b) {
  if (!a || !b) return false;
  if (a === b) return true;

  const coreA = extractCore(a);
  const coreB = extractCore(b);
  if (coreA === coreB) return true;

  // N·∫øu ch·ª©a to√†n b·ªô t·ª´ l√µi nhau th√¨ c≈©ng coi l√† kh·ªõp
  const wordsA = coreA.split(" ");
  return wordsA.every(w => coreB.includes(w));
}

/* üîç L·∫•y l√µi nghƒ©a c·ªßa t√™n ph√≤ng */
function extractCore(s) {
  return s
    .replace(/(phong|vu|tccb|bo phan|ban)/g, "")
    .replace(/[^a-z0-9\s]/g, "")
    .replace(/\s+/g, " ")
    .trim();
}


        function renderTable(list) {
            const tbody = document.getElementById("refTable");
            tbody.innerHTML = list.map(r => {
                // √°nh x·∫° t√™n quy tr√¨nh ‚Üí file html
                const mapping = {
                    "Ph√™ duy·ªát/c√≥ √Ω ki·∫øn v·ªÅ K·∫ø ho·∫°ch tuy·ªÉn d·ª•ng c√¥ng ch·ª©c lo·∫°i D t·∫°i c√°c NHNN chi nh√°nh Khu v·ª±c": "test.html",
                    "C·ª≠ c√°n b·ªô ƒëi c√¥ng t√°c n∆∞·ªõc ngo√†i": "test1.html",
                    "ƒê√≥n nh·∫≠n danh hi·ªáu thi ƒëua": "test2.html",
                    "Tri·ªÉn khai quy ho·∫°ch l√£nh ƒë·∫°o c·∫•p ph√≤ng": "test3.html",
                    "N√¢ng l∆∞∆°ng th∆∞·ªùng xuy√™n": "test4.html"
                };
                const file = mapping[r.quytrinh] || "test.html"; // fallback n·∫øu kh√¥ng kh·ªõp

                return `
      <tr>
        <td>${r.ref}</td>
        <td>${r.dept}</td>
        <td>${r.quytrinh}</td>
        <td>${r.buoc}</td>
        <td>${r.trong}</td>
        <td>${r.conlaiStraight}</td>
        <td>${r.conlaiConflict}</td>
        <td>${r.nguoi}</td>
        <td>
          <button class="btn-new" onclick="openProcessWithRef('${file}', '${r.ref}')">‚úèÔ∏è Edit</button>
        </td>
      </tr>`;
            }).join("");
            console.log("üìä Rendered rows:", list);   // ‚úÖ debug
            updateStats(list);

        }
        function normalizeRow(raw) {
            return {
                nguoi_gui: raw["ƒê∆°n v·ªã nh·∫≠n"] || "",
                don_vi_nhan: raw["Ng∆∞·ªùi nh·∫≠n"] || "",
                nguoi_nhan: raw["Th·ªùi gian g·ª≠i"] || "",
                thoi_gian_gui: raw["Th·ªùi gian nh·∫≠n"] || "",
                thoi_gian_nhan: raw["M√¥i tr∆∞·ªùng"] || "",
                trang_thai: raw["L√Ω do"] || "",
                ref: raw.ref ?? null
            };
        }

        function openProcessWithRef(file, ref) {
  const item = window.allRows.find(r => r.ref == ref);
  if (item) {
    // l∆∞u th√¥ng tin chung
    sessionStorage.setItem("selectedRow", JSON.stringify(item));
    sessionStorage.setItem("mode", "edit");

    // l∆∞u ri√™ng data chi ti·∫øt, √Ω ki·∫øn v√† lu√¢n chuy·ªÉn
    if (item.chitietData) {
      sessionStorage.setItem("chitietData", JSON.stringify(item.chitietData));
    }
    if (item.ykienData) {
      sessionStorage.setItem("ykienData", JSON.stringify(item.ykienData));
    }
    if (item.luanchuyenData) {
      sessionStorage.setItem("luanchuyenData", JSON.stringify(item.luanchuyenData));
    }

    console.log("üîÑ G·ª≠i sang", file);
    console.log("selectedRow:", item);
    console.log("chitietData:", item.chitietData);
    console.log("ykienData:", item.ykienData);
    console.log("luanchuyenData:", item.luanchuyenData);
  } else {
    console.warn("‚ùå Kh√¥ng t√¨m th·∫•y item v·ªõi ref =", ref);
  }

  if (window.tokenKey) sessionStorage.setItem("tokenKey", window.tokenKey);
  window.open(`${file}?ref=${encodeURIComponent(ref)}`, "_blank");
}


        function updateStats(list) {
            document.getElementById("total").textContent = list.length;
            document.getElementById("completed").textContent = list.filter(r => r.status === "done").length;
            document.getElementById("pending").textContent = list.filter(r => r.status === "pending").length;

            let sumStraight = list.reduce((a, b) => a + (b.straightSec || 0), 0);
            let sumConflict = list.reduce((a, b) => a + (b.conflictSec || 0), 0);

            document.getElementById("sumStraight").textContent = fmt(sumStraight);
            document.getElementById("sumConflict").textContent = fmt(sumConflict);

            document.getElementById("avgTime").textContent = list.length ? fmt(sumStraight / list.length) : "0 ng√†y 0 gi·ªù 0 ph√∫t";
        }

        // Toggle menu khi b·∫•m n√∫t
        document.querySelector(".btn-green").addEventListener("click", () => {
            document.getElementById("newMenu").classList.toggle("hidden");
        });

        // ·∫®n menu khi click ra ngo√†i
        document.addEventListener("click", e => {
            if (!e.target.closest(".new-actions")) {
                document.getElementById("newMenu").classList.add("hidden");
            }
        });

        // H√†m m·ªü tab m·ªõi KH√îNG k√®m ref
        function openProcess(file) {
            // gi·ªØ tokenKey trong sessionStorage
            if (window.tokenKey) {
                sessionStorage.setItem("tokenKey", window.tokenKey);
            }

            // m·ªü tab m·ªõi
            window.open(file, "_blank");
        }

/** üßÆ Ph√¢n t√≠ch chi ti·∫øt quy tr√¨nh (t√≠nh to√°n th·ªùi gian, b∆∞·ªõc hi·ªán t·∫°i, pending, v.v.) */
function analyzeProcess(decoded) {
  if (!decoded || decoded.length === 0)
    return {
      currentStep: "Ho√†n th√†nh",
      elapsed: "0 ng√†y 0 gi·ªù 0 ph√∫t",
      conlaiStraight: "0 ng√†y 0 gi·ªù 0 ph√∫t",
      conlaiConflict: "0 ng√†y 0 gi·ªù 0 ph√∫t",
      straightSec: 0,
      conflictSec: 0,
      pendingNguoi: ""
    };

  // üîç t√¨m b∆∞·ªõc cu·ªëi ƒë√£ ho√†n th√†nh
  let lastDoneIdx = -1;
  for (let i = decoded.length - 1; i >= 0; i--) {
    if (decoded[i].time && decoded[i].time !== "") {
      lastDoneIdx = i;
      break;
    }
  }

  // üïì th·ªùi ƒëi·ªÉm b·∫Øt ƒë·∫ßu (b∆∞·ªõc 0)
  const firstStepTime = parseVNDate(decoded[0].time);
  if (!firstStepTime) {
    return {
      currentStep: "Kh√¥ng x√°c ƒë·ªãnh",
      elapsed: "0 ng√†y 0 gi·ªù 0 ph√∫t",
      conlaiStraight: "0 ng√†y 0 gi·ªù 0 ph√∫t",
      conlaiConflict: "0 ng√†y 0 gi·ªù 0 ph√∫t",
      straightSec: 0,
      conflictSec: 0,
      pendingNguoi: ""
    };
  }

  // ‚úÖ N·∫øu to√†n b·ªô ƒë√£ xong
  if (lastDoneIdx === decoded.length - 1) {
    const lastTime = parseVNDate(decoded[lastDoneIdx].time);
    return {
      currentStep: "Ho√†n th√†nh",
      elapsed: fmt((lastTime - firstStepTime) / 1000),
      conlaiStraight: "0 ng√†y 0 gi·ªù 0 ph√∫t",
      conlaiConflict: "0 ng√†y 0 gi·ªù 0 ph√∫t",
      straightSec: 0,
      conflictSec: 0,
      pendingNguoi: ""
    };
  }

  // ‚è≥ N·∫øu v·∫´n ƒëang pending
  const now = new Date();
  let straightSec = 0, conflictSec = 0;
  for (let j = lastDoneIdx + 1; j < decoded.length; j++) {
    const xuLy = parseDuration(decoded[j].xuly);
    const cho = parseDuration(decoded[j].cho);
    const extra = parseDuration(decoded[j].extra);
    straightSec += xuLy + cho;
    conflictSec += xuLy + cho + extra;
  }

  return {
    currentStep: decoded[lastDoneIdx + 1]?.step || "ƒêang x·ª≠ l√Ω",
    elapsed: fmt((now - firstStepTime) / 1000),
    conlaiStraight: fmt(straightSec),
    conlaiConflict: fmt(conflictSec),
    straightSec,
    conflictSec,
    pendingNguoi: decoded[lastDoneIdx + 1]?.nguoi || ""
  };
}

function extractPhongDauMoi(luanchuyen = []) {
  for (const row of luanchuyen) {
    for (const val of Object.values(row || {})) {
      const text = String(val || "")
        .normalize("NFD")
        .replace(/[\u0300-\u036f]/g, "") // b·ªè d·∫•u
        .toLowerCase();
      if (text.includes("phong") && text.includes("dau moi")) {
        // Chu·∫©n h√≥a l·∫°i
        return val
          .replace(/\s*-\s*ƒë·∫ßu m·ªëi.*/i, "")
          .replace(/-/g, " ")
          .replace(/\(tccb\)/gi, "")
          .replace(/\s+/g, " ")
          .trim()
          .replace(/phong/gi, "Ph√≤ng")
          .replace(/to chuc/gi, "T·ªï ch·ª©c")
          .replace(/tien luong/gi, "Ti·ªÅn l∆∞∆°ng");
      }
    }
  }
  return "";
}




    </script>
</body>

</html>