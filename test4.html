<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Quy tr√¨nh 1</title>
  <style>
    :root {
      --bg: #ffffff;
      --nav: #f4ebdd;
      --text: #222;
      --card: #ffffff;
      --muted: #555;
      --accent: #a87d48;
      --accent-2: #d27d2d;
      --radius: 12px;
      --shadow: 0 4px 18px rgba(0, 0, 0, .08);
    }

    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      background: var(--bg);
      color: var(--text);
    }

    .navbar {
      background: linear-gradient(180deg, var(--nav) 0%, #ffffff 100%);
      color: var(--text);
      height: 80px;
      padding: 0 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: var(--shadow);
    }

    .logo img {
      height: 80px;
      object-fit: contain;
    }

    .dept {
      font-size: 14px;
      font-weight: 500;
    }

    .container {
      max-width: 1600px;
      margin: 30px auto;
      padding: 0 20px;
    }

    h1 {
      margin: 20px 0;
      font-size: 22px;
    }

    select {
      padding: 8px 12px;
      font-size: 14px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: var(--card);
      box-shadow: var(--shadow);
      border-radius: var(--radius);
      overflow: hidden;
      margin-top: 20px;
      table-layout: fixed;
    }

    th,
    td {
      border: 1px solid #eee;
      padding: 10px;
      font-size: 14px;
      vertical-align: top;
      word-wrap: break-word;
    }

    th {
      background: #f9f6f0;
      color: var(--text);
    }

    th:nth-child(1),
    td:nth-child(1) {
      width: 18%;
    }

    th:nth-child(2),
    td:nth-child(2) {
      width: 15%;
    }

    th:nth-child(3),
    td:nth-child(3) {
      width: 10%;
    }

    th:nth-child(4),
    td:nth-child(4) {
      width: 10%;
    }

    th:nth-child(5),
    td:nth-child(5) {
      width: 12%;
    }

    th:nth-child(6),
    td:nth-child(6) {
      width: 20%;
    }

    th:nth-child(7),
    td:nth-child(7) {
      width: 12%;
    }

    th:nth-child(8),
    td:nth-child(8) {
      width: 12%;
    }

    textarea.result-input {
      width: 100%;
      min-height: 80px;
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 6px;
      resize: vertical;
      font-family: "Segoe UI", sans-serif;
      font-size: 14px;
    }

    .btn {
      margin-top: 6px;
      padding: 6px 12px;
      border: 0;
      border-radius: var(--radius);
      cursor: pointer;
      font-weight: 600;
      color: #fff;
    }

    .btn-next {
      background: var(--accent);
    }

    .btn-edit {
      background: var(--accent-2);
    }

    .btn:hover {
      opacity: 0.9;
    }

    tr.hidden {
      display: none;
    }

    .step-title {
      background: #f2eee7;
      font-weight: 700;
      text-align: center;
    }

    .hidden {
      display: none !important;
    }

    .actions {
      margin: 20px 0;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .actions button {
      background: #2196f3;
      color: #fff;
      border: 0;
      padding: 8px 14px;
      border-radius: 6px;
      cursor: pointer;
    }

    .actions button:hover {
      opacity: 0.9;
    }

    #summaryTable {
      margin-top: 20px;
      border-collapse: collapse;
      width: 100%;
      background: #fafafa;
    }

    #summaryTable th,
    #summaryTable td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }

    #summaryTable th {
      background: #eee;
    }

    input[type="datetime-local"] {
      padding: 6px 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      font-family: "Segoe UI", sans-serif;
      font-size: 14px;
      background: #fff;
      box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1);
    }

    input[type="datetime-local"]:focus {
      border-color: var(--accent);
      outline: none;
      box-shadow: 0 0 3px var(--accent);
    }

    .time-wrapper {
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .time-input {
      position: absolute;
      left: -9999px;
      /* ƒë·∫©y ra kh·ªèi m√†n h√¨nh */
      width: 0;
      height: 0;
      opacity: 0;
      /* t√†ng h√¨nh */
      pointer-events: none;
      /* kh√¥ng cho b·∫•m v√†o */
    }

    .time-icon {
      cursor: pointer;
      font-size: 18px;
      color: goldenrod;
      /* v√†ng */
      margin-top: 4px;
      display: inline-block;
    }

    .time-icon:hover {
      opacity: 0.8;
    }

    #processTable td span {
      display: block;
      font-size: 13px;
      color: #555;
      margin-top: 2px;
    }

    .actions {
      margin: 20px 0;
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .actions button,
    .actions label.icon-btn {
      background: #2196f3;
      color: #fff;
      border: 0;
      padding: 8px 12px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 18px;
      /* icon to r√µ */
      line-height: 1;
      text-align: center;
    }

    .actions button:hover,
    .actions label.icon-btn:hover {
      opacity: 0.85;
    }
  </style>
</head>

<body>
  <div class="navbar">
    <div class="logo"><img src="photo/logo-nhnnvn-3-1129x800.webp" alt="Logo"></div>
    <div class="dept" id="deptName">Ph√≤ng: T·ªî CH·ª®C TI·ªÄN L∆Ø∆†NG</div>
    <div class="dept" id="refDisplay"></div>
  </div>

  <div class="container">
    <h1>Ph√™ Duy·ªát ƒê·ªëi V·ªõi N√¢ng L∆∞∆°ng Th∆∞·ªùng Xuy√™n, Ph·ª• C·∫•p Th√¢m Ni√™n V∆∞·ª£t Khung
        Thu·ªôc Th·∫©m Quy·ªÅn V·ª• TCCB Duy·ªát K√Ω</h1>

    <!-- Dropdown ch·ªçn trang -->
    <label for="processSelect"><b>Ch·ªçn quy tr√¨nh:</b></label>
    <select id="processSelect">
      <option value="test.html" >K·∫ø ho·∫°ch tuy·ªÉn d·ª•ng c√¥ng ch·ª©c lo·∫°i D t·∫°i c√°c NHNN chi nh√°nh Khu v·ª±c</option>
      <option value="test1.html">C·ª≠ c√°n b·ªô ƒëi c√¥ng t√°c n∆∞·ªõc ngo√†i</option>
      <option value="test2.html">T·ªï ch·ª©c ƒë√≥n nh·∫≠n c√°c danh hi·ªáu thi ƒëua, h√¨nh th·ª©c khen th∆∞·ªüng c·∫•p Nh√† N∆∞·ªõc, c·∫•p Ng√†nh
      </option>
      <option value="test3.html">Tri·ªÉn khai quy ho·∫°ch L√£nh ƒê·∫°o c·∫•p Ph√≤ng t·∫°i NHTW</option>
      <option value="test4.html"selected>Quy Tr√¨nh Ph√™ Duy·ªát ƒê·ªëi V·ªõi N√¢ng L∆∞∆°ng Th∆∞·ªùng Xuy√™n, Ph·ª• C·∫•p Th√¢m Ni√™n V∆∞·ª£t Khung
        Thu·ªôc Th·∫©m Quy·ªÅn V·ª• TCCB Duy·ªát K√Ω</option>
      <option value="test5.html">Quy tr√¨nh x√¢y d·ª±ng b√°o c√°o ƒë·ªãnh k·ª≥/ƒë·ªôt xu·∫•t/tham gia √Ω ki·∫øn/tr·∫£ l·ªùi ki·∫øn ngh·ªã g·ª≠i c√°c
        ƒë∆°n v·ªã thu·ªôc NHNN do l√£nh ƒë·∫°o V·ª• TCCB duy·ªát k√Ω</option>
    </select>

    <!-- Export / Import CSV -->
    <div class="actions">
      <button onclick="exportRawJson()" style="display: none;">üì• Export Local File</button>
      <button onclick="sendToSharePoint()">‚òÅÔ∏è Save D·ªØ Li·ªáu</button>
      <button onclick="importFromCloud()"style="display: none;">‚òÅÔ∏è Import Cloud</button>
      <!-- Import Token Key -->
      <label for="importToken" title="Import Token Key" class="icon-btn"style="display: none;">üîë Import Token Key File</label>
      <input type="file" id="importToken" accept=".csv,.txt" onchange="importToken(event)" hidden>

      <!-- Import Encoded TXT -->
      <label for="importEncoded" title="Import Encoded TXT" class="icon-btn"style="display: none;">üìÇ Import Data Local File</label>
      <input type="file" id="importEncoded" accept=".txt" onchange="importEncoded(event)" hidden>
    </div>

    <div id="processTable"></div>
    <div id="summary"></div>
  </div>

  <script>
    document.getElementById("processSelect")
      .addEventListener("change", e => window.location.href = e.target.value);

    const processData = [
      {
        title: "B∆∞·ªõc 1: Ti·∫øp nh·∫≠n T·ªù tr√¨nh c·ªßa ƒë∆°n v·ªã", sub: [
          { noidung: "Ti·∫øp nh·∫≠n T·ªù tr√¨nh", nguoi: "VƒÉn th∆∞", cho: "0,5 ng√†y" },
          { noidung: "Ti·∫øp nh·∫≠n T·ªù tr√¨nh", nguoi: "L√£nh ƒë·∫°o V·ª•", cho: "01 ng√†y" },
          { noidung: "Ti·∫øp nh·∫≠n T·ªù tr√¨nh", nguoi: "L√£nh ƒë·∫°o Ph√≤ng", xuly: "0,5 ng√†y" },
          { noidung: "Ti·∫øp nh·∫≠n T·ªù tr√¨nh", nguoi: "C√¥ng ch·ª©c ph·ª• tr√°ch", xuly: "0,5 ng√†y" }
        ]
      },

      {
        title: "B∆∞·ªõc 2: R√† so√°t b√°o c√°o, ki·∫øn ngh·ªã", sub: [
          {
            noidung: "R√† so√°t h·ªì s∆° ƒë·ªÅ c·ª≠", nguoi: "C√¥ng ch·ª©c ph·ª• tr√°ch", xuly: "0,5 ng√†y",
            type: "decision2"
          },
          { noidung: "‚Üí C√¥ng ch·ª©c trao ƒë·ªïi v·ªõi NHNN", nguoi: "C√¥ng ch·ª©c ph·ª• tr√°ch", xuly: "0,5 ng√†y" },
          { noidung: "‚Üí NHNN chi nh√°nh b·ªï sung h·ªì s∆°", nguoi: "NHNN chi nh√°nh", cho: "02 ng√†y" }
        ]
      },

      {
        title: "B∆∞·ªõc 3: Tr√¨nh l√£nh ƒë·∫°o Ph√≤ng ph∆∞∆°ng √°n x·ª≠ l√Ω", sub: [
          { noidung: "Tr√¨nh ph∆∞∆°ng √°n x·ª≠ l√Ω", nguoi: "C√¥ng ch·ª©c ph·ª• tr√°ch", xuly: "0,5 ng√†y" },
          {
            noidung: "L√£nh ƒë·∫°o Ph√≤ng xem x√©t", nguoi: "L√£nh ƒë·∫°o Ph√≤ng", xuly: "0,5 ng√†y",
            type: "decision3"
          },
          { noidung: "‚Üí C√¥ng ch·ª©c ch·ªânh s·ª≠a", nguoi: "C√¥ng ch·ª©c ph·ª• tr√°ch", xuly: "0,5 ng√†y" },
          { noidung: "‚Üí Tr√¨nh l·∫°i L√£nh ƒë·∫°o Ph√≤ng", nguoi: "L√£nh ƒë·∫°o Ph√≤ng", xuly: "0,5 ng√†y" }
        ]
      },

      {
        title: "B∆∞·ªõc 4: Tr√¨nh V·ª• tr∆∞·ªüng", sub: [
          { noidung: "Tr√¨nh ph∆∞∆°ng √°n x·ª≠ l√Ω", nguoi: "L√£nh ƒë·∫°o V·ª•", cho: "01 ng√†y" }
        ]
      },

      {
        title: "B∆∞·ªõc 5: Ph√°t h√†nh vƒÉn b·∫£n", sub: [
          { noidung: "Ph√°t h√†nh vƒÉn b·∫£n", nguoi: "VƒÉn th∆∞", cho: "0,5 ng√†y" }
        ]
      }
    ];

    function renderProcess() {
      let html = `<table>
    <thead><tr>
      <th>N·ªôi dung th·ª±c hi·ªán</th>
      <th>Ng∆∞·ªùi th·ª±c hi·ªán/Ph√™ duy·ªát</th>
      <th>Th·ªùi gian x·ª≠ l√Ω</th>
      <th>Th·ªùi gian ch·ªù</th>
      <th>Danh m·ª•c vƒÉn b·∫£n d·ª± th·∫£o</th>
      <th>K·∫øt qu·∫£</th>
      <th>Ng√†y ho√†n th√†nh</th>
      <th>Quy·∫øt ƒë·ªãnh</th>
    </tr></thead><tbody>`;

      processData.forEach((step, s) => {
        html += `<tr class="step-title"><td colspan="8">${step.title}</td></tr>`;
        step.sub.forEach((row, r) => {
          const id = `s${s}r${r}`;
          html += `<tr class="${(s === 0 && r === 0) ? '' : 'hidden'}" id="${id}">
        <td>${row.noidung}</td>
        <td>${row.nguoi || ""}</td>
        <td>${row.xuly || ""}</td>
        <td>${row.cho || ""}</td>
        <td>${row.vanban || ""}</td>
        <td>
          <textarea class="result-input" id="res-${id}" placeholder="Nh·∫≠p k·∫øt qu·∫£"></textarea>`;

          if (row.type === "decision2") {
            // Quy·∫øt ƒë·ªãnh lo·∫°i 2
            html += `
          <div id="decision-choices-${id}">
            <button class="btn btn-next" onclick="chooseDecision('${id}',${s},${r},true)">Ph√π h·ª£p</button>
            <button class="btn btn-next" onclick="chooseDecision('${id}',${s},${r},false)">Ch∆∞a ph√π h·ª£p</button>
          </div>
          <div id="decision-time-${id}" class="hidden">
            <button class="btn btn-next" onclick="decisionStepNow('${id}',${s},${r})">‚è±</button>
            <button class="btn btn-next" onclick="decisionStepManual('${id}',${s},${r})">üìÖ</button>
          </div>`;
          } else if (row.type === "decision3") {
            // Quy·∫øt ƒë·ªãnh lo·∫°i 3
            html += `
          <div id="decision-choices-${id}">
            <button class="btn btn-next" onclick="chooseDecision('${id}',${s},${r},true)">Th·ªëng nh·∫•t</button>
            <button class="btn btn-next" onclick="chooseDecision('${id}',${s},${r},false)">Ch∆∞a th·ªëng nh·∫•t</button>
          </div>
          <div id="decision-time-${id}" class="hidden">
            <button class="btn btn-next" onclick="decisionStepNow('${id}',${s},${r})">‚è±</button>
            <button class="btn btn-next" onclick="decisionStepManual('${id}',${s},${r})">üìÖ</button>
          </div>`;
          } else {
            // B∆∞·ªõc th∆∞·ªùng
            html += `
          <button class="btn btn-next" onclick="completeStepNow('${id}',${s},${r})">‚è±</button>
          <button class="btn btn-next" onclick="completeStepManual('${id}',${s},${r})">üìÖ</button>`;
          }

          html += `
          <button class="btn btn-edit hidden" id="btn-edit-${id}" 
            onclick="editStep('${id}',${s},${r},'${row.nguoi || ""}')">‚úèÔ∏è Ch·ªânh s·ª≠a</button>
        </td>
        <td>
  <div class="time-wrapper">
    <input type="datetime-local" id="time-${id}" class="time-input" onchange="applyManualTime('${id}')">
    <span id="time-text-${id}"></span>
    <span id="time-icon-${id}" class="time-icon hidden" onclick="openTimeInput('${id}')">üóì</span>
  </div>
</td>
        <td id="decision-${id}"></td>
      </tr>`;
        });
      });

      html += `</tbody></table>`;
      document.getElementById("processTable").innerHTML = html;
    }

    function chooseDecision(id, s, r, isPositive) {
      // L∆∞u l·ª±a ch·ªçn t·∫°m
      document.getElementById(`decision-${id}`).dataset.choice = isPositive ? "Ph√π h·ª£p" :
        (processData[s].sub[r].type === "decision3" ? "Th·ªëng nh·∫•t" : "Ch∆∞a ph√π h·ª£p");

      // ·∫®n 2 n√∫t ch·ªçn, hi·ªán 2 n√∫t th·ªùi gian
      document.getElementById(`decision-choices-${id}`).classList.add("hidden");
      document.getElementById(`decision-time-${id}`).classList.remove("hidden");
    }
    // === L·∫•y REF t·ª´ URL ===
    function getQueryParam(name) {
      const urlParams = new URLSearchParams(window.location.search);
      return urlParams.get(name);
    }



    // === Import t·ª´ Cloud theo REF (Flow ph·∫£i h·ªó tr·ª£ query REF) ===
    async function importFromCloudByRef(ref) {
      if (!window.tokenKey || window.tokenKey.trim() === "") {
        alert("‚ö†Ô∏è B·∫°n ph·∫£i import TOKEN_KEY tr∆∞·ªõc!");
        return;
      }

      try {
        // ‚ö° Endpoint Flow nh·∫≠n ref l√†m query
        const res = await fetch("https://default460cecfbf0c64dd7a5ec66ef4d75ae.63.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/835980df6c0a4b5892289dcbc334ef50/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=YJ4F3Gm_-Z5fPBUfteIeNr5YK-Kg_6C3OyKIvqXfj1M&ref=" + encodeURIComponent(ref), {
          method: "GET"
        });

        if (!res.ok) throw new Error("HTTP " + res.status);

        const encoded = (await res.text()).trim();

        const data = decodeData(encoded);
        if (!data) return;

        parseDecodedToTable(data);
        alert("‚úÖ ƒê√£ import d·ªØ li·ªáu cho REF: " + ref);
      } catch (err) {
        console.error(err);
        alert("‚ùå L·ªói khi import theo REF: " + err.message);
      }
    }
    function formatDate(d) {
      return d.toLocaleDateString("vi-VN", { day: "2-digit", month: "2-digit", year: "numeric" }) + " " +
        d.toLocaleTimeString("vi-VN", { hour: "2-digit", minute: "2-digit", second: "2-digit" });
    }
    function completeStep(id, s, r) {
      const choice = confirm("‚è± D√πng th·ªùi gian hi·ªán t·∫°i (OK) hay t·ª± nh·∫≠p (Cancel)?");
      if (choice) {
        const now = new Date();
        const last = getLastTimeBefore(s, r);
        if (last && now <= last) {
          alert("‚ùå Th·ªùi gian ph·∫£i l·ªõn h∆°n c√°c b∆∞·ªõc tr∆∞·ªõc!");
          return;
        }
        document.getElementById(`time-${id}`).value = now.toISOString().slice(0, 16);
        document.getElementById(`time-text-${id}`).textContent = formatDate(now);
        lockStep(id, s, r);
        showNext(id, s, r);
      } else {
        const icon = document.getElementById(`time-icon-${id}`);
        icon.classList.remove("hidden");
        document.getElementById(`time-text-${id}`).textContent = "‚è≥ Vui l√≤ng ch·ªçn th·ªùi gian...";
      }
    }
    function lockStep(id, s, r) {
      document.getElementById(`res-${id}`).readOnly = true;
      document.querySelectorAll(`#${id} .btn-next`).forEach(btn => btn.classList.add("hidden"));
      document.getElementById(`btn-edit-${id}`).classList.remove("hidden");
    }

    function showNext(id, s, r) {
      const nextRow = document.getElementById(`s${s}r${r + 1}`);
      if (nextRow) { nextRow.classList.remove("hidden"); updateSummary(); return; }
      const nextStep = document.getElementById(`s${s + 1}r0`);
      if (nextStep) nextStep.classList.remove("hidden");
      updateSummary();
    }
    function decisionStep(id, s, r, isPositive) {
      const choice = confirm("‚è± D√πng th·ªùi gian hi·ªán t·∫°i (OK) hay t·ª± nh·∫≠p (Cancel)?");
      if (choice) {
        const now = new Date();
        const last = getLastTimeBefore(s, r);
        if (last && now <= last) {
          alert("‚ùå Th·ªùi gian ph·∫£i l·ªõn h∆°n c√°c b∆∞·ªõc tr∆∞·ªõc!");
          return;
        }
        const inp = document.getElementById(`time-${id}`);
        inp.value = now.toISOString().slice(0, 16);
        document.getElementById(`time-text-${id}`).textContent = formatDate(now);
        document.getElementById(`time-icon-${id}`).classList.add("hidden");

        // m·ªü ti·∫øp
        if (isPositive) {
          const nextStep = document.getElementById(`s${s + 1}r0`);
          if (nextStep) nextStep.classList.remove("hidden");
        } else {
          const nextRow = document.getElementById(`s${s}r${r + 1}`);
          if (nextRow) nextRow.classList.remove("hidden");
        }
      } else {
        document.getElementById(`time-icon-${id}`).classList.remove("hidden");
        document.getElementById(`time-text-${id}`).textContent = "‚è≥ Vui l√≤ng ch·ªçn th·ªùi gian...";
      }

      document.getElementById(`res-${id}`).readOnly = true;
      document.getElementById(`btn-edit-${id}`).classList.remove("hidden");
      document.querySelectorAll(`#${id} .decision-btn`).forEach(btn => btn.classList.add("hidden"));

      let decisionText = "";
      if (processData[s].sub[r].type === "decision2") {
        decisionText = isPositive ? "Ph√π h·ª£p" : "Ch∆∞a ph√π h·ª£p";
      } else if (processData[s].sub[r].type === "decision3") {
        decisionText = isPositive ? "Th·ªëng nh·∫•t" : "Ch∆∞a th·ªëng nh·∫•t";
      }
      document.getElementById(`decision-${id}`).textContent = decisionText;

      updateSummary();
    }

    function editStep(id, s, r, nguoi) {
      if (!confirm("‚ö†Ô∏è S·ª≠a b∆∞·ªõc n√†y? C√°c b∆∞·ªõc sau s·∫Ω b·ªã x√≥a.")) return;

      const pass = prompt(`Nh·∫≠p passcode (t√™n ng∆∞·ªùi: ${nguoi})`);
      if (pass !== nguoi) {
        alert("‚ùå Sai passcode");
        return;
      }

      // reset to√†n b·ªô c√°c b∆∞·ªõc sau
      for (let i = s; i < processData.length; i++) {
        const rows = processData[i].sub;
        for (let j = (i === s ? r + 1 : 0); j < rows.length; j++) {
          const rid = `s${i}r${j}`;
          if (document.getElementById(rid)) {
            document.getElementById(rid).classList.add("hidden");
            document.getElementById(`res-${rid}`).value = "";
            document.getElementById(`time-text-${rid}`).textContent = "";
            document.getElementById(`decision-${rid}`).textContent = "";
            document.getElementById(`res-${rid}`).readOnly = false;

            // ‚úÖ Hi·ªán l·∫°i n√∫t ‚è± üìÖ cho b∆∞·ªõc sau
            document.querySelectorAll(`#${rid} .btn-next`).forEach(btn => btn.classList.remove("hidden"));
            document.querySelectorAll(`#${rid} .decision-btn`).forEach(btn => btn.classList.remove("hidden"));

            // ·∫©n icon & input ·ªü c√°c b∆∞·ªõc sau
            document.getElementById(`time-icon-${rid}`)?.classList.add("hidden");
            document.getElementById(`time-${rid}`).value = "";
          }
        }
      }

      // üëâ M·ªü l·∫°i b∆∞·ªõc hi·ªán t·∫°i ƒë·ªÉ nh·∫≠p
      document.getElementById(`res-${id}`).readOnly = false;

      // ‚úÖ Hi·ªán l·∫°i 2 n√∫t th·ªùi gian ho·∫∑c decision buttons
      document.querySelectorAll(`#${id} .btn-next`).forEach(btn => btn.classList.remove("hidden"));
      document.querySelectorAll(`#${id} .decision-btn`).forEach(btn => btn.classList.remove("hidden"));

      // ‚úÖ ·∫®n n√∫t ch·ªânh s·ª≠a
      document.getElementById(`btn-edit-${id}`).classList.add("hidden");

      // ‚úÖ ·∫®n input datetime-local, ch·ªâ show icon üóì
      const inp = document.getElementById(`time-${id}`);
      inp.value = "";
      inp.classList.add("time-input"); // v·∫´n ·∫©n nh∆∞ ban ƒë·∫ßu

      const icon = document.getElementById(`time-icon-${id}`);
      if (icon) icon.classList.remove("hidden");

      document.getElementById(`time-text-${id}`).textContent = "";
      document.getElementById(`decision-${id}`).textContent = "";

      updateSummary();
    }

    // ===== Parse dd/MM/yyyy HH:mm:ss =====
    function parseVNDate(str) {
      if (!str) return null;
      const [date, time] = str.split(" ");
      if (!date || !time) return null;
      const [d, m, y] = date.split("/").map(Number);
      const [hh, mm, ss] = time.split(":").map(Number);
      return new Date(y, m - 1, d, hh, mm, ss);
    }

    function fmt(sec) {
      const d = Math.floor(sec / 86400); sec %= 86400;
      const h = Math.floor(sec / 3600); sec %= 3600;
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${d} ng√†y ${h} gi·ªù ${m} ph√∫t ${s} gi√¢y`;
    }

    // ===== Summary =====
    function updateSummary() {
      const rows = [];
      processData.forEach((step, s) => {
        step.sub.forEach((row, r) => {
          const t = document.getElementById(`time-text-s${s}r${r}`)?.textContent;
          if (t) {
            const dt = parseVNDate(t);
            if (dt) rows.push({ nguoi: row.nguoi, time: dt });
          }
        });
      });
      if (rows.length < 2) return;

      const grouped = {};
      for (let i = 1; i < rows.length; i++) {
        const prev = rows[i - 1], curr = rows[i];
        const diff = (curr.time - prev.time) / 1000;
        if (!grouped[prev.nguoi]) grouped[prev.nguoi] = 0;
        grouped[prev.nguoi] += diff;
      }
      let total = 0; Object.values(grouped).forEach(v => total += v);

      let html = `<h2>‚è± Th·ªëng k√™ th·ªùi gian</h2>
              <table id="summaryTable">
                <tr><th>Ng∆∞·ªùi</th><th>T·ªïng TG</th></tr>`;
      for (const [nguoi, sec] of Object.entries(grouped)) {
        html += `<tr><td>${nguoi}</td><td>${fmt(sec)}</td></tr>`;
      }
      html += `<tr><th>T·ªïng quy tr√¨nh</th><th>${fmt(total)}</th></tr></table>`;
      document.getElementById("summary").innerHTML = html;
    }
    // ===== Export CSV (ch·ªâ export row ƒëang hi·ªÉn th·ªã) =====


    function openPicker(id) {
      const inp = document.getElementById(`time-${id}`);
      if (inp.showPicker) {
        inp.showPicker(); // Chrome h·ªó tr·ª£
      } else {
        inp.click();
      }
    }
    // L·∫•y th·ªùi gian cu·ªëi c√πng ƒë√£ c√≥ tr∆∞·ªõc b∆∞·ªõc hi·ªán t·∫°i
    function getLastTimeBefore(s, r) {
      for (let i = s; i >= 0; i--) {
        const rows = processData[i].sub;
        for (let j = (i === s ? r - 1 : rows.length - 1); j >= 0; j--) {
          const txt = document.getElementById(`time-text-s${i}r${j}`);
          if (txt && txt.textContent) {
            return parseVNDate(txt.textContent);
          }
        }
      }
      return null;
    }
    function applyManualTime(id) {
      const inp = document.getElementById(`time-${id}`);
      const txt = document.getElementById(`time-text-${id}`);

      if (inp.value) {
        const dt = new Date(inp.value);

        const match = id.match(/s(\d+)r(\d+)/);
        const s = parseInt(match[1]), r = parseInt(match[2]);
        const last = getLastTimeBefore(s, r);
        if (last && dt <= last) {
          alert("‚ùå Th·ªùi gian ph·∫£i l·ªõn h∆°n c√°c b∆∞·ªõc tr∆∞·ªõc!");
          inp.value = "";
          return;
        }

        txt.textContent = formatDate(dt);
        document.getElementById(`time-icon-${id}`).classList.add("hidden");

        const choice = document.getElementById(`decision-${id}`).dataset.choice;
        if (choice) {
          // L√† b∆∞·ªõc decision
          const isPositive = (choice === "Ph√π h·ª£p" || choice === "Th·ªëng nh·∫•t");
          finishDecision(id, s, r, isPositive);
        } else {
          // L√† b∆∞·ªõc th∆∞·ªùng
          document.querySelectorAll(`#${id} .btn-next`).forEach(btn => btn.classList.add("hidden"));
          document.getElementById(`res-${id}`).readOnly = true;
          document.getElementById(`btn-edit-${id}`).classList.remove("hidden");
          showNext(id, s, r);
          updateSummary();
        }
      } else {
        txt.textContent = "";
      }
    }

    function openTimeInput(id) {
      const inp = document.getElementById(`time-${id}`);
      if (inp.showPicker) {
        inp.showPicker();   // Chrome
      } else {
        inp.click();        // fallback
      }
    }
    function saveProcess(ref) {
      const data = {
        ref: ref,
        steps: [],
        summary: document.getElementById("summary").innerHTML
      };

      processData.forEach((step, s) => {
        step.sub.forEach((row, r) => {
          const id = `s${s}r${r}`;
          const res = document.getElementById(`res-${id}`).value;
          const time = document.getElementById(`time-text-${id}`).textContent;
          const decision = document.getElementById(`decision-${id}`).textContent;
          data.steps.push({
            step: step.title,
            noidung: row.noidung,
            nguoi: row.nguoi,
            xuly: row.xuly || "",
            cho: row.cho || "",
            res, time, decision
          });
        });
      });

      // l∆∞u localStorage
      let store = JSON.parse(localStorage.getItem("processStore") || "[]");
      store.push(data);
      localStorage.setItem("processStore", JSON.stringify(store));

      alert("‚úÖ ƒê√£ l∆∞u quy tr√¨nh v·ªõi REF: " + ref);
    }

    document.addEventListener("DOMContentLoaded", () => {
      const savedToken = sessionStorage.getItem("tokenKey");
      if (savedToken) {
        window.tokenKey = savedToken;
      }

      const mode = sessionStorage.getItem("mode");
      const dataStr = sessionStorage.getItem("selectedRow");

      if (mode === "new") {
        // üëâ New process ‚Üí b·∫£ng tr·ªëng, ch·ªâ show b∆∞·ªõc 1
        const first = document.getElementById("s0r0");
        if (first) first.classList.remove("hidden");
        sessionStorage.removeItem("mode"); // reset flag
        return;
      }

      if (dataStr) {
        const row = JSON.parse(dataStr);
        document.getElementById("refDisplay").textContent = "REF: " + row.ref;
        document.getElementById("deptName").textContent = "Ph√≤ng: " + row.dept;
        document.querySelector("h1").textContent = row.quytrinh;

        if (row.decoded) {
          parseDecodedToTable(row.decoded);
        }
      } else {
        const ref = getQueryParam("ref");
        if (ref) {
          document.getElementById("refDisplay").textContent = "REF: " + ref;
          importFromCloudByRef(ref);
        }
      }
    });

    // ================== TOKEN ==================
    // Bi·∫øn to√†n c·ª•c l∆∞u key
    window.tokenKey = "";

    // Import Token t·ª´ CSV ho·∫∑c TXT
    function importToken(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (evt) {
        const text = evt.target.result.trim();

        const lines = text.split(/\r?\n/);
        const header = lines[0].split(",");

        const idx = header.findIndex(h => h.toUpperCase().includes("TOKEN_KEY"));
        if (idx >= 0 && lines.length > 1) {
          // l·∫•y token t·ª´ d√≤ng 2
          const cols = lines[1].split(",");
          window.tokenKey = cols[idx].replace(/^"|"$/g, "").trim();
        } else {
          // file ch·ªâ ch·ª©a token d·∫°ng txt
          window.tokenKey = text.replace(/^"|"$/g, "").trim();
        }

        document.getElementById("currentToken").textContent = "üîë Token hi·ªán t·∫°i: " + window.tokenKey;
        alert("‚úÖ ƒê√£ n·∫°p TOKEN_KEY: " + window.tokenKey);
      };
      reader.readAsText(file, "utf-8");
    }

    // Encode d·ªØ li·ªáu (xu·∫•t)
    function encodeData(obj) {
      if (!window.tokenKey || window.tokenKey.trim() === "") {
        alert("‚ö†Ô∏è Ch∆∞a c√≥ TOKEN_KEY, vui l√≤ng import tr∆∞·ªõc");
        return null;
      }
      // B1: JSON ‚Üí base64
      const base64 = btoa(unescape(encodeURIComponent(JSON.stringify(obj))));

      // B2: k·∫øt h·ª£p TOKEN_KEY
      const combined = base64 + "::" + window.tokenKey.trim();

      // B3: encode l·∫°i to√†n b·ªô ƒë·ªÉ kh√¥ng l·ªói Latin1
      return btoa(unescape(encodeURIComponent(combined)));
    }

    // Decode d·ªØ li·ªáu (nh·∫≠p)
    function decodeData(encoded) {
      if (!window.tokenKey || window.tokenKey.trim() === "") {
        alert("‚ö†Ô∏è Ch∆∞a c√≥ TOKEN_KEY, vui l√≤ng import tr∆∞·ªõc");
        return null;
      }
      try {
        // B1: decode base64 ngo√†i
        const combined = decodeURIComponent(escape(atob(encoded)));

        // B2: t√°ch base64 + token
        const [base64, token] = combined.split("::");
        if (token.trim() !== window.tokenKey.trim()) {
          throw new Error("‚ùå TOKEN_KEY kh√¥ng kh·ªõp");
        }

        // B3: gi·∫£i JSON
        return JSON.parse(decodeURIComponent(escape(atob(base64))));
      } catch (e) {
        console.error(e);
        alert("‚ö†Ô∏è Gi·∫£i m√£ th·∫•t b·∫°i: " + e.message);
        return null;
      }
    }

    // ================== EXPORT ==================
    function exportRawJson() {
      // Thu th·∫≠p to√†n b·ªô step/sub (k·ªÉ c·∫£ hidden)
      const rows = [];
      processData.forEach((step, s) => {
        step.sub.forEach((row, r) => {
          const rowId = `s${s}r${r}`;
          rows.push({
            step: step.title,
            noidung: row.noidung,
            nguoi: row.nguoi || "",
            xuly: row.xuly || "",
            cho: row.cho || "",
            res: document.getElementById(`res-${rowId}`).value || "",
            time: document.getElementById(`time-text-${rowId}`).textContent || "",
            decision: document.getElementById(`decision-${rowId}`).textContent || ""
          });
        });
      });

      // T·∫°o ref d·∫°ng BB_ddMMyyyy_hhmmss
      const now = new Date();
      const pad = n => n.toString().padStart(2, "0");
      const ref = `TCCB1.018.1_${pad(now.getDate())}${pad(now.getMonth() + 1)}${now.getFullYear()}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;

      // G√≥i JSON {ref, rows}
      const output = { ref: ref, rows: rows };

      // Xu·∫•t file JSON
      const blob = new Blob([JSON.stringify(output, null, 2)], { type: "application/json" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = ref + ".json";
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }


    // ================== IMPORT ENCODED ==================
    function importEncoded(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function (evt) {
        const encoded = evt.target.result.trim();
        const data = decodeData(encoded);
        if (!data) return;
        parseDecodedToTable(data);
      };
      reader.readAsText(file, "utf-8");
    }

    // ================== APPLY DECODED DATA ==================
    function parseDecodedToTable(rows) {
      let lastVisibleId = null;

      rows.forEach(row => {
        processData.forEach((st, s) => {
          st.sub.forEach((sub, r) => {
            if (sub.noidung === row.noidung && sub.nguoi === row.nguoi) {
              // ch·ªâ m·ªü n·∫øu row c√≥ data
              if (row.res || row.time || row.decision) {
                const rowId = `s${s}r${r}`;
                const rowEl = document.getElementById(rowId);
                if (!rowEl) return;

                rowEl.classList.remove("hidden");
                document.getElementById(`res-${rowId}`).value = row.res || "";
                document.getElementById(`time-text-${rowId}`).textContent = row.time || "";
                document.getElementById(`decision-${rowId}`).textContent = row.decision || "";

                // lock n·∫øu c√≥ data
                document.getElementById(`res-${rowId}`).readOnly = true;
                document.getElementById(`btn-next-${rowId}`)?.classList.add("hidden");
                document.getElementById(`btn-edit-${rowId}`)?.classList.remove("hidden");
                document.querySelectorAll(`#${rowId} .decision-btn`).forEach(btn => btn.classList.add("hidden"));

                lastVisibleId = rowId; // l∆∞u row cu·ªëi c√≥ data
              }
            }
          });
        });
      });

      // üëâ m·ªü th√™m ƒë√∫ng 1 d√≤ng k·∫ø ti·∫øp
      if (lastVisibleId) {
        const match = lastVisibleId.match(/s(\d+)r(\d+)/);
        if (match) {
          const s = parseInt(match[1]);
          const r = parseInt(match[2]);

          const nextRow = document.getElementById(`s${s}r${r + 1}`);
          if (nextRow) {
            nextRow.classList.remove("hidden");
          } else {
            const nextStepRow = document.getElementById(`s${s + 1}r0`);
            if (nextStepRow) nextStepRow.classList.remove("hidden");
          }
        }
      } else {
        // n·∫øu ch∆∞a c√≥ data th√¨ ch·ªâ m·ªü b∆∞·ªõc 1 d√≤ng 0
        const first = document.getElementById("s0r0");
        if (first) first.classList.remove("hidden");
      }

      updateSummary();
    }
    //Send to SharePoint via Power Automate
    // ================== EXPORT CLOUD ==================
    function sendToSharePoint() {
      if (!window.tokenKey) {
        alert("‚ö†Ô∏è B·∫°n ph·∫£i import TOKEN_KEY tr∆∞·ªõc khi g·ª≠i!");
        return;
      }

      // Thu th·∫≠p d·ªØ li·ªáu step/sub
      const rows = [];
      processData.forEach((step, s) => {
        step.sub.forEach((row, r) => {
          const rowId = `s${s}r${r}`;
          rows.push({
            step: step.title,
            noidung: row.noidung,
            nguoi: row.nguoi || "",
            xuly: row.xuly || "",
            cho: row.cho || "",
            res: document.getElementById(`res-${rowId}`).value || "",
            time: document.getElementById(`time-text-${rowId}`).textContent || "",
            decision: document.getElementById(`decision-${rowId}`).textContent || ""
          });
        });
      });

      // üîé Ki·ªÉm tra c√≥ ref c≈© kh√¥ng
      let ref = null;
      const selectedRow = sessionStorage.getItem("selectedRow");
      if (selectedRow) {
        const parsed = JSON.parse(selectedRow);
        if (parsed.ref) ref = parsed.ref; // gi·ªØ nguy√™n ref c≈© khi edit
      }

      // N·∫øu kh√¥ng c√≥ (new) ‚Üí sinh ref m·ªõi
      if (!ref) {
        const now = new Date();
        const pad = n => n.toString().padStart(2, "0");
        ref = `TCCB1.018.1_${pad(now.getDate())}${pad(now.getMonth() + 1)}${now.getFullYear()}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
      }

      // üëâ L·∫•y DEPT + QUYTRINH t·ª´ giao di·ªán
      const dept = document.getElementById("deptName")?.textContent.replace("Ph√≤ng: ", "").trim() || "";
      const quytrinh = document.querySelector("h1")?.textContent.trim() || "";

      const encoded = encodeData(rows);
      if (!encoded) return;

      const payload = {
        ref,
        data: encoded,
        DEPT: dept,
        QUYTRINH: quytrinh
      };

      // ‚ö° POST sang Flow
      const flowUrl = "https://default460cecfbf0c64dd7a5ec66ef4d75ae.63.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/16754f7e54a04f2e9b8fb60caaaf33b4/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=aXhGTYEd9zepjAkPLtbU1nJvzosQwgmJlylq7riqiwA "; // endpoint flow c·ªßa b·∫°n
      fetch(flowUrl, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload)
      })
        .then(res => {
          if (res.ok) {
            alert("‚úÖ ƒê√£ save d·ªØ li·ªáu!");
            window.close();   // üî¥ T·∫Øt tab ngay sau khi g·ª≠i th√†nh c√¥ng
          } else {
            alert("‚ùå L·ªói khi g·ª≠i: " + res.status);
          }
        });
    }
    //Import t·ª´ Cloud (g·ªçi flow kh√°c)
    async function importFromCloud() {
      if (!window.tokenKey || window.tokenKey.trim() === "") {
        alert("‚ö†Ô∏è B·∫°n ph·∫£i import TOKEN_KEY tr∆∞·ªõc!");
        return;
      }

      try {
        // G·ªçi t·ªõi Flow Power Automate (flow tr·∫£ v·ªÅ 1 string encoded nh∆∞ file txt local)
        const res = await fetch("https://default460cecfbf0c64dd7a5ec66ef4d75ae.63.environment.api.powerplatform.com:443/powerautomate/automations/direct/workflows/835980df6c0a4b5892289dcbc334ef50/triggers/manual/paths/invoke?api-version=1&sp=%2Ftriggers%2Fmanual%2Frun&sv=1.0&sig=YJ4F3Gm_-Z5fPBUfteIeNr5YK-Kg_6C3OyKIvqXfj1M", { method: "GET" });
        if (!res.ok) throw new Error("HTTP " + res.status);

        const encoded = (await res.text()).trim();

        // d√πng l·∫°i decodeData + parseDecodedToTable nh∆∞ importEncoded()
        const data = decodeData(encoded);
        if (!data) return;

        parseDecodedToTable(data);
        alert("‚úÖ ƒê√£ import d·ªØ li·ªáu t·ª´ Cloud");
      } catch (err) {
        console.error(err);
        alert("‚ùå L·ªói khi import t·ª´ Cloud: " + err.message);
      }
    }
    renderProcess();
    function completeStepNow(id, s, r) {
      const now = new Date();
      const last = getLastTimeBefore(s, r);
      if (last && now <= last) {
        alert("‚ùå Th·ªùi gian ph·∫£i l·ªõn h∆°n c√°c b∆∞·ªõc tr∆∞·ªõc!");
        return;
      }
      document.getElementById(`time-${id}`).value = now.toISOString().slice(0, 16);
      document.getElementById(`time-text-${id}`).textContent = formatDate(now);
      lockStep(id, s, r);
      showNext(id, s, r);
    }

    function completeStepManual(id, s, r) {
      const inp = document.getElementById(`time-${id}`);
      if (inp.showPicker) {
        inp.showPicker();  // b·∫≠t l·ªãch ch·ªçn
      } else {
        inp.click();       // fallback cho browser kh√°c
      }
    }

    function decisionStepNow(id, s, r) {
      const isPositive = document.getElementById(`decision-${id}`).dataset.choice === "Ph√π h·ª£p"
        || document.getElementById(`decision-${id}`).dataset.choice === "Th·ªëng nh·∫•t";

      const now = new Date();
      const last = getLastTimeBefore(s, r);
      if (last && now <= last) {
        alert("‚ùå Th·ªùi gian ph·∫£i l·ªõn h∆°n c√°c b∆∞·ªõc tr∆∞·ªõc!");
        return;
      }

      const inp = document.getElementById(`time-${id}`);
      inp.value = now.toISOString().slice(0, 16);
      document.getElementById(`time-text-${id}`).textContent = formatDate(now);

      finishDecision(id, s, r, isPositive);
    }
    function finishDecision(id, s, r, isPositive) {
      // ·∫®n 2 n√∫t th·ªùi gian
      document.getElementById(`decision-time-${id}`).classList.add("hidden");

      // Ghi text quy·∫øt ƒë·ªãnh
      const choice = document.getElementById(`decision-${id}`).dataset.choice;
      document.getElementById(`decision-${id}`).textContent = choice || (isPositive ? "Ph√π h·ª£p" : "Ch∆∞a ph√π h·ª£p");

      // Lock step
      document.getElementById(`res-${id}`).readOnly = true;
      document.getElementById(`btn-edit-${id}`).classList.remove("hidden");

      // M·ªü b∆∞·ªõc ti·∫øp
      if (isPositive) {
        const nextStep = document.getElementById(`s${s + 1}r0`);
        if (nextStep) nextStep.classList.remove("hidden");
      } else {
        const nextRow = document.getElementById(`s${s}r${r + 1}`);
        if (nextRow) nextRow.classList.remove("hidden");
      }

      updateSummary();
    }
    function decisionStepManual(id, s, r, isPositive) {
      const inp = document.getElementById(`time-${id}`);
      inp.dataset.decision = isPositive;
      if (inp.showPicker) {
        inp.showPicker();
      } else {
        inp.click();
      }
    }

  </script>
</body>

</html>